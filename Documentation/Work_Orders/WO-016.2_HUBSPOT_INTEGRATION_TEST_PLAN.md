# WO-016.2: HubSpot CRM Integration Test Plan

**Document Version:** 1.0
**Created:** 2025-11-18
**Purpose:** Comprehensive test plan for local Claude (Windsurf IDE) to verify HubSpot sync implementation
**Environment:** Docker Compose + Supabase MCP
**Scope:** Phase 1 (Core Service) testing - Phase 2 (Scheduler) will be added after implementation

---

## Prerequisites Checklist

Before starting tests, verify:

- [ ] Docker Desktop running
- [ ] Windsurf IDE with Claude and MCP Supabase server configured
- [ ] `.env` file configured with Supabase credentials
- [ ] HubSpot account created (free tier sufficient)
- [ ] HubSpot private app created with contact permissions
- [ ] HubSpot API token obtained (starts with `pat-na1-` or `pat-eu1-`)
- [ ] Custom properties created in HubSpot (3 properties required)
- [ ] MCP Supabase connection tested (`SELECT 1`)

---

## Part 1: HubSpot Account Setup

### 1.1 Create HubSpot Account

1. Go to https://www.hubspot.com/
2. Click "Get started free"
3. Create account with email address
4. Complete onboarding (skip CRM import for now)
5. Verify email and log into dashboard

**Free Tier Limits:**
- 1,000,000 contacts
- Unlimited users
- 100 requests per 10 seconds (API rate limit)
- ‚úÖ Sufficient for testing

### 1.2 Create Private App for API Access

**Steps:**

1. **Navigate to Private Apps**
   - Log into HubSpot: https://app.hubspot.com/
   - Click Settings (gear icon, top-right)
   - Left sidebar: Integrations ‚Üí Private Apps
   - Click "Create a private app"

2. **Configure App Details**
   - App name: `ScraperSky Contact Sync`
   - Description: `Automated contact synchronization from ScraperSky platform`
   - Logo: (optional - skip for testing)
   - Click "Next"

3. **Configure Scopes (Permissions)**
   - Click "Scopes" tab
   - Enable the following scopes:
     - ‚òëÔ∏è `crm.objects.contacts.read` - Read contact data (for search)
     - ‚òëÔ∏è `crm.objects.contacts.write` - Create/update contacts
     - ‚òëÔ∏è `crm.schemas.contacts.read` - Read custom properties (optional)
   - Click "Create app"

4. **Get Access Token**
   - **IMPORTANT:** The token is shown only once!
   - Copy the access token (starts with `pat-na1-` or `pat-eu1-`)
   - Save it securely (you'll add to `.env` in next step)
   - Token format example: `pat-na1-xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx`

**Screenshot locations for verification:**
- Settings ‚Üí Integrations ‚Üí Private Apps ‚Üí "ScraperSky Contact Sync"
- Status should show: "Active"

### 1.3 Create Custom Properties

HubSpot requires custom properties to be created before use.

**Method A: Via HubSpot UI (Recommended)**

1. **Navigate to Properties**
   - Settings ‚Üí Data Management ‚Üí Properties
   - Click "Contact properties" tab
   - Click "Create property" button

2. **Create Property 1: ScraperSky Domain ID**
   - Object type: Contact
   - Group: Contact information
   - Label: `ScraperSky Domain ID`
   - Internal name: `scrapersky_domain_id`
   - Field type: Single-line text
   - Description: `UUID of source domain in ScraperSky`
   - Click "Create"

3. **Create Property 2: ScraperSky Page ID**
   - Object type: Contact
   - Group: Contact information
   - Label: `ScraperSky Page ID`
   - Internal name: `scrapersky_page_id`
   - Field type: Single-line text
   - Description: `UUID of source page in ScraperSky`
   - Click "Create"

4. **Create Property 3: ScraperSky Sync Date**
   - Object type: Contact
   - Group: Contact information
   - Label: `ScraperSky Sync Date`
   - Internal name: `scrapersky_sync_date`
   - Field type: Date picker
   - Description: `Last sync timestamp from ScraperSky`
   - Click "Create"

**Method B: Via API (Advanced)**

```bash
# Create Domain ID property
curl -X POST \
  https://api.hubapi.com/crm/v3/properties/contacts \
  -H "Authorization: Bearer pat-na1-YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "scrapersky_domain_id",
    "label": "ScraperSky Domain ID",
    "type": "string",
    "fieldType": "text",
    "groupName": "contactinformation"
  }'

# Create Page ID property
curl -X POST \
  https://api.hubapi.com/crm/v3/properties/contacts \
  -H "Authorization: Bearer pat-na1-YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "scrapersky_page_id",
    "label": "ScraperSky Page ID",
    "type": "string",
    "fieldType": "text",
    "groupName": "contactinformation"
  }'

# Create Sync Date property
curl -X POST \
  https://api.hubapi.com/crm/v3/properties/contacts \
  -H "Authorization: Bearer pat-na1-YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "scrapersky_sync_date",
    "label": "ScraperSky Sync Date",
    "type": "string",
    "fieldType": "text",
    "groupName": "contactinformation"
  }'
```

**Verification:**
- Go to Settings ‚Üí Properties ‚Üí Contact properties
- Search for "ScraperSky"
- You should see 3 properties: Domain ID, Page ID, Sync Date

---

## Part 2: Environment Setup

### 2.1 Configure HubSpot in `.env`

Add the following to your `.env` file:

```bash
# --- HubSpot CRM Integration (WO-016) ---
HUBSPOT_API_KEY=pat-na1-xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
HUBSPOT_PORTAL_ID=  # Optional - leave empty for single account
HUBSPOT_API_BASE_URL=https://api.hubapi.com

# HubSpot Sync Scheduler Settings (WO-016 Phase 2) - FOR TESTING
HUBSPOT_SYNC_SCHEDULER_INTERVAL_MINUTES=2  # Shortened to 2 min for testing
HUBSPOT_SYNC_SCHEDULER_BATCH_SIZE=5        # Smaller batch for testing
HUBSPOT_SYNC_SCHEDULER_MAX_INSTANCES=1

# HubSpot Retry Logic Settings (WO-016 Phase 2) - FOR TESTING
HUBSPOT_SYNC_MAX_RETRIES=3
HUBSPOT_SYNC_RETRY_DELAY_MINUTES=1         # Shortened to 1 min for testing
HUBSPOT_SYNC_RETRY_EXPONENTIAL=true

# HubSpot Custom Property Names (must match properties created in HubSpot)
HUBSPOT_CUSTOM_PROPERTY_DOMAIN_ID=scrapersky_domain_id
HUBSPOT_CUSTOM_PROPERTY_PAGE_ID=scrapersky_page_id
HUBSPOT_CUSTOM_PROPERTY_SYNC_DATE=scrapersky_sync_date
```

**‚ö†Ô∏è Important:** Replace `pat-na1-xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx` with your real HubSpot access token.

**Testing Configuration Notes:**
- Scheduler interval: **2 minutes** (production: 5 min) for faster testing
- Batch size: **5 contacts** (production: 10) for easier verification
- Retry delay: **1 minute** (production: 5 min) for quicker retry testing

### 2.2 Start Docker Compose Stack

```bash
cd /home/user/scrapersky-backend
docker compose down  # Clean shutdown
docker compose up --build
```

**Expected Output:**
```
‚úÖ Look for these log lines (indicates successful startup):

[INFO] Starting up the ScraperSky API - Lifespan Start
[INFO] Adding jobs to the shared scheduler...
[INFO] Finished adding jobs to shared scheduler.
```

**Note:** Phase 1 (Core Service) does NOT include scheduler, so you won't see HubSpot scheduler registration yet. That will come in Phase 2.

### 2.3 Verify Application Started

```bash
curl http://localhost:8008/health
```

**Expected:** `{"status":"ok"}`

---

## Part 3: Database Preparation (MCP Supabase)

### 3.1 Create Test Contacts

Use MCP Supabase to insert test contacts:

```sql
-- Insert 3 test contacts with different scenarios
INSERT INTO contacts (
    id,
    email,
    name,
    phone_number,
    domain_id,
    page_id,
    hubspot_sync_status,
    hubspot_processing_status,
    hubspot_processing_error,
    hubspot_contact_id,
    retry_count,
    next_retry_at,
    created_at,
    updated_at
) VALUES
-- Test Contact 1: Fresh contact, never synced
(
    gen_random_uuid(),
    'hubspot-test-fresh@scrapersky-test.com',
    'Fresh HubSpot Test',
    '+1-555-1001',
    NULL,
    NULL,
    'Queued',      -- User queued for sync
    'Queued',      -- System ready to process
    NULL,
    NULL,
    0,
    NULL,
    NOW(),
    NOW()
),
-- Test Contact 2: Contact with domain/page metadata
(
    gen_random_uuid(),
    'hubspot-test-metadata@scrapersky-test.com',
    'HubSpot Metadata Test',
    '+1-555-2002',
    (SELECT id FROM domains LIMIT 1),  -- Links to real domain (if exists)
    (SELECT id FROM pages LIMIT 1),    -- Links to real page (if exists)
    'Queued',
    'Queued',
    NULL,
    NULL,
    0,
    NULL,
    NOW(),
    NOW()
),
-- Test Contact 3: Simple email only (for scheduler test later)
(
    gen_random_uuid(),
    'hubspot-test-simple@scrapersky-test.com',
    NULL,  -- No name
    NULL,  -- No phone
    NULL,
    NULL,
    'Queued',
    'Queued',
    NULL,
    NULL,
    0,
    NULL,
    NOW(),
    NOW()
);
```

### 3.2 Verify Test Contacts Created

```sql
SELECT
    id,
    email,
    name,
    hubspot_sync_status,
    hubspot_processing_status,
    retry_count,
    created_at
FROM contacts
WHERE email LIKE '%@scrapersky-test.com'
ORDER BY created_at DESC
LIMIT 10;
```

**Expected:** 3 rows returned with `hubspot_sync_status = 'Queued'` and `hubspot_processing_status = 'Queued'`

### 3.3 Save Contact IDs for Testing

Copy the UUIDs from the query above. You'll need them for manual testing.

```bash
# Example (replace with your actual UUIDs):
CONTACT_1_ID=12345678-1234-1234-1234-123456789abc
CONTACT_2_ID=23456789-2345-2345-2345-234567890abc
CONTACT_3_ID=34567890-3456-3456-3456-345678901abc
```

---

## Part 4: Manual Sync Test (Phase 1 Verification)

This verifies the core service works correctly.

### 4.1 Test Contact 1 (Fresh Contact)

```bash
python test_manual_hubspot_sync.py $CONTACT_1_ID
```

**Expected Output:**
```
üß™ Starting manual sync test for contact: 12345678-1234-1234-1234-123456789abc
üì° HubSpot API Base URL: https://api.hubapi.com
üîë API Key configured: pat-na1-xxxxxxx...
üöÄ Starting HubSpot sync for contact 12345678-1234-1234-1234-123456789abc
üìß Syncing hubspot-test-fresh@scrapersky-test.com to HubSpot
üìã Found existing HubSpot contact: 12345678901 (OR)
‚úÖ Created new HubSpot contact 12345678901
‚úÖ HubSpot sync complete for hubspot-test-fresh@scrapersky-test.com (HubSpot ID: 12345678901)
‚úÖ MANUAL SYNC COMPLETED SUCCESSFULLY!
```

### 4.2 Verify Contact 1 in Database (MCP Supabase)

```sql
SELECT
    email,
    name,
    hubspot_sync_status,
    hubspot_processing_status,
    hubspot_processing_error,
    hubspot_contact_id,
    retry_count,
    updated_at
FROM contacts
WHERE email = 'hubspot-test-fresh@scrapersky-test.com';
```

**Expected Results:**
| email | hubspot_sync_status | hubspot_processing_status | hubspot_processing_error | hubspot_contact_id | retry_count |
|-------|---------------------|---------------------------|--------------------------|---------------------|-------------|
| hubspot-test-fresh@... | Complete | Complete | NULL | 12345678901 | 0 |

### 4.3 Test Contact 2 (With Metadata)

```bash
# Wait 5 seconds between tests
sleep 5

python test_manual_hubspot_sync.py $CONTACT_2_ID
```

**Expected:** Similar output to Contact 1, with different HubSpot ID

### 4.4 Verify Contact 2 in Database

```sql
SELECT
    email,
    name,
    hubspot_sync_status,
    hubspot_processing_status,
    hubspot_contact_id
FROM contacts
WHERE email = 'hubspot-test-metadata@scrapersky-test.com';
```

**Expected:** `hubspot_sync_status = 'Complete'` and numeric `hubspot_contact_id`

**‚úÖ Phase 1 (Core Service) PASSED** if both contacts show `Complete` status.

---

## Part 5: HubSpot Dashboard Verification

Verify contacts were actually created in HubSpot.

### 5.1 Access HubSpot Contacts Dashboard

1. Go to: https://app.hubspot.com/
2. Navigate to: **Contacts** ‚Üí **Contacts** (left sidebar)

### 5.2 Search for Test Contacts

In the search box, search for: `@scrapersky-test.com`

**Expected Results:**

You should see **2 contacts** (Contact 1 and Contact 2):

| Email | First Name | Last Name | Phone | ScraperSky Custom Properties |
|-------|------------|-----------|-------|------------------------------|
| hubspot-test-fresh@... | Fresh | HubSpot Test | +1-555-1001 | (if domain/page exist) |
| hubspot-test-metadata@... | HubSpot | Metadata Test | +1-555-2002 | Domain ID, Page ID, Sync Date |

### 5.3 Verify Custom Properties

Click on **hubspot-test-metadata@scrapersky-test.com** to view details.

**In the contact record, look for:**
- **About this contact** section
- Scroll down to find custom properties
- ‚úÖ `ScraperSky Domain ID`: UUID value (if domain linked)
- ‚úÖ `ScraperSky Page ID`: UUID value (if page linked)
- ‚úÖ `ScraperSky Sync Date`: ISO timestamp

**Screenshot Verification:**
- Custom properties should be visible in contact details
- Values should match database UUIDs

### 5.4 Test Update (Idempotency)

Run sync again for Contact 1:

```bash
python test_manual_hubspot_sync.py $CONTACT_1_ID
```

**Expected Log:**
```
üìã Found existing HubSpot contact: 12345678901
‚úÖ Updated HubSpot contact 12345678901
```

**In HubSpot Dashboard:**
- Same contact ID (no duplicate created)
- "Last modified date" should update to recent timestamp

**‚úÖ HubSpot Dashboard PASSED** if contacts visible with correct data and updates work.

---

## Part 6: Error Handling Tests

### 6.1 Test Invalid Email Format

Create contact with invalid email:

```sql
INSERT INTO contacts (
    id,
    email,
    name,
    hubspot_sync_status,
    hubspot_processing_status,
    retry_count,
    created_at,
    updated_at
) VALUES (
    gen_random_uuid(),
    'invalid-email-no-at-symbol',  -- Invalid: no @ symbol
    'Test Invalid Email',
    'Queued',
    'Queued',
    0,
    NOW(),
    NOW()
)
RETURNING id, email;
```

**Save the returned UUID as `INVALID_CONTACT_ID`**

**Attempt sync:**
```bash
python test_manual_hubspot_sync.py $INVALID_CONTACT_ID
```

**Expected:**
```
‚ùå HubSpot sync failed for invalid-email-no-at-symbol: ...
üîÑ Retry 1/3 scheduled in 1 minutes
‚ùå MANUAL SYNC FAILED: ...
```

**Database verification:**
```sql
SELECT
    email,
    hubspot_sync_status,
    hubspot_processing_status,
    hubspot_processing_error,
    retry_count,
    next_retry_at
FROM contacts
WHERE email = 'invalid-email-no-at-symbol';
```

**Expected:**
| hubspot_sync_status | hubspot_processing_status | retry_count | next_retry_at |
|---------------------|---------------------------|-------------|---------------|
| Queued | Error | 1 | NOW() + 1 minute |

### 6.2 Test Invalid API Token

**Temporarily break API token in `.env`:**

```bash
HUBSPOT_API_KEY=pat-na1-INVALID_TOKEN_FOR_TESTING
```

**Restart Docker:**
```bash
docker compose down
docker compose up --build
```

**Create test contact:**
```sql
INSERT INTO contacts (email, name, hubspot_sync_status, hubspot_processing_status, created_at, updated_at)
VALUES ('test-invalid-token@scrapersky-test.com', 'Invalid Token Test', 'Queued', 'Queued', NOW(), NOW())
RETURNING id;
```

**Attempt sync:**
```bash
python test_manual_hubspot_sync.py <contact_id_from_above>
```

**Expected:**
```
‚ùå HubSpot search failed (HTTP 401): ...
üîÑ Retry 1/3 scheduled in 1 minutes
```

**Database verification:**
```sql
SELECT
    email,
    hubspot_processing_error
FROM contacts
WHERE email = 'test-invalid-token@scrapersky-test.com';
```

**Expected:** `hubspot_processing_error` contains "401" or "Unauthorized"

**Restore valid API token:**
```bash
HUBSPOT_API_KEY=pat-na1-YOUR_REAL_TOKEN
```

**Restart Docker:**
```bash
docker compose down
docker compose up --build
```

**‚úÖ Error Handling PASSED** if invalid data triggers retry logic correctly.

---

## Part 7: Cleanup

### 7.1 Delete Test Contacts from Database

```sql
-- Delete test contacts from ScraperSky database
DELETE FROM contacts
WHERE email LIKE '%@scrapersky-test.com'
OR email = 'invalid-email-no-at-symbol'
OR email = 'test-invalid-token@scrapersky-test.com';
```

### 7.2 Delete Test Contacts from HubSpot

**Option A: Via HubSpot Dashboard**
1. Go to Contacts ‚Üí Contacts
2. Search: `@scrapersky-test.com`
3. Select all contacts
4. Click "Delete" (top-right menu)
5. Confirm deletion

**Option B: Via API (Bulk Delete)**
```bash
# Get contact ID from email
CONTACT_ID=$(curl -X POST \
  https://api.hubapi.com/crm/v3/objects/contacts/search \
  -H "Authorization: Bearer pat-na1-YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"filterGroups":[{"filters":[{"propertyName":"email","operator":"EQ","value":"hubspot-test-fresh@scrapersky-test.com"}]}]}' \
  | jq -r '.results[0].id')

# Delete contact
curl -X DELETE \
  https://api.hubapi.com/crm/v3/objects/contacts/$CONTACT_ID \
  -H "Authorization: Bearer pat-na1-YOUR_TOKEN"
```

**Repeat for each test contact email.**

### 7.3 Restore Production Configuration

Edit `.env` back to production values:

```bash
HUBSPOT_SYNC_SCHEDULER_INTERVAL_MINUTES=5  # Back to 5 min
HUBSPOT_SYNC_SCHEDULER_BATCH_SIZE=10       # Back to 10
HUBSPOT_SYNC_RETRY_DELAY_MINUTES=5         # Back to 5 min
```

Restart:

```bash
docker compose down
docker compose up --build
```

---

## Part 8: Test Report Template

Fill out this template after completing all tests:

```markdown
# WO-016 Phase 1 Integration Test Report

**Tester:** [Your Name]
**Date:** [YYYY-MM-DD]
**Environment:** Docker Compose (Local)
**HubSpot Account:** [Your HubSpot email]

## Test Results Summary

| Test Category | Status | Notes |
|---------------|--------|-------|
| HubSpot Account Setup | ‚¨ú PASS / ‚¨ú FAIL | |
| Custom Properties Creation | ‚¨ú PASS / ‚¨ú FAIL | |
| Environment Setup | ‚¨ú PASS / ‚¨ú FAIL | |
| Database Preparation | ‚¨ú PASS / ‚¨ú FAIL | |
| Manual Sync (Phase 1) | ‚¨ú PASS / ‚¨ú FAIL | |
| HubSpot Dashboard Verification | ‚¨ú PASS / ‚¨ú FAIL | |
| Error Handling | ‚¨ú PASS / ‚¨ú FAIL | |

## Detailed Results

### Part 4: Manual Sync Test
- Contact 1 (Fresh): ‚¨ú PASS / ‚¨ú FAIL
  - HubSpot ID: ___________
  - Error (if any):
- Contact 2 (Metadata): ‚¨ú PASS / ‚¨ú FAIL
  - HubSpot ID: ___________
  - Error (if any):

### Part 5: HubSpot Dashboard
- Contacts visible in dashboard: ‚¨ú PASS / ‚¨ú FAIL
- Custom properties correct: ‚¨ú PASS / ‚¨ú FAIL
- Update test (idempotency): ‚¨ú PASS / ‚¨ú FAIL

### Part 6: Error Handling
- Invalid email format: ‚¨ú PASS / ‚¨ú FAIL
- Invalid API token (401): ‚¨ú PASS / ‚¨ú FAIL
- Retry logic triggered: ‚¨ú PASS / ‚¨ú FAIL

## Issues Encountered

[Describe any issues, errors, or unexpected behavior]

## Overall Assessment

‚¨ú **READY FOR PHASE 2** - All tests passed
‚¨ú **NEEDS FIXES** - Some tests failed (see details above)
‚¨ú **BLOCKED** - Cannot complete testing (explain why)

## Recommendations

[Any suggestions for improvements or concerns]

---

**Signature:** ___________________
**Date:** ___________________
```

---

## Expected Overall Timeline (Phase 1 Only)

| Phase | Duration | Description |
|-------|----------|-------------|
| Part 1: HubSpot Setup | 15-20 min | Create account, private app, custom properties |
| Part 2: Environment Setup | 10-15 min | Configure .env, start Docker |
| Part 3: Database Prep | 5 min | Create test contacts |
| Part 4: Manual Sync | 10 min | Test core service |
| Part 5: Dashboard Verification | 10 min | Verify in HubSpot UI |
| Part 6: Error Handling | 15 min | Test invalid scenarios |
| Part 7: Cleanup | 5 min | Delete test data |
| **TOTAL** | **70-80 min** | Phase 1 comprehensive test |

---

## Quick Reference: Common MCP Queries

```sql
-- View all queued contacts ready for HubSpot sync
SELECT id, email, name, hubspot_sync_status, hubspot_processing_status, next_retry_at
FROM contacts
WHERE hubspot_processing_status = 'Queued'
AND (next_retry_at IS NULL OR next_retry_at <= NOW())
ORDER BY updated_at ASC
LIMIT 10;

-- View recent HubSpot sync activity (last 24 hours)
SELECT
    email,
    hubspot_sync_status,
    hubspot_processing_status,
    retry_count,
    updated_at
FROM contacts
WHERE updated_at > NOW() - INTERVAL '24 hours'
AND hubspot_sync_status IS NOT NULL
ORDER BY updated_at DESC
LIMIT 20;

-- Count contacts by HubSpot status
SELECT
    hubspot_sync_status,
    hubspot_processing_status,
    COUNT(*) as count
FROM contacts
WHERE hubspot_sync_status IS NOT NULL
GROUP BY hubspot_sync_status, hubspot_processing_status
ORDER BY count DESC;

-- View contacts with HubSpot errors
SELECT
    id,
    email,
    hubspot_processing_error,
    retry_count,
    next_retry_at,
    last_failed_crm
FROM contacts
WHERE hubspot_processing_status = 'Error'
ORDER BY updated_at DESC
LIMIT 10;

-- View HubSpot contact IDs
SELECT
    email,
    hubspot_contact_id,
    hubspot_sync_status,
    updated_at
FROM contacts
WHERE hubspot_contact_id IS NOT NULL
ORDER BY updated_at DESC
LIMIT 20;
```

---

## Troubleshooting Guide

### Issue: "HUBSPOT_API_KEY not configured"

**Symptom:** Error log when running manual test

**Solution:**
1. Check `.env` file has `HUBSPOT_API_KEY=pat-na1-...`
2. Verify token format (must start with `pat-na1-` or `pat-eu1-`)
3. Restart Docker: `docker compose down && docker compose up --build`

### Issue: Manual sync fails with 401

**Symptom:** "HubSpot search failed (HTTP 401): Unauthorized"

**Solution:**
1. Verify API token is correct in `.env`
2. Log into HubSpot ‚Üí Settings ‚Üí Integrations ‚Üí Private Apps
3. Verify "ScraperSky Contact Sync" app is Active
4. Regenerate token if needed (create new private app)
5. Update `.env` and restart Docker

### Issue: Manual sync fails with 400 "Property does not exist"

**Symptom:** "HubSpot API error: Property [scrapersky_domain_id] does not exist"

**Solution:**
1. Verify custom properties created in HubSpot
2. Go to Settings ‚Üí Properties ‚Üí Contact properties
3. Search for "ScraperSky" - should see 3 properties
4. Check internal names match `.env` configuration:
   - `HUBSPOT_CUSTOM_PROPERTY_DOMAIN_ID=scrapersky_domain_id`
   - `HUBSPOT_CUSTOM_PROPERTY_PAGE_ID=scrapersky_page_id`
   - `HUBSPOT_CUSTOM_PROPERTY_SYNC_DATE=scrapersky_sync_date`
5. If missing, create them using Part 1.3 instructions

### Issue: Contacts not showing in HubSpot dashboard

**Symptom:** Database shows `Complete` but HubSpot dashboard empty

**Solution:**
1. Wait 30-60 seconds for HubSpot indexing
2. Clear browser cache and refresh
3. Use HubSpot search API to verify:
   ```bash
   curl -X POST \
     https://api.hubapi.com/crm/v3/objects/contacts/search \
     -H "Authorization: Bearer pat-na1-YOUR_TOKEN" \
     -H "Content-Type: application/json" \
     -d '{"filterGroups":[{"filters":[{"propertyName":"email","operator":"EQ","value":"hubspot-test-fresh@scrapersky-test.com"}]}]}'
   ```

### Issue: Contact created as duplicate instead of updated

**Symptom:** Multiple contacts with same email in HubSpot

**Solution:**
1. This should NOT happen - 2-step upsert prevents duplicates
2. Check logs for "Found existing HubSpot contact" message
3. If duplicates exist, manually merge in HubSpot:
   - Go to contact record
   - Click Actions ‚Üí Merge
   - Select duplicate and merge
4. Report as bug if consistently happening

### Issue: Rate limit errors (429)

**Symptom:** "HubSpot API error: Rate limit exceeded"

**Solution:**
1. HubSpot free tier: 100 requests per 10 seconds
2. Wait 10 seconds between manual tests
3. Reduce batch size in `.env`:
   ```bash
   HUBSPOT_SYNC_SCHEDULER_BATCH_SIZE=5
   ```
4. Increase scheduler interval:
   ```bash
   HUBSPOT_SYNC_SCHEDULER_INTERVAL_MINUTES=5
   ```

---

## Success Criteria Checklist (Phase 1)

Mark each when complete:

- [ ] HubSpot account created
- [ ] Private app created with contact permissions
- [ ] API token obtained (starts with `pat-na1-` or `pat-eu1-`)
- [ ] 3 custom properties created in HubSpot
- [ ] `.env` configured with HubSpot token
- [ ] Docker stack starts without errors
- [ ] Manual sync of Contact 1 succeeds (status ‚Üí Complete)
- [ ] Manual sync of Contact 2 succeeds (status ‚Üí Complete)
- [ ] Both contacts visible in HubSpot dashboard
- [ ] Custom properties (domain_id, page_id) visible in contact details
- [ ] Update test works (no duplicate created)
- [ ] Invalid email triggers retry logic
- [ ] Invalid token triggers 401 error
- [ ] Error messages stored in `hubspot_processing_error` field

**If all checkboxes marked:** ‚úÖ **WO-016 PHASE 1 COMPLETE AND VALIDATED**

---

## Phase 2 Testing (To Be Added)

After Phase 2 (Scheduler) is implemented, this test plan will be updated with:

- Scheduler registration verification
- Automatic processing of Contact 3
- Scheduler interval testing (2-minute cycles)
- Batch processing verification
- Exponential backoff retry testing
- Scheduler error handling

**Phase 2 testing timeline:** +30-40 minutes

---

## Document Control

**Version History:**
- 1.0 (2025-11-18): Initial test plan for Phase 1 (Core Service)

**Related Documents:**
- WO-016.1: HubSpot Implementation Plan
- WO-015.10: Brevo Integration Test Plan (pattern reference)

**Approval:**
- Technical Author: Claude (Agent)
- Review Status: Pending user validation

---

**END OF TEST PLAN (PHASE 1)**
