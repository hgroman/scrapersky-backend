# WO-015.7.1: Dual-Status Adapter Test Plan for Local Claude

**Created:** 2025-01-18
**Purpose:** Verify WO-015.7 dual-status adapter implementation
**Tester:** Local Claude (Windsurf IDE with MCP Supabase access)
**Estimated Time:** 30-45 minutes
**Environment:** Local development + Production endpoints

---

## Executive Summary

This test plan verifies the critical WO-015.7 fix that adds dual-status adapter logic to the `/crm/select` endpoint. The fix ensures that when contacts are marked as "Selected" for a CRM, they are AUTOMATICALLY queued for processing by setting `{crm}_processing_status = 'Queued'`.

**Critical Verification Points:**
1. ‚úÖ Selecting a contact sets BOTH sync_status AND processing_status
2. ‚úÖ Unselecting a contact resets processing_status to NULL
3. ‚úÖ Response includes `queued_count` field
4. ‚úÖ Processing_error is cleared when selecting
5. ‚úÖ Pattern works for all 4 CRMs (Brevo, Mautic, n8n, HubSpot)

---

## Prerequisites

### 1. MCP Supabase Connection
Verify you have MCP access to the Supabase database:

```bash
# Test MCP connection
mcp__supabase-mcp-server__execute_sql "SELECT current_database(), current_user;"
```

**Expected Output:**
```
current_database | current_user
postgres         | postgres.xxx
```

### 2. API Authentication
You'll need a valid JWT token for API calls:

```bash
# Set environment variable for tests
export JWT_TOKEN="scraper_sky_2024"

# OR use actual production token if different
export API_BASE_URL="https://scrapersky-backend.onrender.com"
```

### 3. Test Data Setup
We'll create 5 test contacts for verification.

---

## Test Setup (10 minutes)

### Step 1: Create Test Contacts via MCP

**Execute via MCP Supabase:**

```sql
-- Create 5 test contacts with known UUIDs for easy testing
WITH test_domain AS (
  SELECT id FROM domains LIMIT 1
),
test_page AS (
  SELECT id FROM pages LIMIT 1
)
INSERT INTO contacts (
  id,
  domain_id,
  page_id,
  email,
  email_type,
  contact_curation_status,
  contact_processing_status,
  brevo_sync_status,
  brevo_processing_status,
  mautic_sync_status,
  mautic_processing_status,
  n8n_sync_status,
  n8n_processing_status,
  hubspot_sync_status,
  hubspot_processing_status,
  created_at,
  updated_at
)
SELECT
  gen_random_uuid() as id,
  (SELECT id FROM test_domain),
  (SELECT id FROM test_page),
  'test-dual-status-' || generate_series || '@example.com' as email,
  'CORPORATE' as email_type,
  'New' as contact_curation_status,
  NULL as contact_processing_status,
  'New' as brevo_sync_status,
  NULL as brevo_processing_status,
  'New' as mautic_sync_status,
  NULL as mautic_processing_status,
  'New' as n8n_sync_status,
  NULL as n8n_processing_status,
  'New' as hubspot_sync_status,
  NULL as hubspot_processing_status,
  NOW() as created_at,
  NOW() as updated_at
FROM generate_series(1, 5);

-- Get the test contact IDs for use in tests
SELECT
  id,
  email,
  brevo_sync_status,
  brevo_processing_status,
  mautic_sync_status,
  mautic_processing_status,
  n8n_sync_status,
  n8n_processing_status,
  hubspot_sync_status,
  hubspot_processing_status
FROM contacts
WHERE email LIKE 'test-dual-status-%@example.com'
ORDER BY email;
```

**Save the UUIDs from the output - you'll need them for curl commands:**
```
TEST_CONTACT_1="<uuid-from-output>"
TEST_CONTACT_2="<uuid-from-output>"
TEST_CONTACT_3="<uuid-from-output>"
TEST_CONTACT_4="<uuid-from-output>"
TEST_CONTACT_5="<uuid-from-output>"
```

### Step 2: Verify Initial State

**Execute via MCP Supabase:**

```sql
SELECT
  email,
  brevo_sync_status,
  brevo_processing_status,
  brevo_processing_error,
  mautic_sync_status,
  mautic_processing_status,
  n8n_sync_status,
  n8n_processing_status,
  hubspot_sync_status,
  hubspot_processing_status
FROM contacts
WHERE email LIKE 'test-dual-status-%@example.com'
ORDER BY email;
```

**Expected Initial State:**
```
All sync_status fields:       'New'
All processing_status fields: NULL
All processing_error fields:  NULL
```

‚úÖ **Pass Criteria:** All test contacts have default values (New, NULL, NULL)

---

## Test Suite: Dual-Status Adapter Verification

### Test 1: Select Single Contact for Brevo (CRITICAL)

**Objective:** Verify dual-status pattern sets BOTH sync_status AND processing_status

**Action:**
```bash
curl -X PUT "${API_BASE_URL}/api/v3/contacts/crm/select" \
  -H "Authorization: Bearer ${JWT_TOKEN}" \
  -H "Content-Type: application/json" \
  -d "{
    \"contact_ids\": [\"${TEST_CONTACT_1}\"],
    \"crms\": [\"brevo\"],
    \"action\": \"select\"
  }"
```

**Expected Response:**
```json
{
  "updated_count": 1,
  "queued_count": 1,
  "crms": ["brevo"],
  "action": "select",
  "message": "Selected 1 contacts for 1 CRM(s), 1 queued for processing"
}
```

**Database Verification via MCP:**
```sql
SELECT
  email,
  brevo_sync_status,
  brevo_processing_status,
  brevo_processing_error
FROM contacts
WHERE id = '<TEST_CONTACT_1>';
```

**Expected Database State:**
```
email:                     test-dual-status-1@example.com
brevo_sync_status:         'Selected' ‚úÖ (user decision)
brevo_processing_status:   'Queued'   ‚úÖ (system state - CRITICAL!)
brevo_processing_error:    NULL       ‚úÖ (cleared)
```

‚úÖ **Pass Criteria:**
- Response has `queued_count: 1`
- `brevo_sync_status = 'Selected'`
- `brevo_processing_status = 'Queued'` (NOT NULL)
- `brevo_processing_error = NULL`

‚ùå **Fail Criteria:**
- `brevo_processing_status` is NULL (dual-status adapter NOT working)
- Response missing `queued_count` field

---

### Test 2: Select Single Contact for Multiple CRMs

**Objective:** Verify dual-status pattern works for multiple CRMs simultaneously

**Action:**
```bash
curl -X PUT "${API_BASE_URL}/api/v3/contacts/crm/select" \
  -H "Authorization: Bearer ${JWT_TOKEN}" \
  -H "Content-Type: application/json" \
  -d "{
    \"contact_ids\": [\"${TEST_CONTACT_2}\"],
    \"crms\": [\"brevo\", \"hubspot\", \"mautic\"],
    \"action\": \"select\"
  }"
```

**Expected Response:**
```json
{
  "updated_count": 1,
  "queued_count": 3,
  "crms": ["brevo", "hubspot", "mautic"],
  "action": "select",
  "message": "Selected 1 contacts for 3 CRM(s), 3 queued for processing"
}
```

**Database Verification via MCP:**
```sql
SELECT
  email,
  brevo_sync_status,
  brevo_processing_status,
  hubspot_sync_status,
  hubspot_processing_status,
  mautic_sync_status,
  mautic_processing_status,
  n8n_sync_status,
  n8n_processing_status
FROM contacts
WHERE id = '<TEST_CONTACT_2>';
```

**Expected Database State:**
```
brevo_sync_status:         'Selected' ‚úÖ
brevo_processing_status:   'Queued'   ‚úÖ
hubspot_sync_status:       'Selected' ‚úÖ
hubspot_processing_status: 'Queued'   ‚úÖ
mautic_sync_status:        'Selected' ‚úÖ
mautic_processing_status:  'Queued'   ‚úÖ
n8n_sync_status:           'New'      ‚úÖ (not selected)
n8n_processing_status:     NULL       ‚úÖ (not queued)
```

‚úÖ **Pass Criteria:**
- Response has `queued_count: 3` (1 contact √ó 3 CRMs)
- All 3 selected CRMs have processing_status = 'Queued'
- n8n (not selected) remains New/NULL

---

### Test 3: Select Multiple Contacts for Single CRM

**Objective:** Verify batch selection with dual-status pattern

**Action:**
```bash
curl -X PUT "${API_BASE_URL}/api/v3/contacts/crm/select" \
  -H "Authorization: Bearer ${JWT_TOKEN}" \
  -H "Content-Type: application/json" \
  -d "{
    \"contact_ids\": [\"${TEST_CONTACT_3}\", \"${TEST_CONTACT_4}\"],
    \"crms\": [\"n8n\"],
    \"action\": \"select\"
  }"
```

**Expected Response:**
```json
{
  "updated_count": 2,
  "queued_count": 2,
  "crms": ["n8n"],
  "action": "select",
  "message": "Selected 2 contacts for 1 CRM(s), 2 queued for processing"
}
```

**Database Verification via MCP:**
```sql
SELECT
  email,
  n8n_sync_status,
  n8n_processing_status,
  n8n_processing_error
FROM contacts
WHERE id IN ('<TEST_CONTACT_3>', '<TEST_CONTACT_4>')
ORDER BY email;
```

**Expected Database State (both contacts):**
```
n8n_sync_status:       'Selected' ‚úÖ
n8n_processing_status: 'Queued'   ‚úÖ
n8n_processing_error:  NULL       ‚úÖ
```

‚úÖ **Pass Criteria:**
- Response has `queued_count: 2`
- Both contacts have processing_status = 'Queued'

---

### Test 4: Unselect Resets Processing Status (CRITICAL)

**Objective:** Verify unselect action resets processing_status to NULL

**Setup:** First select contact 5 for Brevo
```bash
curl -X PUT "${API_BASE_URL}/api/v3/contacts/crm/select" \
  -H "Authorization: Bearer ${JWT_TOKEN}" \
  -H "Content-Type: application/json" \
  -d "{
    \"contact_ids\": [\"${TEST_CONTACT_5}\"],
    \"crms\": [\"brevo\"],
    \"action\": \"select\"
  }"
```

**Verify Selected State via MCP:**
```sql
SELECT brevo_sync_status, brevo_processing_status
FROM contacts WHERE id = '<TEST_CONTACT_5>';
```
Expected: `'Selected', 'Queued'`

**Action: Unselect**
```bash
curl -X PUT "${API_BASE_URL}/api/v3/contacts/crm/select" \
  -H "Authorization: Bearer ${JWT_TOKEN}" \
  -H "Content-Type: application/json" \
  -d "{
    \"contact_ids\": [\"${TEST_CONTACT_5}\"],
    \"crms\": [\"brevo\"],
    \"action\": \"unselect\"
  }"
```

**Expected Response:**
```json
{
  "updated_count": 1,
  "queued_count": 0,
  "crms": ["brevo"],
  "action": "unselect",
  "message": "Unselected 1 contacts for 1 CRM(s), 0 queued for processing"
}
```

**Database Verification via MCP:**
```sql
SELECT
  email,
  brevo_sync_status,
  brevo_processing_status,
  brevo_processing_error
FROM contacts
WHERE id = '<TEST_CONTACT_5>';
```

**Expected Database State:**
```
brevo_sync_status:       'New'  ‚úÖ (reset to New)
brevo_processing_status: NULL   ‚úÖ (reset to NULL - CRITICAL!)
brevo_processing_error:  NULL   ‚úÖ (cleared)
```

‚úÖ **Pass Criteria:**
- Response has `queued_count: 0` (nothing queued when unselecting)
- `brevo_sync_status = 'New'`
- `brevo_processing_status = NULL` (NOT 'Queued')
- `brevo_processing_error = NULL`

‚ùå **Fail Criteria:**
- `brevo_processing_status` still = 'Queued' (not reset)

---

### Test 5: Error Clearing on Re-Selection

**Objective:** Verify processing_error is cleared when re-selecting a previously failed contact

**Setup: Manually inject an error via MCP:**
```sql
UPDATE contacts
SET
  brevo_sync_status = 'Error',
  brevo_processing_status = 'Error',
  brevo_processing_error = 'Previous sync failed: API timeout'
WHERE id = '<TEST_CONTACT_1>';

-- Verify error state
SELECT email, brevo_sync_status, brevo_processing_status, brevo_processing_error
FROM contacts WHERE id = '<TEST_CONTACT_1>';
```

**Expected Initial State:**
```
brevo_sync_status:       'Error'
brevo_processing_status: 'Error'
brevo_processing_error:  'Previous sync failed: API timeout'
```

**Action: Re-select the contact**
```bash
curl -X PUT "${API_BASE_URL}/api/v3/contacts/crm/select" \
  -H "Authorization: Bearer ${JWT_TOKEN}" \
  -H "Content-Type: application/json" \
  -d "{
    \"contact_ids\": [\"${TEST_CONTACT_1}\"],
    \"crms\": [\"brevo\"],
    \"action\": \"select\"
  }"
```

**Expected Response:**
```json
{
  "updated_count": 1,
  "queued_count": 1,
  "crms": ["brevo"],
  "action": "select",
  "message": "Selected 1 contacts for 1 CRM(s), 1 queued for processing"
}
```

**Database Verification via MCP:**
```sql
SELECT
  email,
  brevo_sync_status,
  brevo_processing_status,
  brevo_processing_error
FROM contacts
WHERE id = '<TEST_CONTACT_1>';
```

**Expected Database State:**
```
brevo_sync_status:       'Selected' ‚úÖ (changed from Error)
brevo_processing_status: 'Queued'   ‚úÖ (ready for retry)
brevo_processing_error:  NULL       ‚úÖ (CLEARED - allows fresh retry)
```

‚úÖ **Pass Criteria:**
- Error state overwritten to Selected/Queued
- `brevo_processing_error = NULL` (error cleared)
- Contact ready for Phase 2 scheduler to retry

---

### Test 6: Phase 2 Scheduler Query Simulation

**Objective:** Verify Phase 2 schedulers can find queued contacts using processing_status

**Database Query via MCP:**
```sql
-- Simulate Brevo scheduler query (this is what Phase 2 will use)
SELECT
  id,
  email,
  brevo_sync_status,
  brevo_processing_status,
  brevo_processing_error
FROM contacts
WHERE brevo_processing_status = 'Queued'
  AND email LIKE 'test-dual-status-%@example.com'
ORDER BY created_at
LIMIT 10;
```

**Expected Results:**
Should return all test contacts that were selected for Brevo in previous tests:
- TEST_CONTACT_1 (from Test 1 and Test 5)
- TEST_CONTACT_2 (from Test 2)

```
id                                   | email                           | brevo_sync_status | brevo_processing_status
<TEST_CONTACT_1>                     | test-dual-status-1@example.com | Selected          | Queued
<TEST_CONTACT_2>                     | test-dual-status-2@example.com | Selected          | Queued
```

‚úÖ **Pass Criteria:**
- Query returns contacts where processing_status = 'Queued'
- All returned contacts have sync_status = 'Selected'
- Phase 2 scheduler will be able to find and process these contacts

‚ùå **Fail Criteria:**
- Query returns 0 rows (dual-status adapter not working)
- Query returns contacts with NULL processing_status

---

### Test 7: All 4 CRMs Independent Operation

**Objective:** Verify all 4 CRMs can be selected independently with dual-status pattern

**Action: Select same contact for all 4 CRMs**
```bash
curl -X PUT "${API_BASE_URL}/api/v3/contacts/crm/select" \
  -H "Authorization: Bearer ${JWT_TOKEN}" \
  -H "Content-Type: application/json" \
  -d "{
    \"contact_ids\": [\"${TEST_CONTACT_3}\"],
    \"crms\": [\"brevo\", \"hubspot\", \"mautic\", \"n8n\"],
    \"action\": \"select\"
  }"
```

**Expected Response:**
```json
{
  "updated_count": 1,
  "queued_count": 4,
  "crms": ["brevo", "hubspot", "mautic", "n8n"],
  "action": "select",
  "message": "Selected 1 contacts for 4 CRM(s), 4 queued for processing"
}
```

**Database Verification via MCP:**
```sql
SELECT
  email,
  brevo_sync_status, brevo_processing_status,
  hubspot_sync_status, hubspot_processing_status,
  mautic_sync_status, mautic_processing_status,
  n8n_sync_status, n8n_processing_status
FROM contacts
WHERE id = '<TEST_CONTACT_3>';
```

**Expected Database State:**
```
All 4 sync_status fields:        'Selected' ‚úÖ
All 4 processing_status fields:  'Queued'   ‚úÖ
```

‚úÖ **Pass Criteria:**
- Response has `queued_count: 4` (1 contact √ó 4 CRMs)
- All 4 CRMs have processing_status = 'Queued'
- All 4 CRMs are independent (one can fail without affecting others)

---

### Test 8: Partial CRM Unselect

**Objective:** Verify unselecting one CRM doesn't affect other CRMs

**Setup:** Contact 3 is currently selected for all 4 CRMs (from Test 7)

**Action: Unselect only Brevo**
```bash
curl -X PUT "${API_BASE_URL}/api/v3/contacts/crm/select" \
  -H "Authorization: Bearer ${JWT_TOKEN}" \
  -H "Content-Type: application/json" \
  -d "{
    \"contact_ids\": [\"${TEST_CONTACT_3}\"],
    \"crms\": [\"brevo\"],
    \"action\": \"unselect\"
  }"
```

**Expected Response:**
```json
{
  "updated_count": 1,
  "queued_count": 0,
  "crms": ["brevo"],
  "action": "unselect",
  "message": "Unselected 1 contacts for 1 CRM(s), 0 queued for processing"
}
```

**Database Verification via MCP:**
```sql
SELECT
  email,
  brevo_sync_status, brevo_processing_status,
  hubspot_sync_status, hubspot_processing_status,
  mautic_sync_status, mautic_processing_status,
  n8n_sync_status, n8n_processing_status
FROM contacts
WHERE id = '<TEST_CONTACT_3>';
```

**Expected Database State:**
```
Brevo (unselected):
  brevo_sync_status:       'New'      ‚úÖ
  brevo_processing_status: NULL       ‚úÖ

Other CRMs (unchanged):
  hubspot_sync_status:     'Selected' ‚úÖ
  hubspot_processing_status: 'Queued' ‚úÖ
  mautic_sync_status:      'Selected' ‚úÖ
  mautic_processing_status: 'Queued'  ‚úÖ
  n8n_sync_status:         'Selected' ‚úÖ
  n8n_processing_status:   'Queued'   ‚úÖ
```

‚úÖ **Pass Criteria:**
- Only Brevo reset to New/NULL
- Other 3 CRMs remain Selected/Queued
- CRMs are truly independent

---

### Test 9: Idempotency - Re-selecting Already Selected Contact

**Objective:** Verify re-selecting an already selected contact is safe (idempotent)

**Setup:** Contact 2 is already selected for Brevo (from Test 2)

**Action: Select again**
```bash
curl -X PUT "${API_BASE_URL}/api/v3/contacts/crm/select" \
  -H "Authorization: Bearer ${JWT_TOKEN}" \
  -H "Content-Type: application/json" \
  -d "{
    \"contact_ids\": [\"${TEST_CONTACT_2}\"],
    \"crms\": [\"brevo\"],
    \"action\": \"select\"
  }"
```

**Expected Response:**
```json
{
  "updated_count": 1,
  "queued_count": 1,
  "crms": ["brevo"],
  "action": "select",
  "message": "Selected 1 contacts for 1 CRM(s), 1 queued for processing"
}
```

**Database Verification via MCP:**
```sql
SELECT
  email,
  brevo_sync_status,
  brevo_processing_status,
  brevo_processing_error,
  updated_at
FROM contacts
WHERE id = '<TEST_CONTACT_2>';
```

**Expected Database State:**
```
brevo_sync_status:       'Selected' ‚úÖ (still Selected)
brevo_processing_status: 'Queued'   ‚úÖ (still Queued)
brevo_processing_error:  NULL       ‚úÖ (still NULL)
updated_at:              [timestamp updated] ‚úÖ
```

‚úÖ **Pass Criteria:**
- No errors or warnings
- State remains Selected/Queued
- Operation is idempotent (safe to call multiple times)

---

### Test 10: Filter Contacts by Processing Status (Regression)

**Objective:** Verify existing list endpoint still works and can filter by CRM status

**Action:**
```bash
curl -X GET "${API_BASE_URL}/api/v3/contacts?brevo_sync_status=Selected&limit=50" \
  -H "Authorization: Bearer ${JWT_TOKEN}"
```

**Expected Response:**
```json
{
  "items": [
    {
      "id": "<uuid>",
      "email": "test-dual-status-X@example.com",
      "brevo_sync_status": "Selected",
      ...
    },
    ...
  ],
  "total": X,
  "page": 1,
  "limit": 50
}
```

**Database Verification via MCP:**
```sql
-- Verify filter matches database state
SELECT
  COUNT(*) as total_selected,
  COUNT(CASE WHEN brevo_processing_status = 'Queued' THEN 1 END) as total_queued
FROM contacts
WHERE brevo_sync_status = 'Selected'
  AND email LIKE 'test-dual-status-%@example.com';
```

**Expected Database State:**
```
total_selected: X (matches API response)
total_queued:   X (all selected contacts are queued)
```

‚úÖ **Pass Criteria:**
- List endpoint returns filtered results
- All returned contacts have brevo_sync_status = 'Selected'
- All selected contacts also have processing_status = 'Queued'

---

## Test Cleanup (5 minutes)

### Delete Test Contacts

**Execute via MCP Supabase:**

```sql
-- Delete all test contacts
DELETE FROM contacts
WHERE email LIKE 'test-dual-status-%@example.com';

-- Verify deletion
SELECT COUNT(*) as remaining_test_contacts
FROM contacts
WHERE email LIKE 'test-dual-status-%@example.com';
```

**Expected Result:**
```
remaining_test_contacts: 0
```

‚úÖ **Pass Criteria:** All test contacts deleted

---

## Test Report Template

### Test Execution Summary

**Date:** [YYYY-MM-DD]
**Tester:** Local Claude (Windsurf IDE)
**Environment:** [Local/Production]
**Duration:** [minutes]

#### Results Overview

| Test # | Test Name | Status | Notes |
|--------|-----------|--------|-------|
| 1 | Select Single Contact for Brevo | ‚úÖ PASS / ‚ùå FAIL | |
| 2 | Select Single Contact for Multiple CRMs | ‚úÖ PASS / ‚ùå FAIL | |
| 3 | Select Multiple Contacts for Single CRM | ‚úÖ PASS / ‚ùå FAIL | |
| 4 | Unselect Resets Processing Status | ‚úÖ PASS / ‚ùå FAIL | |
| 5 | Error Clearing on Re-Selection | ‚úÖ PASS / ‚ùå FAIL | |
| 6 | Phase 2 Scheduler Query Simulation | ‚úÖ PASS / ‚ùå FAIL | |
| 7 | All 4 CRMs Independent Operation | ‚úÖ PASS / ‚ùå FAIL | |
| 8 | Partial CRM Unselect | ‚úÖ PASS / ‚ùå FAIL | |
| 9 | Idempotency | ‚úÖ PASS / ‚ùå FAIL | |
| 10 | Filter Contacts by Processing Status | ‚úÖ PASS / ‚ùå FAIL | |

**Total:** X/10 tests passed

#### Critical Checks (Must All Pass)

- [ ] Test 1: Dual-status pattern sets processing_status = 'Queued'
- [ ] Test 4: Unselect resets processing_status to NULL
- [ ] Test 6: Phase 2 scheduler query finds queued contacts
- [ ] Response includes `queued_count` field in all tests

#### Issues Found

**Issue 1:** [Title]
- **Severity:** üî¥ Critical / üü° Medium / üü¢ Low
- **Description:** [Details]
- **Test:** [Which test failed]
- **Database State:** [Actual values]
- **Expected:** [Expected values]
- **Recommendation:** [Fix needed]

#### Overall Assessment

**WO-015.7 Dual-Status Adapter Fix:** ‚úÖ VERIFIED / ‚ùå FAILED

**Reason:**
[Brief explanation]

**Ready for Phase 2:** ‚úÖ YES / ‚ùå NO

**Blocker for Phase 2 (if any):**
[Description]

---

## Troubleshooting Guide

### Issue: processing_status is NULL after selecting

**Symptom:**
```sql
SELECT brevo_sync_status, brevo_processing_status FROM contacts WHERE id = '<uuid>';

brevo_sync_status: 'Selected'
brevo_processing_status: NULL  ‚ùå (should be 'Queued')
```

**Diagnosis:** Dual-status adapter not working

**Check:**
1. Verify code was deployed: `git log --oneline -5`
2. Check for commit: `1ee3289 fix(WO-015.7): Add dual-status adapter pattern`
3. Verify imports: `CRMProcessingStatus` and `HubSpotProcessingStatus`
4. Check API response includes `queued_count` field

**Fix:** WO-015.7 implementation incomplete - review src/routers/v3/contacts_router.py

---

### Issue: Response missing queued_count field

**Symptom:**
```json
{
  "updated_count": 1,
  "crms": ["brevo"],
  "action": "select",
  "message": "Selected 1 contacts for 1 CRM(s)"
}
```

**Diagnosis:** Old code version still deployed

**Fix:**
1. Pull latest: `git pull origin main`
2. Verify commit: `git log --grep="WO-015.7"`
3. Check router file has queued_count logic

---

### Issue: MCP connection failed

**Symptom:**
```
Error: Could not connect to Supabase
```

**Fix:**
1. Verify MCP server running in Windsurf
2. Check Supabase credentials in MCP config
3. Test connection: `mcp__supabase-mcp-server__execute_sql "SELECT 1;"`

---

### Issue: JWT authentication failed

**Symptom:**
```
401 Unauthorized
```

**Fix:**
1. Verify JWT_TOKEN environment variable set
2. Check token hasn't expired
3. Test with known good token: `scraper_sky_2024`

---

## Success Criteria Summary

**WO-015.7 is VERIFIED if:**

1. ‚úÖ All 10 tests pass
2. ‚úÖ All 4 critical checks pass
3. ‚úÖ Database shows processing_status = 'Queued' for all selected contacts
4. ‚úÖ API responses include queued_count field
5. ‚úÖ Phase 2 scheduler query (Test 6) returns queued contacts
6. ‚úÖ No breaking changes to existing endpoints (Test 10)

**WO-015.7 FAILS if:**

1. ‚ùå Any test 1, 4, or 6 fails (critical dual-status tests)
2. ‚ùå processing_status remains NULL after selecting
3. ‚ùå Response missing queued_count field
4. ‚ùå Unselect doesn't reset processing_status to NULL
5. ‚ùå Phase 2 scheduler query returns 0 rows

---

**Estimated Time:** 30-45 minutes
**Environment:** Local Claude (Windsurf IDE) with MCP Supabase access
**Next Step After Verification:** Phase 2 implementation (Brevo sync service)
