# WO-015.1: CSV Import Quick Start Guide for Frontend

**Date:** November 17, 2025  
**Audience:** Frontend team (already completed direct-submit JSON endpoints)  
**New Feature:** Add CSV file upload capability to existing modals  
**Reference:** Full API docs in `WO-015_FRONTEND_API_DOCUMENTATION.md`

---

## Overview

You've already implemented the JSON direct-submit endpoints. Now add **CSV file upload** as an alternative input method in the same modals.

**User Choice:**
- **Option A:** Paste/type domains/URLs (existing JSON endpoint)
- **Option B:** Upload CSV file (new CSV endpoint)

---

## Key Differences: JSON vs CSV Endpoints

| Feature | JSON Direct-Submit | CSV Import |
|---------|-------------------|------------|
| **Endpoint** | `/direct-submit` | `/import-csv` |
| **Method** | POST JSON | POST multipart/form-data |
| **Max Items** | 100 (domains/pages), 50 (sitemaps) | 1000 rows |
| **Error Handling** | Fails on first error (all-or-nothing) | Partial success (continues on errors) |
| **Response** | Simple success/fail | Detailed per-row results |
| **Duplicates** | Returns 409 on first duplicate | Skips duplicates, continues processing |

---

## Implementation Pattern

### UI Layout (Recommended)

```
┌─────────────────────────────────────────┐
│  Direct Submit Domains                  │
├─────────────────────────────────────────┤
│                                         │
│  ○ Paste Domains                        │
│  ┌─────────────────────────────────┐   │
│  │ example.com                     │   │
│  │ test.org                        │   │
│  │ another-site.com                │   │
│  └─────────────────────────────────┘   │
│                                         │
│  ○ Upload CSV File                      │
│  [Choose File] domains.csv              │
│                                         │
│  ☐ Auto-queue for processing            │
│                                         │
│  [Cancel]  [Submit]                     │
└─────────────────────────────────────────┘
```

### React Component Structure

```jsx
function DirectSubmitModal({ type, onClose, onSuccess }) {
  const [inputMethod, setInputMethod] = useState('paste'); // 'paste' or 'csv'
  const [textInput, setTextInput] = useState('');
  const [csvFile, setCsvFile] = useState(null);
  const [autoQueue, setAutoQueue] = useState(false);
  
  const handleSubmit = async () => {
    if (inputMethod === 'paste') {
      await submitJSON(textInput, autoQueue);
    } else {
      await submitCSV(csvFile);
    }
  };
  
  return (
    <Modal>
      <RadioGroup value={inputMethod} onChange={setInputMethod}>
        <Radio value="paste">Paste {type}</Radio>
        <Radio value="csv">Upload CSV File</Radio>
      </RadioGroup>
      
      {inputMethod === 'paste' ? (
        <Textarea value={textInput} onChange={setTextInput} />
      ) : (
        <FileInput accept=".csv" onChange={setCsvFile} />
      )}
      
      <Checkbox checked={autoQueue} onChange={setAutoQueue}>
        Auto-queue for processing
      </Checkbox>
      
      <Button onClick={handleSubmit}>Submit</Button>
    </Modal>
  );
}
```

---

## API Calls

### JSON Submit (Existing)

```javascript
async function submitDomainsJSON(domains, autoQueue) {
  const response = await fetch('/api/v3/domains/direct-submit', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${token}`
    },
    body: JSON.stringify({
      domains: domains,
      auto_queue: autoQueue
    })
  });
  
  if (!response.ok) {
    // Handle 409 Conflict or 422 Validation Error
    throw new Error(await response.json());
  }
  
  return await response.json();
  // { submitted_count: 3, domain_ids: [...], auto_queued: false }
}
```

### CSV Submit (New)

```javascript
async function submitDomainsCSV(file) {
  const formData = new FormData();
  formData.append('file', file);
  
  const response = await fetch('/api/v3/domains/import-csv', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${token}`
      // NO Content-Type header - browser sets it automatically for FormData
    },
    body: formData
  });
  
  if (!response.ok) {
    // Handle 400 Bad Request (invalid file)
    throw new Error(await response.json());
  }
  
  return await response.json();
  // { total_rows: 100, successful: 95, failed: 3, skipped: 2, results: [...] }
}
```

**IMPORTANT:** Do NOT set `Content-Type` header for CSV uploads. The browser automatically sets it to `multipart/form-data` with the correct boundary.

---

## Response Handling

### JSON Response (Simple)

```javascript
const result = await submitDomainsJSON(domains, autoQueue);

showSuccess(`${result.submitted_count} domains submitted successfully`);
refreshTable();
```

### CSV Response (Detailed)

```javascript
const result = await submitDomainsCSV(file);

// Show summary
showSuccess(
  `CSV Import Complete:
   ✅ ${result.successful} successful
   ⚠️ ${result.skipped} skipped (duplicates)
   ❌ ${result.failed} failed`
);

// Show detailed errors if any
if (result.failed > 0) {
  const errors = result.results
    .filter(r => r.status === 'error')
    .map(r => `Row ${r.row_number}: ${r.error}`)
    .join('\n');
  
  showWarning(`Errors:\n${errors}`);
}

refreshTable();
```

---

## CSV File Format

### Domains CSV
```csv
domain
example.com
www.testsite.org
https://another-site.com
```

### Pages CSV
```csv
url
https://example.com/contact
https://example.com/about
https://testsite.org/services
```

### Sitemaps CSV
```csv
sitemap_url
https://example.com/sitemap.xml
https://example.com/sitemap_index.xml
https://testsite.org/sitemap.xml
```

**Header Detection:**
- First row is treated as header if it contains recognized keywords
- Domains: `domain`, `domains`, `url`, `website`
- Pages: `url`, `urls`, `page`, `pages`, `link`
- Sitemaps: `sitemap_url`, `sitemap`, `url`, `sitemaps`, `sitemap_urls`
- Case-insensitive

**If no header:** All rows treated as data

---

## Error Handling

### CSV-Specific Errors (400 Bad Request)

```javascript
try {
  const result = await submitDomainsCSV(file);
} catch (error) {
  if (error.status === 400) {
    const detail = error.detail;
    
    if (detail.includes('not a CSV file')) {
      showError('Please upload a .csv file');
    } else if (detail.includes('exceeds maximum')) {
      showError('CSV file too large. Maximum 1000 rows.');
    } else if (detail.includes('empty')) {
      showError('CSV file is empty');
    } else if (detail.includes('UTF-8')) {
      showError('CSV file must be UTF-8 encoded');
    }
  }
}
```

### Partial Success Handling

CSV imports use **partial success** - some rows succeed, others fail:

```javascript
const result = await submitDomainsCSV(file);

if (result.successful > 0 && result.failed === 0) {
  // Perfect success
  showSuccess(`All ${result.successful} domains imported successfully`);
  
} else if (result.successful > 0 && result.failed > 0) {
  // Partial success
  showWarning(
    `Partial import: ${result.successful} succeeded, ${result.failed} failed. 
     Check details below.`
  );
  
  // Show expandable error details
  renderErrorTable(result.results.filter(r => r.status === 'error'));
  
} else if (result.successful === 0) {
  // Total failure
  showError(`Import failed: All ${result.failed} rows had errors`);
  renderErrorTable(result.results);
}
```

---

## File Validation (Frontend)

```javascript
function validateCSVFile(file) {
  // Check file extension
  if (!file.name.endsWith('.csv')) {
    throw new Error('File must have .csv extension');
  }
  
  // Check file size (10MB max recommended)
  const maxSize = 10 * 1024 * 1024; // 10MB
  if (file.size > maxSize) {
    throw new Error('File too large. Maximum 10MB.');
  }
  
  // Check MIME type (optional - not all browsers set this correctly)
  const validTypes = ['text/csv', 'application/csv', 'text/plain'];
  if (file.type && !validTypes.includes(file.type)) {
    console.warn('Unexpected MIME type:', file.type);
    // Don't block - backend will validate
  }
  
  return true;
}
```

---

## Complete Example: Domains Modal with CSV

```jsx
import { useState } from 'react';
import { Modal, Button, Textarea, FileInput, Radio, Checkbox } from '@/components';

function DirectSubmitDomainsModal({ show, onClose, onSuccess }) {
  const [inputMethod, setInputMethod] = useState('paste');
  const [textInput, setTextInput] = useState('');
  const [csvFile, setCsvFile] = useState(null);
  const [autoQueue, setAutoQueue] = useState(false);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  
  const handleFileChange = (e) => {
    const file = e.target.files[0];
    if (file) {
      try {
        validateCSVFile(file);
        setCsvFile(file);
        setError(null);
      } catch (err) {
        setError(err.message);
        setCsvFile(null);
      }
    }
  };
  
  const handleSubmit = async () => {
    setLoading(true);
    setError(null);
    
    try {
      let result;
      
      if (inputMethod === 'paste') {
        // Parse textarea input
        const domains = textInput
          .split(/[\n,]+/)
          .map(d => d.trim())
          .filter(d => d.length > 0);
        
        if (domains.length === 0) {
          throw new Error('Please enter at least one domain');
        }
        
        // Call JSON endpoint
        result = await submitDomainsJSON(domains, autoQueue);
        
        showSuccess(`${result.submitted_count} domains submitted successfully`);
        
      } else {
        // CSV upload
        if (!csvFile) {
          throw new Error('Please select a CSV file');
        }
        
        // Call CSV endpoint
        result = await submitDomainsCSV(csvFile);
        
        // Handle partial success
        if (result.failed > 0) {
          showWarning(
            `Import complete: ${result.successful} succeeded, ${result.failed} failed`
          );
        } else {
          showSuccess(`${result.successful} domains imported successfully`);
        }
      }
      
      onSuccess(result);
      onClose();
      
    } catch (err) {
      setError(err.message);
    } finally {
      setLoading(false);
    }
  };
  
  return (
    <Modal show={show} onHide={onClose}>
      <Modal.Header>Direct Submit Domains</Modal.Header>
      
      <Modal.Body>
        {/* Input Method Selection */}
        <div className="mb-4">
          <label className="block mb-2">Input Method:</label>
          <div className="flex gap-4">
            <Radio
              checked={inputMethod === 'paste'}
              onChange={() => setInputMethod('paste')}
              label="Paste Domains"
            />
            <Radio
              checked={inputMethod === 'csv'}
              onChange={() => setInputMethod('csv')}
              label="Upload CSV File"
            />
          </div>
        </div>
        
        {/* Paste Input */}
        {inputMethod === 'paste' && (
          <Textarea
            value={textInput}
            onChange={(e) => setTextInput(e.target.value)}
            placeholder="Paste domains (one per line or comma-separated)&#10;example.com&#10;test.org&#10;another-site.com"
            rows={8}
            className="mb-4"
          />
        )}
        
        {/* CSV Upload */}
        {inputMethod === 'csv' && (
          <div className="mb-4">
            <FileInput
              accept=".csv"
              onChange={handleFileChange}
              className="mb-2"
            />
            {csvFile && (
              <div className="text-sm text-gray-600">
                Selected: {csvFile.name} ({(csvFile.size / 1024).toFixed(1)} KB)
              </div>
            )}
            <div className="text-sm text-gray-500 mt-2">
              CSV format: Single column with header "domain"<br/>
              Maximum 1000 rows
            </div>
          </div>
        )}
        
        {/* Auto-queue Option */}
        <Checkbox
          checked={autoQueue}
          onChange={(e) => setAutoQueue(e.target.checked)}
          label="Auto-queue for sitemap analysis"
          className="mb-4"
        />
        
        {/* Error Display */}
        {error && (
          <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded mb-4">
            {error}
          </div>
        )}
      </Modal.Body>
      
      <Modal.Footer>
        <Button variant="secondary" onClick={onClose} disabled={loading}>
          Cancel
        </Button>
        <Button onClick={handleSubmit} disabled={loading}>
          {loading ? 'Submitting...' : 'Submit'}
        </Button>
      </Modal.Footer>
    </Modal>
  );
}
```

---

## Testing Checklist

### CSV Import Tests

- [ ] Upload valid CSV with 10 rows → All succeed
- [ ] Upload CSV with 1000 rows → All succeed
- [ ] Upload CSV with 1001 rows → 400 error
- [ ] Upload .txt file → 400 error
- [ ] Upload empty CSV → 400 error
- [ ] Upload CSV with duplicates → Some skipped, others succeed
- [ ] Upload CSV with invalid domains → Some fail, others succeed
- [ ] Upload CSV without header → All rows treated as data
- [ ] Upload CSV with header → Header row ignored
- [ ] Test with existing domains in database → Skipped correctly

### Error Display Tests

- [ ] Show summary: "95 succeeded, 3 failed, 2 skipped"
- [ ] Show expandable error details for failed rows
- [ ] Show which rows were skipped (duplicates)
- [ ] Clear error state when switching input methods
- [ ] Clear file selection when switching to paste mode

---

## API Endpoint Reference

| Resource | JSON Endpoint | CSV Endpoint |
|----------|--------------|--------------|
| Domains | `POST /api/v3/domains/direct-submit` | `POST /api/v3/domains/import-csv` |
| Pages | `POST /api/v3/pages/direct-submit` | `POST /api/v3/pages/import-csv` |
| Sitemaps | `POST /api/v3/sitemaps/direct-submit` | `POST /api/v3/sitemaps/import-csv` |

**All endpoints require JWT authentication.**

---

## Key Differences Summary

### What's the Same:
- Same modal/UI location
- Same auto-queue checkbox
- Same authentication (JWT token)
- Same table refresh after submission

### What's Different:
- **Request format:** JSON body vs FormData
- **Max items:** 100 vs 1000
- **Error handling:** All-or-nothing vs partial success
- **Response format:** Simple vs detailed per-row results
- **Duplicate handling:** 409 error vs skip and continue

---

## Questions?

- **Full API Documentation:** `WO-015_FRONTEND_API_DOCUMENTATION.md`
- **Backend Code:** `src/routers/v3/*_csv_import_router.py`
- **Schemas:** `src/schemas/csv_import_schemas.py`
- **Testing:** All endpoints tested and production-ready (commit 630949e)

**Implementation Time Estimate:** 2-4 hours per tab (already have JSON working)
