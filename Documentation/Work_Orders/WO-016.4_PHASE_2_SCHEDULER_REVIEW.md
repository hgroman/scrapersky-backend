# WO-016.4: HubSpot Phase 2 Scheduler - Implementation Review & Test Plan

**Date:** 2025-11-18  
**Phase:** 2 (Background Scheduler)  
**Status:** üîç READY FOR TESTING  
**Previous Phase:** ‚úÖ Phase 1 Complete (Core Service Verified)

---

## Executive Summary

Phase 2 implementation adds automated background processing for HubSpot contact sync. The scheduler follows the same proven pattern as Brevo (WO-015), using the SDK `run_job_loop` for reliable batch processing.

**Implementation Status:**
- ‚úÖ Scheduler code merged from branch
- ‚úÖ Registered in main.py
- ‚úÖ Configuration in .env
- ‚úÖ Follows SDK patterns
- üîç Ready for testing

---

## Architecture Review

### File Structure

```
src/services/crm/
‚îú‚îÄ‚îÄ hubspot_sync_service.py      ‚úÖ Phase 1 (Tested & Verified)
‚îî‚îÄ‚îÄ hubspot_sync_scheduler.py    üîç Phase 2 (Ready for Testing)

src/main.py                       ‚úÖ Scheduler registered
.env                              ‚úÖ Configuration complete
```

### Pattern Compliance

**Reference Pattern:** `src/services/WF7_V2_L4_2of2_PageCurationScheduler.py`

**SDK Pattern Used:** ‚úÖ `run_job_loop`
- Automatic status transitions
- Built-in error handling
- Batch processing
- Race condition prevention

**Comparison with Brevo Scheduler:**

| Feature | Brevo | HubSpot | Status |
|---------|-------|---------|--------|
| SDK Pattern | run_job_loop | run_job_loop | ‚úÖ Match |
| Status Field | brevo_processing_status | hubspot_processing_status | ‚úÖ Match |
| Error Field | brevo_processing_error | hubspot_processing_error | ‚úÖ Match |
| Batch Size | 10 | 10 | ‚úÖ Match |
| Interval | 5 min | 5 min | ‚úÖ Match |
| Max Instances | 1 | 1 | ‚úÖ Match |
| Retry Filter | next_retry_at | next_retry_at | ‚úÖ Match |
| Safety Check | API key check | API key check | ‚úÖ Match |

**Verdict:** ‚úÖ Perfect pattern consistency

---

## Code Review

### Scheduler Implementation

**File:** `src/services/crm/hubspot_sync_scheduler.py`

#### Key Components

**1. Main Processing Function** (Lines 31-69)
```python
async def process_hubspot_sync_queue():
    """Processes contacts marked as 'Queued' for HubSpot sync"""
    service = HubSpotSyncService()
    
    await run_job_loop(
        model=Contact,
        status_enum=CRMProcessingStatus,
        queued_status=CRMProcessingStatus.Queued,
        processing_status=CRMProcessingStatus.Processing,
        completed_status=CRMProcessingStatus.Complete,
        failed_status=CRMProcessingStatus.Error,
        processing_function=service.process_single_contact,
        batch_size=settings.HUBSPOT_SYNC_SCHEDULER_BATCH_SIZE,
        order_by_column=asc(Contact.updated_at),
        status_field_name="hubspot_processing_status",
        error_field_name="hubspot_processing_error",
        additional_filters=[
            or_(
                Contact.next_retry_at.is_(None),
                Contact.next_retry_at <= datetime.utcnow(),
            )
        ],
    )
```

**Analysis:** ‚úÖ CORRECT
- Uses SDK `run_job_loop` pattern
- Proper status field mapping
- Retry filter implemented
- Batch size configurable

**2. Setup Function** (Lines 75-118)
```python
def setup_hubspot_sync_scheduler():
    """Adds the HubSpot contact sync job to the main scheduler"""
    
    # Safety check: Don't start if API key missing
    if not settings.HUBSPOT_API_KEY:
        logger.warning("‚ö†Ô∏è HUBSPOT_API_KEY not configured - scheduler DISABLED")
        return
    
    scheduler.add_job(
        process_hubspot_sync_queue,
        trigger="interval",
        minutes=settings.HUBSPOT_SYNC_SCHEDULER_INTERVAL_MINUTES,
        id="hubspot_contact_sync_processor",
        name="HubSpot Contact Sync Processor",
        replace_existing=True,
        max_instances=settings.HUBSPOT_SYNC_SCHEDULER_MAX_INSTANCES,
        misfire_grace_time=1800,  # 30 minutes
    )
```

**Analysis:** ‚úÖ CORRECT
- Safety check prevents startup without API key
- Proper APScheduler configuration
- max_instances=1 prevents race conditions
- Graceful degradation if config missing

**3. Main.py Registration** (Lines 163-167)
```python
# WO-016: HubSpot CRM sync scheduler
try:
    setup_hubspot_sync_scheduler()
except Exception as e:
    logger.error(f"Failed to setup HubSpot Sync scheduler job: {e}", exc_info=True)
```

**Analysis:** ‚úÖ CORRECT
- Wrapped in try/except
- Won't crash app if scheduler fails
- Proper error logging

---

## Configuration Review

### Environment Variables

**File:** `.env`

```bash
# HubSpot CRM Integration (WO-016)
HUBSPOT_API_KEY=pat-na1-xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx  ‚úÖ
HUBSPOT_PORTAL_ID=                                            ‚úÖ (optional)
HUBSPOT_API_BASE_URL=https://api.hubapi.com                   ‚úÖ

# Scheduler Settings
HUBSPOT_SYNC_SCHEDULER_INTERVAL_MINUTES=5                     ‚úÖ
HUBSPOT_SYNC_SCHEDULER_BATCH_SIZE=10                          ‚úÖ
HUBSPOT_SYNC_SCHEDULER_MAX_INSTANCES=1                        ‚úÖ

# Retry Logic
HUBSPOT_SYNC_MAX_RETRIES=3                                    ‚úÖ
HUBSPOT_SYNC_RETRY_DELAY_MINUTES=5                            ‚úÖ
HUBSPOT_SYNC_RETRY_EXPONENTIAL=true                           ‚úÖ

# Custom Properties
HUBSPOT_CUSTOM_PROPERTY_DOMAIN_ID=scrapersky_domain_id        ‚úÖ
HUBSPOT_CUSTOM_PROPERTY_PAGE_ID=scrapersky_page_id            ‚úÖ
HUBSPOT_CUSTOM_PROPERTY_SYNC_DATE=scrapersky_sync_date        ‚úÖ
```

**Status:** ‚úÖ ALL CONFIGURED

---

## Test Plan - Phase 2

### Prerequisites

**From Phase 1:**
- ‚úÖ HubSpot account configured
- ‚úÖ Private app created with scopes
- ‚úÖ Custom properties created
- ‚úÖ API key working
- ‚úÖ 3 test contacts exist in HubSpot

**For Phase 2:**
- ‚úÖ Docker environment running
- ‚úÖ Scheduler configuration in .env
- ‚úÖ Test contacts in database

---

### Test 1: Scheduler Startup Verification

**Objective:** Verify scheduler starts correctly and registers with APScheduler

**Steps:**
1. Restart Docker containers
2. Check startup logs for scheduler registration
3. Verify no errors during initialization

**Expected Output:**
```
üìã Configuring HubSpot sync scheduler...
   Interval: 5 minutes
   Batch size: 10 contacts
   Max instances: 1
‚úÖ HubSpot sync scheduler job registered successfully
```

**Success Criteria:**
- ‚úÖ Scheduler registered message appears
- ‚úÖ No errors in logs
- ‚úÖ Configuration values correct

---

### Test 2: Queue New Contacts for Sync

**Objective:** Create new test contacts and verify they get queued

**Steps:**
1. Insert 3 new test contacts via MCP
2. Set `hubspot_processing_status = 'Queued'`
3. Verify contacts are in database

**SQL:**
```sql
INSERT INTO contacts (
    email, name, phone_number, 
    domain_id, page_id,
    hubspot_sync_status, hubspot_processing_status
) VALUES 
(
    'hubspot-scheduler-test-1@scrapersky-test.com',
    'Scheduler Test 1',
    '+1-555-9001',
    '1ad6264b-a0b6-4551-860a-1326b2bfa28f',
    'ddc03eef-2550-46de-aca8-bbdb7cf525cb',
    'Queued',
    'Queued'
),
(
    'hubspot-scheduler-test-2@scrapersky-test.com',
    'Scheduler Test 2',
    '+1-555-9002',
    '1ad6264b-a0b6-4551-860a-1326b2bfa28f',
    'ddc03eef-2550-46de-aca8-bbdb7cf525cb',
    'Queued',
    'Queued'
),
(
    'hubspot-scheduler-test-3@scrapersky-test.com',
    'Scheduler Test 3',
    NULL,
    '1ad6264b-a0b6-4551-860a-1326b2bfa28f',
    'ddc03eef-2550-46de-aca8-bbdb7cf525cb',
    'Queued',
    'Queued'
) RETURNING id, email, hubspot_processing_status;
```

**Verification:**
```sql
SELECT id, email, hubspot_processing_status, hubspot_sync_status
FROM contacts
WHERE email LIKE '%scheduler-test%@scrapersky-test.com'
ORDER BY email;
```

**Expected:** 3 contacts with status 'Queued'

---

### Test 3: Automated Sync Processing

**Objective:** Verify scheduler automatically processes queued contacts

**Steps:**
1. Wait for next scheduler cycle (max 5 minutes)
2. Monitor Docker logs for processing activity
3. Verify contacts are processed

**Expected Log Output:**
```
üöÄ Starting HubSpot sync scheduler cycle
üìß Processing contact: hubspot-scheduler-test-1@scrapersky-test.com
‚úÖ Contact synced successfully to HubSpot
üìß Processing contact: hubspot-scheduler-test-2@scrapersky-test.com
‚úÖ Contact synced successfully to HubSpot
üìß Processing contact: hubspot-scheduler-test-3@scrapersky-test.com
‚úÖ Contact synced successfully to HubSpot
‚úÖ Finished HubSpot sync scheduler cycle
```

**Database Verification:**
```sql
SELECT 
    email,
    hubspot_sync_status,
    hubspot_processing_status,
    hubspot_contact_id,
    retry_count,
    hubspot_processing_error
FROM contacts
WHERE email LIKE '%scheduler-test%@scrapersky-test.com'
ORDER BY email;
```

**Expected Results:**
| Email | Sync Status | Processing Status | HubSpot ID | Retries | Error |
|-------|-------------|-------------------|------------|---------|-------|
| scheduler-test-1 | Complete | Complete | [ID] | 0 | NULL |
| scheduler-test-2 | Complete | Complete | [ID] | 0 | NULL |
| scheduler-test-3 | Complete | Complete | [ID] | 0 | NULL |

**Success Criteria:**
- ‚úÖ All 3 contacts processed within 5 minutes
- ‚úÖ Status = 'Complete' for all
- ‚úÖ HubSpot IDs assigned
- ‚úÖ No errors
- ‚úÖ Zero retries

---

### Test 4: HubSpot Dashboard Verification

**Objective:** Verify contacts appear in HubSpot with correct data

**Steps:**
1. Query HubSpot API for each contact
2. Verify all properties present
3. Check custom properties

**API Verification:**
```bash
# Get contact by ID from database
curl -X GET \
  "https://api.hubapi.com/crm/v3/objects/contacts/{hubspot_contact_id}?properties=email,firstname,lastname,phone,scrapersky_domain_id,scrapersky_page_id,scrapersky_sync_date" \
  -H "Authorization: Bearer $HUBSPOT_API_KEY"
```

**Expected for Each Contact:**
```json
{
  "properties": {
    "email": "hubspot-scheduler-test-1@scrapersky-test.com",
    "firstname": "Scheduler",
    "lastname": "Test 1",
    "phone": "+1-555-9001",
    "scrapersky_domain_id": "1ad6264b-a0b6-4551-860a-1326b2bfa28f",
    "scrapersky_page_id": "ddc03eef-2550-46de-aca8-bbdb7cf525cb",
    "scrapersky_sync_date": "2025-11-19"
  }
}
```

**Success Criteria:**
- ‚úÖ All 3 contacts visible in HubSpot
- ‚úÖ All standard properties correct
- ‚úÖ All custom properties present
- ‚úÖ Sync date is today

---

### Test 5: Retry Logic Verification

**Objective:** Verify retry mechanism works for failed syncs

**Steps:**
1. Temporarily invalidate API key in .env
2. Restart Docker
3. Queue a new contact
4. Wait for sync attempt (should fail)
5. Verify retry scheduled
6. Restore valid API key
7. Restart Docker
8. Verify contact syncs on retry

**Expected Behavior:**

**First Attempt (Invalid Key):**
```sql
-- After first failure
SELECT 
    email,
    hubspot_processing_status,
    retry_count,
    next_retry_at,
    hubspot_processing_error
FROM contacts
WHERE email = 'retry-test@scrapersky-test.com';

-- Expected:
-- processing_status: 'Queued' (ready for retry)
-- retry_count: 1
-- next_retry_at: ~5 minutes from now
-- error: "401 Unauthorized" or similar
```

**After Retry (Valid Key):**
```sql
-- After successful retry
SELECT 
    email,
    hubspot_processing_status,
    hubspot_contact_id,
    retry_count
FROM contacts
WHERE email = 'retry-test@scrapersky-test.com';

-- Expected:
-- processing_status: 'Complete'
-- hubspot_contact_id: [assigned]
-- retry_count: 1 (shows it retried once)
```

**Success Criteria:**
- ‚úÖ First attempt fails with error logged
- ‚úÖ Retry scheduled with exponential backoff
- ‚úÖ Second attempt succeeds
- ‚úÖ Final status is 'Complete'

---

### Test 6: Batch Processing Verification

**Objective:** Verify scheduler processes contacts in batches

**Steps:**
1. Queue 25 contacts (more than batch size of 10)
2. Monitor logs for batch processing
3. Verify all contacts eventually processed

**Expected Behavior:**
- First cycle: 10 contacts processed
- Second cycle: 10 contacts processed
- Third cycle: 5 contacts processed

**Success Criteria:**
- ‚úÖ Batch size respected (10 per cycle)
- ‚úÖ All 25 contacts eventually processed
- ‚úÖ No race conditions
- ‚úÖ No duplicate processing

---

### Test 7: Concurrent Safety Verification

**Objective:** Verify max_instances=1 prevents race conditions

**Steps:**
1. Queue 20 contacts
2. Verify only 1 scheduler instance runs at a time
3. Check for duplicate processing

**Verification:**
```sql
-- Check for any contacts processed multiple times
SELECT 
    email,
    COUNT(*) as sync_count
FROM contacts
WHERE email LIKE '%scheduler-test%'
GROUP BY email
HAVING COUNT(*) > 1;

-- Expected: 0 rows (no duplicates)
```

**Success Criteria:**
- ‚úÖ Only 1 scheduler instance active
- ‚úÖ No duplicate syncs
- ‚úÖ No race condition errors

---

### Test 8: Performance Monitoring

**Objective:** Measure scheduler performance

**Metrics to Track:**
1. **Processing Time:** Time per contact
2. **Cycle Duration:** Total time per scheduler cycle
3. **Success Rate:** % of contacts synced successfully
4. **Retry Rate:** % requiring retries

**Expected Performance:**
- Processing time: 1-2 seconds per contact
- Cycle duration: 10-20 seconds for 10 contacts
- Success rate: >95%
- Retry rate: <5%

---

## Success Criteria - Phase 2

**Phase 2 is COMPLETE when:**

1. ‚úÖ Scheduler starts without errors
2. ‚úÖ Queued contacts automatically processed
3. ‚úÖ All test contacts synced to HubSpot
4. ‚úÖ Database statuses updated correctly
5. ‚úÖ Retry logic working
6. ‚úÖ Batch processing working
7. ‚úÖ No race conditions
8. ‚úÖ Performance acceptable
9. ‚úÖ Logs clear and informative
10. ‚úÖ No errors in production-like conditions

---

## Rollback Plan

**If Issues Found:**

1. **Disable Scheduler:**
   ```bash
   # In .env, remove or comment out API key
   # HUBSPOT_API_KEY=
   ```

2. **Restart Docker:**
   ```bash
   docker compose restart scrapersky
   ```

3. **Verify Disabled:**
   ```
   ‚ö†Ô∏è HUBSPOT_API_KEY not configured - HubSpot sync scheduler DISABLED
   ```

4. **Manual Processing:**
   - Use Phase 1 manual test script
   - Process contacts individually
   - Debug issues

---

## Risk Assessment

### Low Risk ‚úÖ

1. **Pattern Proven:** Same as Brevo (WO-015)
2. **SDK Tested:** `run_job_loop` is battle-tested
3. **Safety Checks:** API key validation, max_instances
4. **Graceful Degradation:** Disables if not configured

### Medium Risk ‚ö†Ô∏è

1. **HubSpot API Limits:** Unknown rate limits
   - **Mitigation:** Start with 5-minute interval
2. **Large Queues:** Many contacts could take time
   - **Mitigation:** Batch size of 10

### Monitoring Required üìä

1. **API Errors:** Watch for 429 (rate limit)
2. **Processing Time:** Ensure cycles complete in time
3. **Retry Patterns:** Monitor retry success rate

---

## Next Steps

### Immediate Testing

1. **Run Test 1:** Verify scheduler startup
2. **Run Test 2-3:** Queue and process contacts
3. **Run Test 4:** Verify HubSpot dashboard
4. **Run Test 5:** Test retry logic

### After Testing

1. **Document Results:** Create WO-016.5_PHASE_2_TEST_RESULTS.md
2. **Production Deployment:** Deploy to Render
3. **Monitor First Runs:** Watch logs closely
4. **Optimize if Needed:** Adjust intervals/batch sizes

---

## Files to Review

### Implementation Files
1. ‚úÖ `src/services/crm/hubspot_sync_scheduler.py` - Scheduler implementation
2. ‚úÖ `src/main.py` - Scheduler registration
3. ‚úÖ `.env` - Configuration

### Test Files
1. üîç Test contacts to be created
2. üîç Verification queries to be run

### Documentation
1. ‚úÖ This file (WO-016.4_PHASE_2_SCHEDULER_REVIEW.md)
2. üîç WO-016.5_PHASE_2_TEST_RESULTS.md (to be created)

---

## Conclusion

**Implementation Quality:** üü¢ EXCELLENT
- Perfect pattern consistency with Brevo
- Comprehensive error handling
- Well-documented
- Production-ready code

**Configuration:** üü¢ COMPLETE
- All settings in .env
- Sensible defaults
- Safety checks in place

**Risk Level:** üü¢ LOW
- Proven pattern
- Tested SDK
- Graceful degradation

**Confidence Level:** üü¢ VERY HIGH
- Code review passed
- Pattern verified
- Ready for testing

**Recommendation:** ‚úÖ PROCEED WITH TESTING

---

**Review Date:** 2025-11-18  
**Reviewer:** Local Claude (Windsurf)  
**Status:** üîç APPROVED FOR TESTING  
**Next Action:** Execute Test Plan (Tests 1-8)
