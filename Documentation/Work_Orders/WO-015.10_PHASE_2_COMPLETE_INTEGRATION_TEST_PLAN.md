# WO-015.10: Phase 2 Complete Integration Test Plan

**Document Version:** 1.0
**Created:** 2025-11-18
**Purpose:** Comprehensive test plan for local Claude (Windsurf IDE) to verify complete Brevo sync implementation
**Environment:** Docker Compose + Supabase MCP
**Scope:** End-to-end testing of Step 1 (Core Service) + Step 2 (Background Scheduler)

---

## Prerequisites Checklist

Before starting tests, verify:

- [ ] Docker Desktop running
- [ ] Windsurf IDE with Claude and MCP Supabase server configured
- [ ] `.env` file configured with Supabase credentials
- [ ] Brevo account created (free tier sufficient)
- [ ] Brevo API key obtained (starts with `xkeysib-`)
- [ ] MCP Supabase connection tested (`SELECT 1`)

---

## Part 1: Environment Setup

### 1.1 Configure Brevo in `.env`

Add the following to your `.env` file:

```bash
# --- Brevo CRM Integration (WO-015) ---
BREVO_API_KEY=xkeysib-YOUR_ACTUAL_API_KEY_HERE
BREVO_LIST_ID=  # Optional - leave empty for now
BREVO_API_BASE_URL=https://api.brevo.com/v3

# Brevo Sync Scheduler Settings (WO-015 Phase 2)
BREVO_SYNC_SCHEDULER_INTERVAL_MINUTES=2  # Shortened to 2 min for testing
BREVO_SYNC_SCHEDULER_BATCH_SIZE=5        # Smaller batch for testing
BREVO_SYNC_SCHEDULER_MAX_INSTANCES=1

# Brevo Retry Logic Settings (WO-015 Phase 2)
BREVO_SYNC_MAX_RETRIES=3
BREVO_SYNC_RETRY_DELAY_MINUTES=1         # Shortened to 1 min for testing
BREVO_SYNC_RETRY_EXPONENTIAL=true
```

**‚ö†Ô∏è Important:** Replace `xkeysib-YOUR_ACTUAL_API_KEY_HERE` with your real Brevo API key.

**Testing Configuration Notes:**
- Interval reduced to **2 minutes** (production: 5 min) for faster testing
- Batch size reduced to **5 contacts** (production: 10) for easier verification
- Retry delay reduced to **1 minute** (production: 5 min) for faster retry testing

### 1.2 Start Docker Compose Stack

```bash
cd /home/user/scrapersky-backend
docker compose down  # Clean shutdown
docker compose up --build
```

**Expected Output:**
```
‚úÖ Look for these log lines (indicates scheduler registered):

[INFO] Starting up the ScraperSky API - Lifespan Start
[INFO] Adding jobs to the shared scheduler...
[INFO] üìã Configuring Brevo sync scheduler...
[INFO]    Interval: 2 minutes
[INFO]    Batch size: 5 contacts
[INFO]    Max instances: 1
[INFO] ‚úÖ Brevo sync scheduler job registered successfully
[INFO] Finished adding jobs to shared scheduler.
```

**‚ùå If you see warning:**
```
‚ö†Ô∏è BREVO_API_KEY not configured - Brevo sync scheduler DISABLED
   Set BREVO_API_KEY in .env to enable automatic Brevo sync
```
‚Üí Go back to step 1.1, fix your `.env`, and restart Docker.

### 1.3 Verify Application Started

```bash
curl http://localhost:8008/health
```

**Expected:** `{"status":"ok"}`

---

## Part 2: Database Preparation (MCP Supabase)

### 2.1 Create Test Contacts

Use MCP Supabase to insert test contacts:

```sql
-- Insert 3 test contacts with different scenarios
INSERT INTO contacts (
    id,
    email,
    name,
    phone_number,
    domain_id,
    page_id,
    brevo_sync_status,
    brevo_processing_status,
    brevo_processing_error,
    brevo_contact_id,
    retry_count,
    next_retry_at,
    created_at,
    updated_at
) VALUES
-- Test Contact 1: Fresh contact, never synced
(
    gen_random_uuid(),
    'test-fresh@scrapersky-test.com',
    'Fresh Test Contact',
    '+1-555-0101',
    NULL,
    NULL,
    'Queued',      -- User queued for sync
    'Queued',      -- System ready to process
    NULL,
    NULL,
    0,
    NULL,
    NOW(),
    NOW()
),
-- Test Contact 2: Contact with domain/page metadata
(
    gen_random_uuid(),
    'test-metadata@scrapersky-test.com',
    'Contact With Metadata',
    '+1-555-0202',
    (SELECT id FROM domains LIMIT 1),  -- Links to real domain (if exists)
    (SELECT id FROM pages LIMIT 1),    -- Links to real page (if exists)
    'Queued',
    'Queued',
    NULL,
    NULL,
    0,
    NULL,
    NOW(),
    NOW()
),
-- Test Contact 3: Simple email only
(
    gen_random_uuid(),
    'test-simple@scrapersky-test.com',
    NULL,  -- No name
    NULL,  -- No phone
    NULL,
    NULL,
    'Queued',
    'Queued',
    NULL,
    NULL,
    0,
    NULL,
    NOW(),
    NOW()
);
```

### 2.2 Verify Test Contacts Created

```sql
SELECT
    id,
    email,
    name,
    brevo_sync_status,
    brevo_processing_status,
    retry_count,
    created_at
FROM contacts
WHERE email LIKE '%@scrapersky-test.com'
ORDER BY created_at DESC
LIMIT 10;
```

**Expected:** 3 rows returned with `brevo_sync_status = 'Queued'` and `brevo_processing_status = 'Queued'`

### 2.3 Save Contact IDs for Testing

Copy the UUIDs from the query above. You'll need them for manual testing.

```bash
# Example (replace with your actual UUIDs):
CONTACT_1_ID=12345678-1234-1234-1234-123456789abc
CONTACT_2_ID=23456789-2345-2345-2345-234567890abc
CONTACT_3_ID=34567890-3456-3456-3456-345678901abc
```

---

## Part 3: Manual Sync Test (Step 1 Verification)

This verifies the core service works independently before testing the scheduler.

### 3.1 Run Manual Sync Script

Create a test script to manually trigger sync:

**File:** `test_manual_brevo_sync.py`

```python
#!/usr/bin/env python3
"""
Manual test script for Brevo sync core service.
Tests Step 1 (core service) independently of scheduler.
"""

import asyncio
import sys
from uuid import UUID
from src.services.crm.brevo_sync_service import BrevoSyncService
from src.session.async_session import get_db_session
import logging

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)


async def test_manual_sync(contact_id: str):
    """Manually sync one contact to Brevo."""
    try:
        contact_uuid = UUID(contact_id)
    except ValueError:
        logger.error(f"‚ùå Invalid UUID: {contact_id}")
        return False

    service = BrevoSyncService()

    if not service.api_key:
        logger.error("‚ùå BREVO_API_KEY not configured in .env!")
        return False

    logger.info(f"üß™ Starting manual sync test for contact: {contact_id}")
    logger.info(f"üì° Brevo API Base URL: {service.base_url}")

    async for session in get_db_session():
        try:
            await service.process_single_contact(contact_uuid, session)
            logger.info("‚úÖ MANUAL SYNC COMPLETED SUCCESSFULLY!")
            return True
        except Exception as e:
            logger.exception(f"‚ùå MANUAL SYNC FAILED: {e}")
            return False


if __name__ == "__main__":
    if len(sys.argv) != 2:
        print("Usage: python test_manual_brevo_sync.py <contact_id>")
        sys.exit(1)

    contact_id = sys.argv[1]
    success = asyncio.run(test_manual_sync(contact_id))

    print("\n" + "=" * 80)
    print("VERIFICATION QUERIES (Run in MCP Supabase):")
    print("=" * 80)
    print(f"""
-- Check contact status after sync:
SELECT
    id,
    email,
    name,
    brevo_sync_status,
    brevo_processing_status,
    brevo_processing_error,
    brevo_contact_id,
    retry_count,
    updated_at
FROM contacts
WHERE id = '{contact_id}';

-- Expected if successful:
-- brevo_sync_status: 'Complete'
-- brevo_processing_status: 'Complete'
-- brevo_processing_error: NULL
-- brevo_contact_id: (email address)
-- retry_count: 0
""")

    sys.exit(0 if success else 1)
```

### 3.2 Execute Manual Sync

```bash
# Test Contact 1
python test_manual_brevo_sync.py $CONTACT_1_ID

# Wait 5 seconds
sleep 5

# Test Contact 2
python test_manual_brevo_sync.py $CONTACT_2_ID
```

### 3.3 Verify Manual Sync Results (MCP Supabase)

```sql
-- Check both contacts synced successfully
SELECT
    email,
    name,
    brevo_sync_status,
    brevo_processing_status,
    brevo_processing_error,
    brevo_contact_id,
    retry_count,
    updated_at
FROM contacts
WHERE email IN (
    'test-fresh@scrapersky-test.com',
    'test-metadata@scrapersky-test.com'
)
ORDER BY email;
```

**Expected Results:**
| email | brevo_sync_status | brevo_processing_status | brevo_processing_error | brevo_contact_id | retry_count |
|-------|-------------------|-------------------------|------------------------|------------------|-------------|
| test-fresh@... | Complete | Complete | NULL | test-fresh@... | 0 |
| test-metadata@... | Complete | Complete | NULL | test-metadata@... | 0 |

**‚úÖ Step 1 (Core Service) PASSED** if both contacts show `Complete` status.

---

## Part 4: Scheduler Test (Step 2 Verification)

This verifies the background scheduler automatically processes queued contacts.

### 4.1 Queue Contact 3 for Scheduler

Contact 3 should still be in `Queued` status. Verify:

```sql
SELECT email, brevo_sync_status, brevo_processing_status
FROM contacts
WHERE email = 'test-simple@scrapersky-test.com';
```

**Expected:** `brevo_sync_status = 'Queued'` and `brevo_processing_status = 'Queued'`

### 4.2 Monitor Docker Logs for Scheduler Activity

```bash
docker compose logs -f app
```

**Look for these log patterns every 2 minutes:**

```
[INFO] üöÄ Starting Brevo sync scheduler cycle
[INFO] üöÄ Starting Brevo sync for contact 34567890-3456-3456-3456-345678901abc
[INFO] ‚úÖ Brevo sync complete for contact 34567890-3456-3456-3456-345678901abc
[INFO] ‚úÖ Finished Brevo sync scheduler cycle
```

**Timing:** Scheduler runs every **2 minutes** (configured in `.env`), so you should see activity within 2-3 minutes.

### 4.3 Verify Scheduler Processed Contact 3 (MCP Supabase)

After seeing scheduler logs, check database:

```sql
SELECT
    email,
    brevo_sync_status,
    brevo_processing_status,
    brevo_processing_error,
    brevo_contact_id,
    retry_count,
    updated_at
FROM contacts
WHERE email = 'test-simple@scrapersky-test.com';
```

**Expected After Scheduler Run:**
| email | brevo_sync_status | brevo_processing_status | brevo_contact_id | retry_count |
|-------|-------------------|-------------------------|------------------|-------------|
| test-simple@... | Complete | Complete | test-simple@... | 0 |

**‚úÖ Step 2 (Scheduler) PASSED** if Contact 3 was automatically processed.

---

## Part 5: Retry Logic Test

Verify exponential backoff retry works correctly.

### 5.1 Create Contact with Invalid Email (Will Fail)

```sql
INSERT INTO contacts (
    id,
    email,
    name,
    brevo_sync_status,
    brevo_processing_status,
    retry_count,
    created_at,
    updated_at
) VALUES (
    gen_random_uuid(),
    'invalid-email-format',  -- Invalid: no @ symbol
    'Test Retry Logic',
    'Queued',
    'Queued',
    0,
    NOW(),
    NOW()
)
RETURNING id, email;
```

**Save the returned `id` for monitoring.**

### 5.2 Monitor Retry Behavior

The scheduler will attempt to sync this contact and fail. Check logs:

```bash
docker compose logs -f app | grep -A 5 "invalid-email-format"
```

**Expected Log Pattern:**

```
[ERROR] ‚ùå Failed to sync contact [...]: Contact has no email address
[INFO] Retry 1/3 scheduled in 1 minutes (exponential backoff)
```

### 5.3 Verify Retry State in Database (MCP Supabase)

```sql
SELECT
    email,
    brevo_sync_status,
    brevo_processing_status,
    brevo_processing_error,
    retry_count,
    next_retry_at,
    last_retry_at,
    last_failed_crm
FROM contacts
WHERE email = 'invalid-email-format';
```

**Expected After First Failure:**
| brevo_sync_status | brevo_processing_status | retry_count | next_retry_at | last_failed_crm |
|-------------------|-------------------------|-------------|---------------|-----------------|
| Queued | Error | 1 | NOW() + 1 minute | brevo |

### 5.4 Monitor Subsequent Retries

**Wait 1 minute** for retry #2. Check database again:

```sql
-- Should show retry_count = 2, next_retry_at = NOW() + 2 minutes
SELECT retry_count, next_retry_at FROM contacts WHERE email = 'invalid-email-format';
```

**Wait 2 more minutes** for retry #3:

```sql
-- Should show retry_count = 3, next_retry_at = NOW() + 4 minutes
SELECT retry_count, next_retry_at FROM contacts WHERE email = 'invalid-email-format';
```

**Wait 4 more minutes** for final retry:

```sql
-- After max retries (3), should show:
-- brevo_sync_status = 'Error' (permanent)
-- brevo_processing_status = 'Error'
-- retry_count = 3
-- next_retry_at = NULL (no more retries)
SELECT
    brevo_sync_status,
    brevo_processing_status,
    retry_count,
    next_retry_at
FROM contacts
WHERE email = 'invalid-email-format';
```

**Expected Exponential Backoff Delays:**
1. Retry 1 ‚Üí 2: **1 minute** (base delay)
2. Retry 2 ‚Üí 3: **2 minutes** (1 √ó 2^1)
3. Retry 3 ‚Üí Max: **4 minutes** (1 √ó 2^2)
4. After Retry 3: **Permanent Error** (no more retries)

**‚úÖ Retry Logic PASSED** if exponential backoff delays match expected pattern.

---

## Part 6: Brevo Dashboard Verification

Log into your Brevo account to verify contacts were actually created in Brevo.

### 6.1 Access Brevo Contacts Dashboard

1. Go to: https://app.brevo.com/
2. Navigate to: **Contacts** ‚Üí **All Contacts**

### 6.2 Search for Test Contacts

Search for: `@scrapersky-test.com`

**Expected Results:**

You should see **3 contacts** created:

| Email | First Name | Last Name | Attributes | Status |
|-------|------------|-----------|------------|--------|
| test-fresh@scrapersky-test.com | Fresh | Test Contact | SMS: +1-555-0101 | Active |
| test-metadata@scrapersky-test.com | Contact | With Metadata | SMS: +1-555-0202, DOMAIN_ID: [...], PAGE_ID: [...] | Active |
| test-simple@scrapersky-test.com | (empty) | (empty) | (none) | Active |

### 6.3 Verify Custom Attributes

Click on **test-metadata@scrapersky-test.com** to view details.

**Expected Custom Attributes:**
- `DOMAIN_ID`: UUID of linked domain
- `PAGE_ID`: UUID of linked page
- `SMS`: Phone number (if provided)

**‚úÖ Brevo Dashboard PASSED** if all 3 contacts appear in Brevo with correct data.

---

## Part 7: Error Handling Test (Optional)

Test invalid API key handling.

### 7.1 Temporarily Break API Key

Edit `.env`:

```bash
BREVO_API_KEY=xkeysib-INVALID_KEY_FOR_TESTING
```

Restart Docker:

```bash
docker compose down
docker compose up --build
```

### 7.2 Queue New Contact

```sql
INSERT INTO contacts (email, name, brevo_sync_status, brevo_processing_status, created_at, updated_at)
VALUES ('test-invalid-key@scrapersky-test.com', 'Invalid Key Test', 'Queued', 'Queued', NOW(), NOW())
RETURNING id;
```

### 7.3 Monitor Error Logs

```bash
docker compose logs -f app | grep -A 5 "401\|Unauthorized"
```

**Expected:**
```
[ERROR] ‚ùå Brevo API authentication failed (HTTP 401)
[INFO] Retry 1/3 scheduled in 1 minutes
```

### 7.4 Verify Error State

```sql
SELECT
    email,
    brevo_processing_error
FROM contacts
WHERE email = 'test-invalid-key@scrapersky-test.com';
```

**Expected:** `brevo_processing_error` contains "401" or "Unauthorized"

### 7.5 Restore Valid API Key

Edit `.env` back to valid key and restart:

```bash
BREVO_API_KEY=xkeysib-YOUR_REAL_KEY_HERE
```

```bash
docker compose down
docker compose up --build
```

**Expected:** Contact should sync successfully on next retry.

**‚úÖ Error Handling PASSED** if invalid key triggers proper error and retry logic.

---

## Part 8: Cleanup

### 8.1 Delete Test Contacts from Database

```sql
-- Delete test contacts from ScraperSky database
DELETE FROM contacts
WHERE email LIKE '%@scrapersky-test.com'
OR email = 'invalid-email-format';
```

### 8.2 Delete Test Contacts from Brevo

**Option A: Via Brevo Dashboard**
1. Go to Contacts ‚Üí All Contacts
2. Search: `@scrapersky-test.com`
3. Select all ‚Üí Delete

**Option B: Via API (if you prefer)**
```bash
curl -X DELETE \
  https://api.brevo.com/v3/contacts/test-fresh@scrapersky-test.com \
  -H "api-key: xkeysib-YOUR_API_KEY"

curl -X DELETE \
  https://api.brevo.com/v3/contacts/test-metadata@scrapersky-test.com \
  -H "api-key: xkeysib-YOUR_API_KEY"

curl -X DELETE \
  https://api.brevo.com/v3/contacts/test-simple@scrapersky-test.com \
  -H "api-key: xkeysib-YOUR_API_KEY"
```

### 8.3 Restore Production Configuration

Edit `.env` back to production values:

```bash
BREVO_SYNC_SCHEDULER_INTERVAL_MINUTES=5  # Back to 5 min
BREVO_SYNC_SCHEDULER_BATCH_SIZE=10       # Back to 10
BREVO_SYNC_RETRY_DELAY_MINUTES=5         # Back to 5 min
```

Restart:

```bash
docker compose down
docker compose up --build
```

---

## Part 9: Test Report Template

Fill out this template after completing all tests:

```markdown
# WO-015 Phase 2 Integration Test Report

**Tester:** [Your Name]
**Date:** [YYYY-MM-DD]
**Environment:** Docker Compose (Local)
**Brevo Account:** [Your Brevo email]

## Test Results Summary

| Test Category | Status | Notes |
|---------------|--------|-------|
| Environment Setup | ‚¨ú PASS / ‚¨ú FAIL | |
| Database Preparation | ‚¨ú PASS / ‚¨ú FAIL | |
| Manual Sync (Step 1) | ‚¨ú PASS / ‚¨ú FAIL | |
| Scheduler (Step 2) | ‚¨ú PASS / ‚¨ú FAIL | |
| Retry Logic | ‚¨ú PASS / ‚¨ú FAIL | |
| Brevo Dashboard | ‚¨ú PASS / ‚¨ú FAIL | |
| Error Handling | ‚¨ú PASS / ‚¨ú FAIL | |

## Detailed Results

### Part 3: Manual Sync Test
- Contact 1 (Fresh): ‚¨ú PASS / ‚¨ú FAIL
  - Error (if any):
- Contact 2 (Metadata): ‚¨ú PASS / ‚¨ú FAIL
  - Error (if any):

### Part 4: Scheduler Test
- Contact 3 processed automatically: ‚¨ú PASS / ‚¨ú FAIL
- Scheduler interval correct (2 min): ‚¨ú PASS / ‚¨ú FAIL
- Logs show proper cycle: ‚¨ú PASS / ‚¨ú FAIL

### Part 5: Retry Logic Test
- Exponential backoff delays correct: ‚¨ú PASS / ‚¨ú FAIL
  - Retry 1‚Üí2: _____ minutes (expected: 1)
  - Retry 2‚Üí3: _____ minutes (expected: 2)
  - Retry 3‚Üímax: _____ minutes (expected: 4)
- Final state after max retries: ‚¨ú PASS / ‚¨ú FAIL

### Part 6: Brevo Dashboard
- All 3 contacts visible: ‚¨ú PASS / ‚¨ú FAIL
- Custom attributes correct: ‚¨ú PASS / ‚¨ú FAIL
- Names/emails match: ‚¨ú PASS / ‚¨ú FAIL

## Issues Encountered

[Describe any issues, errors, or unexpected behavior]

## Overall Assessment

‚¨ú **READY FOR PRODUCTION** - All tests passed
‚¨ú **NEEDS FIXES** - Some tests failed (see details above)
‚¨ú **BLOCKED** - Cannot complete testing (explain why)

## Recommendations

[Any suggestions for improvements or concerns]

---

**Signature:** ___________________
**Date:** ___________________
```

---

## Expected Overall Timeline

| Phase | Duration | Description |
|-------|----------|-------------|
| Part 1: Setup | 10-15 min | Configure .env, start Docker |
| Part 2: Database Prep | 5 min | Create test contacts |
| Part 3: Manual Sync | 10 min | Test core service |
| Part 4: Scheduler | 10 min | Wait for automatic sync (2 min intervals) |
| Part 5: Retry Logic | 15-20 min | Wait for exponential backoff retries |
| Part 6: Brevo Verification | 5 min | Check Brevo dashboard |
| Part 7: Error Handling | 10 min | Optional - test invalid key |
| Part 8: Cleanup | 5 min | Delete test data |
| **TOTAL** | **70-90 min** | Full comprehensive test |

---

## Quick Reference: Common MCP Queries

```sql
-- View all queued contacts ready for sync
SELECT id, email, name, brevo_sync_status, brevo_processing_status, next_retry_at
FROM contacts
WHERE brevo_processing_status = 'Queued'
AND (next_retry_at IS NULL OR next_retry_at <= NOW())
ORDER BY updated_at ASC
LIMIT 10;

-- View recent sync activity (last 24 hours)
SELECT
    email,
    brevo_sync_status,
    brevo_processing_status,
    retry_count,
    updated_at
FROM contacts
WHERE updated_at > NOW() - INTERVAL '24 hours'
AND brevo_sync_status IS NOT NULL
ORDER BY updated_at DESC
LIMIT 20;

-- Count contacts by status
SELECT
    brevo_sync_status,
    brevo_processing_status,
    COUNT(*) as count
FROM contacts
WHERE brevo_sync_status IS NOT NULL
GROUP BY brevo_sync_status, brevo_processing_status
ORDER BY count DESC;

-- View contacts with errors
SELECT
    id,
    email,
    brevo_processing_error,
    retry_count,
    next_retry_at,
    last_failed_crm
FROM contacts
WHERE brevo_processing_status = 'Error'
ORDER BY updated_at DESC
LIMIT 10;
```

---

## Troubleshooting Guide

### Issue: Scheduler not starting

**Symptom:** Warning log: "BREVO_API_KEY not configured"

**Solution:**
1. Check `.env` file has `BREVO_API_KEY=xkeysib-...`
2. Restart Docker: `docker compose down && docker compose up --build`
3. Check logs for "‚úÖ Brevo sync scheduler job registered successfully"

### Issue: Manual sync fails with 401

**Symptom:** "Brevo API authentication failed (HTTP 401)"

**Solution:**
1. Verify API key is correct in `.env`
2. Log into Brevo dashboard ‚Üí Settings ‚Üí API Keys
3. Copy fresh API key and update `.env`
4. Restart Docker

### Issue: Contacts not syncing automatically

**Symptom:** Contacts stay in `Queued` status for >5 minutes

**Solution:**
1. Check scheduler logs: `docker compose logs -f app | grep "Brevo sync"`
2. Verify `next_retry_at` is NULL or past: `SELECT next_retry_at FROM contacts WHERE ...`
3. Check batch size hasn't been exceeded (default: 5 in test config)
4. Restart scheduler: `docker compose restart app`

### Issue: Retry delays not working

**Symptom:** Retries happening too fast or not at all

**Solution:**
1. Check `BREVO_SYNC_RETRY_DELAY_MINUTES` in `.env` (should be 1 for testing)
2. Check `BREVO_SYNC_RETRY_EXPONENTIAL` is `true`
3. Verify `next_retry_at` is being set: `SELECT next_retry_at FROM contacts WHERE retry_count > 0`
4. Check scheduler interval isn't too long

### Issue: Contacts created in Brevo but not showing in dashboard

**Symptom:** Database shows `Complete` but Brevo dashboard empty

**Solution:**
1. Wait 30-60 seconds for Brevo indexing
2. Clear browser cache
3. Use Brevo API to verify:
   ```bash
   curl -X GET \
     https://api.brevo.com/v3/contacts/test-fresh@scrapersky-test.com \
     -H "api-key: xkeysib-YOUR_KEY"
   ```

---

## Success Criteria Checklist

Mark each when complete:

- [ ] Docker stack starts without errors
- [ ] Scheduler registers successfully (log shows "‚úÖ Brevo sync scheduler job registered")
- [ ] Manual sync of Contact 1 succeeds (status ‚Üí Complete)
- [ ] Manual sync of Contact 2 succeeds (status ‚Üí Complete)
- [ ] Scheduler automatically processes Contact 3 within 2-3 minutes
- [ ] All 3 contacts visible in Brevo dashboard
- [ ] Invalid email triggers retry logic (retry_count increments)
- [ ] Exponential backoff delays are correct (1 min ‚Üí 2 min ‚Üí 4 min)
- [ ] After max retries, contact marked as permanent Error
- [ ] Custom attributes (DOMAIN_ID, PAGE_ID) sync correctly
- [ ] Error handling works for invalid API key (401 error logged)

**If all checkboxes marked:** ‚úÖ **WO-015 PHASE 2 COMPLETE AND VALIDATED**

---

## Document Control

**Version History:**
- 1.0 (2025-11-18): Initial test plan created for local Claude testing

**Related Documents:**
- WO-015.8: Phase 2 Implementation Plan
- WO-015.9: Manual Test Guide (Step 1 only)
- WO-015.10: This document (Complete integration test)

**Approval:**
- Technical Author: Claude (Agent)
- Review Status: Pending user validation

---

**END OF TEST PLAN**
