# WO-015.6: Frontend Integration Guide - CRM Sync Selection

**Created:** 2025-01-18  
**For:** Frontend Developer  
**Backend Status:** Phase 1 Complete (Selection endpoints deployed)  
**Estimated Frontend Effort:** 4-6 hours

---

## Executive Summary

Add CRM sync selection capabilities to the Contact Launchpad, allowing users to mark contacts for sync to Brevo, HubSpot, Mautic, and n8n. This guide provides complete API documentation, UI/UX recommendations, and implementation examples.

---

## What's Been Built (Backend)

### New API Endpoint: Multi-CRM Selection

**Endpoint:** `PUT /api/v3/contacts/crm/select`

**Purpose:** Mark contacts for sync to one or more CRM platforms

**Request:**
```json
{
  "contact_ids": ["uuid1", "uuid2", "uuid3"],
  "crms": ["brevo", "hubspot", "mautic", "n8n"],
  "action": "select"  // or "unselect"
}
```

**Response:**
```json
{
  "updated_count": 3,
  "crms": ["brevo", "hubspot"],
  "action": "select",
  "message": "Selected 3 contacts for 2 CRM(s)"
}
```

**Authentication:** Bearer token (same as existing endpoints)

---

### Updated API Endpoint: Contact Filtering

**Endpoint:** `GET /api/v3/contacts`

**New Query Parameters:**
- `brevo_sync_status` (optional) - Values: `New`, `Selected`, `Queued`, `Processing`, `Complete`, `Error`, `Skipped`
- `mautic_sync_status` (optional) - Same values
- `n8n_sync_status` (optional) - Same values
- `hubspot_sync_status` (optional) - Same values

**Example:**
```
GET /api/v3/contacts?brevo_sync_status=Selected&limit=50
```

---

### Contact Model Updates

Each contact now has these additional fields:

```typescript
interface Contact {
  // ... existing fields ...
  
  // Brevo
  brevo_sync_status: CRMSyncStatus;
  brevo_processing_status: CRMProcessingStatus | null;
  brevo_processing_error: string | null;
  brevo_contact_id: string | null;
  
  // Mautic
  mautic_sync_status: CRMSyncStatus;
  mautic_processing_status: CRMProcessingStatus | null;
  mautic_processing_error: string | null;
  mautic_contact_id: string | null;
  
  // n8n
  n8n_sync_status: CRMSyncStatus;
  n8n_processing_status: CRMProcessingStatus | null;
  n8n_processing_error: string | null;
  n8n_workflow_id: string | null;
  
  // HubSpot (existing, now with contact_id)
  hubspot_sync_status: CRMSyncStatus;
  hubspot_processing_status: CRMProcessingStatus | null;
  hubspot_processing_error: string | null;
  hubspot_contact_id: string | null;
  
  // Retry tracking (shared across all CRMs)
  retry_count: number;
  last_retry_at: string | null;
  next_retry_at: string | null;
  last_failed_crm: string | null;
}

type CRMSyncStatus = 'New' | 'Selected' | 'Queued' | 'Processing' | 'Complete' | 'Error' | 'Skipped';
type CRMProcessingStatus = 'Queued' | 'Processing' | 'Complete' | 'Error';
```

---

## UI/UX Design Recommendations

### Option 1: Multi-Select Dropdown (Recommended)

**Location:** Add to "Bulk Update Operations" section

**Visual Design:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Bulk Update Operations                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [-- Select Status --â–¼]  [Update Selected (0)]       â”‚
â”‚                                                      â”‚
â”‚ [ğŸ”„ Sync to CRM â–¼]  [Sync Selected (0)]            â”‚
â”‚   â”œâ”€ â˜ Brevo                                        â”‚
â”‚   â”œâ”€ â˜ HubSpot                                      â”‚
â”‚   â”œâ”€ â˜ Mautic                                       â”‚
â”‚   â””â”€ â˜ n8n                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Features:**
- Multi-select checkboxes for CRMs
- Shows count of selected contacts
- One-click sync to multiple CRMs
- Clear visual separation from status updates

**Implementation:**
```tsx
<div className="bulk-operations">
  <select>
    <option>-- Select Status --</option>
    <option>New</option>
    <option>Selected</option>
    {/* ... */}
  </select>
  <button>Update Selected (0)</button>
  
  <div className="crm-sync-dropdown">
    <button className="dropdown-toggle">
      ğŸ”„ Sync to CRM â–¼
    </button>
    <div className="dropdown-menu">
      <label><input type="checkbox" value="brevo" /> Brevo</label>
      <label><input type="checkbox" value="hubspot" /> HubSpot</label>
      <label><input type="checkbox" value="mautic" /> Mautic</label>
      <label><input type="checkbox" value="n8n" /> n8n</label>
    </div>
  </div>
  <button onClick={handleSyncToCRM}>
    Sync Selected ({selectedContacts.length})
  </button>
</div>
```

---

### Option 2: Individual CRM Buttons

**Location:** Add to "Bulk Update Operations" section

**Visual Design:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Bulk Update Operations                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [-- Select Status --â–¼]  [Update Selected (0)]       â”‚
â”‚                                                      â”‚
â”‚ Sync to CRM:                                        â”‚
â”‚ [ğŸ“§ Brevo] [ğŸ”¶ HubSpot] [ğŸ“Š Mautic] [âš¡ n8n]        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Features:**
- Quick one-click sync to specific CRM
- Visual icons for each CRM
- Simpler UX (no dropdown)
- Can sync to multiple CRMs by clicking multiple buttons

---

### Option 3: CRM Status Column (Advanced)

**Location:** Add new column to contact table

**Visual Design:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Name          | Curation | HubSpot | CRM Sync               â”‚
â”‚               | Status   | Sync    |                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Contact at... | New      | New     | B:New H:New M:New N:Newâ”‚
â”‚ Business...   | New      | New     | B:âœ“ H:New M:New N:New  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Legend: B=Brevo, H=HubSpot, M=Mautic, N=n8n
âœ“ = Selected/Queued/Complete
â³ = Processing
âŒ = Error
```

**Features:**
- See all CRM statuses at a glance
- Click to toggle individual CRM selection
- Most information-dense option
- More complex to implement

---

## Recommended Implementation (Option 1)

### Step 1: Add State Management

```tsx
// In your Contact Launchpad component
const [selectedCRMs, setSelectedCRMs] = useState<string[]>([]);
const [isSyncing, setIsSyncing] = useState(false);

const handleCRMToggle = (crm: string) => {
  setSelectedCRMs(prev => 
    prev.includes(crm) 
      ? prev.filter(c => c !== crm)
      : [...prev, crm]
  );
};
```

---

### Step 2: Add Sync Function

```tsx
const handleSyncToCRM = async () => {
  if (selectedContacts.length === 0) {
    toast.error('Please select contacts first');
    return;
  }
  
  if (selectedCRMs.length === 0) {
    toast.error('Please select at least one CRM');
    return;
  }
  
  setIsSyncing(true);
  
  try {
    const response = await fetch(
      `${API_BASE_URL}/api/v3/contacts/crm/select`,
      {
        method: 'PUT',
        headers: {
          'Authorization': `Bearer ${authToken}`,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          contact_ids: selectedContacts.map(c => c.id),
          crms: selectedCRMs,
          action: 'select'
        })
      }
    );
    
    const data = await response.json();
    
    if (response.ok) {
      toast.success(data.message);
      // Refresh contact list to show updated statuses
      await refreshContacts();
      // Clear selections
      setSelectedContacts([]);
      setSelectedCRMs([]);
    } else {
      toast.error(data.detail || 'Failed to sync contacts');
    }
  } catch (error) {
    console.error('Sync error:', error);
    toast.error('Network error - please try again');
  } finally {
    setIsSyncing(false);
  }
};
```

---

### Step 3: Add UI Components

```tsx
<div className="bulk-operations">
  {/* Existing status update dropdown */}
  <select value={selectedStatus} onChange={handleStatusChange}>
    <option>-- Select Status --</option>
    <option>New</option>
    <option>Selected</option>
    <option>Skipped</option>
    <option>Error</option>
  </select>
  <button onClick={handleBulkStatusUpdate}>
    Update Selected ({selectedContacts.length})
  </button>
  
  {/* NEW: CRM Sync Section */}
  <div className="crm-sync-section">
    <div className="crm-selector">
      <label className="crm-checkbox">
        <input 
          type="checkbox" 
          checked={selectedCRMs.includes('brevo')}
          onChange={() => handleCRMToggle('brevo')}
        />
        <span className="crm-icon">ğŸ“§</span> Brevo
      </label>
      
      <label className="crm-checkbox">
        <input 
          type="checkbox" 
          checked={selectedCRMs.includes('hubspot')}
          onChange={() => handleCRMToggle('hubspot')}
        />
        <span className="crm-icon">ğŸ”¶</span> HubSpot
      </label>
      
      <label className="crm-checkbox">
        <input 
          type="checkbox" 
          checked={selectedCRMs.includes('mautic')}
          onChange={() => handleCRMToggle('mautic')}
        />
        <span className="crm-icon">ğŸ“Š</span> Mautic
      </label>
      
      <label className="crm-checkbox">
        <input 
          type="checkbox" 
          checked={selectedCRMs.includes('n8n')}
          onChange={() => handleCRMToggle('n8n')}
        />
        <span className="crm-icon">âš¡</span> n8n
      </label>
    </div>
    
    <button 
      onClick={handleSyncToCRM}
      disabled={isSyncing || selectedContacts.length === 0 || selectedCRMs.length === 0}
      className="sync-button"
    >
      {isSyncing ? 'Syncing...' : `Sync Selected (${selectedContacts.length})`}
    </button>
  </div>
</div>
```

---

### Step 4: Add Styling (Example)

```css
.crm-sync-section {
  display: flex;
  align-items: center;
  gap: 1rem;
  margin-top: 1rem;
  padding: 1rem;
  background: rgba(255, 255, 255, 0.05);
  border-radius: 8px;
}

.crm-selector {
  display: flex;
  gap: 1rem;
  flex-wrap: wrap;
}

.crm-checkbox {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem 1rem;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 6px;
  cursor: pointer;
  transition: background 0.2s;
}

.crm-checkbox:hover {
  background: rgba(255, 255, 255, 0.15);
}

.crm-checkbox input[type="checkbox"] {
  cursor: pointer;
}

.crm-icon {
  font-size: 1.2rem;
}

.sync-button {
  padding: 0.75rem 1.5rem;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
  border-radius: 6px;
  font-weight: 600;
  cursor: pointer;
  transition: transform 0.2s, opacity 0.2s;
}

.sync-button:hover:not(:disabled) {
  transform: translateY(-2px);
}

.sync-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}
```

---

## Visual Status Indicators (Optional Enhancement)

### Show CRM Sync Status in Table

Add a visual indicator column showing which CRMs each contact is synced to:

```tsx
// In your contact table row
<td className="crm-status-cell">
  <div className="crm-badges">
    {contact.brevo_sync_status !== 'New' && (
      <span className={`crm-badge brevo ${contact.brevo_sync_status.toLowerCase()}`}>
        B
      </span>
    )}
    {contact.hubspot_sync_status !== 'New' && (
      <span className={`crm-badge hubspot ${contact.hubspot_sync_status.toLowerCase()}`}>
        H
      </span>
    )}
    {contact.mautic_sync_status !== 'New' && (
      <span className={`crm-badge mautic ${contact.mautic_sync_status.toLowerCase()}`}>
        M
      </span>
    )}
    {contact.n8n_sync_status !== 'New' && (
      <span className={`crm-badge n8n ${contact.n8n_sync_status.toLowerCase()}`}>
        N
      </span>
    )}
  </div>
</td>
```

**Styling:**
```css
.crm-badges {
  display: flex;
  gap: 0.25rem;
}

.crm-badge {
  display: inline-block;
  width: 20px;
  height: 20px;
  line-height: 20px;
  text-align: center;
  border-radius: 50%;
  font-size: 0.7rem;
  font-weight: bold;
  color: white;
}

.crm-badge.selected {
  background: #3b82f6; /* Blue */
}

.crm-badge.queued {
  background: #f59e0b; /* Orange */
}

.crm-badge.processing {
  background: #8b5cf6; /* Purple */
  animation: pulse 2s infinite;
}

.crm-badge.complete {
  background: #10b981; /* Green */
}

.crm-badge.error {
  background: #ef4444; /* Red */
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}
```

---

## Error Handling

### API Error Responses

**400 Bad Request - Invalid CRM Name:**
```json
{
  "detail": "Invalid CRM names: {'invalid_crm'}. Valid: {'brevo', 'mautic', 'n8n', 'hubspot'}"
}
```

**404 Not Found - No Contacts:**
```json
{
  "detail": "No contacts found with provided IDs"
}
```

**401 Unauthorized:**
```json
{
  "error": true,
  "message": "Invalid authentication credentials",
  "status_code": 401
}
```

### Frontend Error Handling

```tsx
try {
  const response = await fetch(/* ... */);
  const data = await response.json();
  
  if (!response.ok) {
    // Handle specific error codes
    if (response.status === 400) {
      toast.error('Invalid CRM selection');
    } else if (response.status === 404) {
      toast.error('Selected contacts not found');
    } else if (response.status === 401) {
      toast.error('Session expired - please log in again');
      // Redirect to login
    } else {
      toast.error(data.detail || 'Failed to sync contacts');
    }
    return;
  }
  
  // Success handling
  toast.success(data.message);
} catch (error) {
  console.error('Sync error:', error);
  toast.error('Network error - please try again');
}
```

---

## Testing Checklist for Frontend

### Basic Functionality
- [ ] CRM checkboxes toggle correctly
- [ ] Sync button enables/disables based on selections
- [ ] API call succeeds with valid data
- [ ] Success toast appears after sync
- [ ] Contact list refreshes to show updated statuses
- [ ] Selections clear after successful sync

### Edge Cases
- [ ] Sync with no contacts selected shows error
- [ ] Sync with no CRMs selected shows error
- [ ] Sync with invalid contact IDs shows error
- [ ] Network error shows appropriate message
- [ ] Loading state prevents double-clicks

### Visual Feedback
- [ ] Loading spinner/text during sync
- [ ] CRM badges show correct status colors
- [ ] Status updates reflect in table immediately
- [ ] Tooltips explain CRM status meanings

### Multi-CRM Scenarios
- [ ] Can select multiple CRMs at once
- [ ] Can sync same contacts to different CRMs
- [ ] Can unselect contacts from specific CRMs

---

## API Documentation Reference

**FastAPI Docs:** Available at `https://scrapersky-backend.onrender.com/docs`

**Relevant Endpoints:**
- `PUT /api/v3/contacts/crm/select` - Mark contacts for CRM sync
- `GET /api/v3/contacts` - List contacts with CRM filters
- `GET /api/v3/contacts/{id}` - Get single contact with all CRM statuses

---

## Future Enhancements (Phase 2+)

### Automatic Sync Status Updates
Once Phase 2 (Brevo sync service) is deployed:
- Contacts will automatically transition from `Selected` â†’ `Queued` â†’ `Processing` â†’ `Complete`
- Frontend should poll or use WebSockets to show real-time status updates
- Add progress indicators for processing contacts

### Bulk Unselect
```tsx
// Add unselect functionality
const handleUnsyncFromCRM = async () => {
  await fetch('/api/v3/contacts/crm/select', {
    method: 'PUT',
    body: JSON.stringify({
      contact_ids: selectedContacts.map(c => c.id),
      crms: selectedCRMs,
      action: 'unselect'  // Changed from 'select'
    })
  });
};
```

### Filtering by CRM Status
Add filter dropdowns:
```tsx
<select onChange={(e) => setBrevoFilter(e.target.value)}>
  <option value="">All Brevo Statuses</option>
  <option value="New">New</option>
  <option value="Selected">Selected</option>
  <option value="Complete">Complete</option>
  <option value="Error">Error</option>
</select>
```

---

## Questions for Frontend Developer

1. **UI Preference:** Which option (1, 2, or 3) fits best with your existing design system?
2. **Status Display:** Do you want CRM status badges in the table, or just in a detail view?
3. **Bulk Operations:** Should CRM sync be in the same section as status updates, or separate?
4. **Confirmation:** Do you want a confirmation modal before syncing, or direct action?
5. **Undo:** Should there be an "undo" option after syncing?

---

## Support & Questions

**Backend Developer:** Local Claude (Windsurf IDE)  
**Documentation:** This file + FastAPI docs at `/docs` endpoint  
**Test Contacts:** 5 test contacts created in database (see WO-015.5.1 for IDs)

**Need Help?**
- Check FastAPI docs for exact request/response formats
- Test endpoint with curl/Postman before implementing
- Ask about any unclear status transitions or edge cases

---

**Status:** âœ… Ready for Frontend Implementation  
**Backend Deployment:** â¸ï¸ Pending (code in main, needs Render deploy)  
**Estimated Frontend Time:** 4-6 hours
