# WO-015.5.1: Phase 1 Testing Plan - Complete Test Suite

**Created:** 2025-01-18
**Status:** Ready for Execution
**Tester:** Local Claude (Windsurf IDE + MCP Supabase)
**Estimated Time:** 30-45 minutes

---

## Purpose

This document provides a complete, step-by-step testing plan for WO-015 Phase 1 (CRM Selection Endpoints). Local Claude will execute all tests and verify results using MCP access to Supabase.

---

## Prerequisites

### Environment
- [x] Application running (local or deployed)
- [x] MCP Supabase connection available
- [x] JWT authentication token available
- [x] curl or similar HTTP client available

### Test Data Requirements
- **Minimum:** 5 test contacts in database
- **Domains:** At least 2 test domains
- **Pages:** At least 2 test pages

---

## Test Setup (10 minutes)

### Step 1: Verify Database Connection

**Action:** Use MCP to query database
```sql
-- Verify connection
SELECT COUNT(*) as total_contacts FROM contacts;
```

**Expected Result:** Query succeeds, returns count

**Pass Criteria:** ✅ Query executes without errors

---

### Step 2: Create Test Contacts

**Action:** Use MCP to create 5 test contacts

```sql
-- Get test domain and page IDs first
SELECT id as domain_id FROM domains LIMIT 1;
SELECT id as page_id FROM pages LIMIT 1;

-- Create 5 test contacts (replace <domain_id> and <page_id> with actual UUIDs from above)
INSERT INTO contacts (
    domain_id,
    page_id,
    email,
    name,
    email_type,
    contact_curation_status,
    hubspot_sync_status,
    brevo_sync_status,
    mautic_sync_status,
    n8n_sync_status,
    retry_count
) VALUES
    ('<domain_id>', '<page_id>', 'test1@example.com', 'Test Contact 1', 'CORPORATE', 'New', 'New', 'New', 'New', 'New', 0),
    ('<domain_id>', '<page_id>', 'test2@example.com', 'Test Contact 2', 'CORPORATE', 'New', 'New', 'New', 'New', 'New', 0),
    ('<domain_id>', '<page_id>', 'test3@example.com', 'Test Contact 3', 'FREE', 'New', 'New', 'New', 'New', 'New', 0),
    ('<domain_id>', '<page_id>', 'test4@example.com', 'Test Contact 4', 'SERVICE', 'New', 'New', 'New', 'New', 'New', 0),
    ('<domain_id>', '<page_id>', 'test5@example.com', 'Test Contact 5', 'CORPORATE', 'New', 'New', 'New', 'New', 'New', 0)
RETURNING id, email;
```

**Expected Result:** 5 contacts created, IDs returned

**Pass Criteria:** ✅ All 5 contacts inserted successfully

**Save for Later:** Copy the returned UUIDs - you'll need them for API tests

---

### Step 3: Verify Test Contacts Created

**Action:** Query to confirm test contacts exist
```sql
SELECT
    id,
    email,
    name,
    brevo_sync_status,
    mautic_sync_status,
    n8n_sync_status,
    hubspot_sync_status
FROM contacts
WHERE email LIKE 'test%@example.com'
ORDER BY email;
```

**Expected Result:** 5 contacts listed, all CRM statuses = 'New'

**Pass Criteria:**
- ✅ 5 contacts found
- ✅ All brevo_sync_status = 'New'
- ✅ All mautic_sync_status = 'New'
- ✅ All n8n_sync_status = 'New'
- ✅ All hubspot_sync_status = 'New'

---

## Test Suite (25-35 minutes)

### Test 1: List Contacts Endpoint (Baseline)

**Objective:** Verify existing list endpoint still works

**Action:** Call list endpoint without filters
```bash
curl -X GET "http://localhost:8000/api/v3/contacts?limit=10" \
  -H "Authorization: Bearer $JWT_TOKEN" \
  -H "Content-Type: application/json"
```

**Expected Result:**
- Status: 200 OK
- Body: Array of contacts
- Should include test contacts

**Pass Criteria:**
- ✅ Status code = 200
- ✅ Response is valid JSON array
- ✅ At least 5 contacts returned
- ✅ Test contacts present in results

**Failure Actions:**
- If 401: Check JWT token validity
- If 500: Check application logs for errors
- If empty: Verify test contacts were created

---

### Test 2: Filter by Brevo Sync Status (New Feature)

**Objective:** Verify new Brevo filter parameter works

**Action:** Call list endpoint with brevo_sync_status filter
```bash
curl -X GET "http://localhost:8000/api/v3/contacts?brevo_sync_status=New&limit=100" \
  -H "Authorization: Bearer $JWT_TOKEN" \
  -H "Content-Type: application/json"
```

**Expected Result:**
- Status: 200 OK
- Body: Array of contacts where brevo_sync_status = 'New'
- Should include all 5 test contacts

**Pass Criteria:**
- ✅ Status code = 200
- ✅ All returned contacts have brevo_sync_status = 'New'
- ✅ Test contacts included

**Database Verification:**
```sql
SELECT COUNT(*) FROM contacts WHERE brevo_sync_status = 'New';
```
**Verify:** API count matches database count

---

### Test 3: Filter by Mautic Sync Status (New Feature)

**Objective:** Verify new Mautic filter parameter works

**Action:**
```bash
curl -X GET "http://localhost:8000/api/v3/contacts?mautic_sync_status=New&limit=100" \
  -H "Authorization: Bearer $JWT_TOKEN" \
  -H "Content-Type: application/json"
```

**Expected Result:**
- Status: 200 OK
- All returned contacts have mautic_sync_status = 'New'

**Pass Criteria:**
- ✅ Status code = 200
- ✅ Correct filtering applied

---

### Test 4: Filter by n8n Sync Status (New Feature)

**Objective:** Verify new n8n filter parameter works

**Action:**
```bash
curl -X GET "http://localhost:8000/api/v3/contacts?n8n_sync_status=New&limit=100" \
  -H "Authorization: Bearer $JWT_TOKEN" \
  -H "Content-Type: application/json"
```

**Expected Result:**
- Status: 200 OK
- All returned contacts have n8n_sync_status = 'New'

**Pass Criteria:**
- ✅ Status code = 200
- ✅ Correct filtering applied

---

### Test 5: Select Contacts for Single CRM (Brevo)

**Objective:** Mark contacts for Brevo sync using new endpoint

**Action:** Select 2 test contacts for Brevo
```bash
curl -X PUT "http://localhost:8000/api/v3/contacts/crm/select" \
  -H "Authorization: Bearer $JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "contact_ids": ["<test_contact_1_id>", "<test_contact_2_id>"],
    "crms": ["brevo"],
    "action": "select"
  }'
```

**Expected Result:**
```json
{
  "updated_count": 2,
  "crms": ["brevo"],
  "action": "select",
  "message": "Selected 2 contacts for 1 CRM(s)"
}
```

**Pass Criteria:**
- ✅ Status code = 200
- ✅ updated_count = 2
- ✅ crms = ["brevo"]
- ✅ action = "select"

**Database Verification:**
```sql
SELECT
    id,
    email,
    brevo_sync_status,
    brevo_processing_status,
    mautic_sync_status,
    hubspot_sync_status,
    n8n_sync_status
FROM contacts
WHERE id IN ('<test_contact_1_id>', '<test_contact_2_id>');
```

**Verify:**
- ✅ brevo_sync_status = 'Selected' (changed)
- ✅ brevo_processing_status = NULL (not queued yet - service not implemented)
- ✅ mautic_sync_status = 'New' (unchanged)
- ✅ hubspot_sync_status = 'New' (unchanged)
- ✅ n8n_sync_status = 'New' (unchanged)

---

### Test 6: Select Contacts for Multiple CRMs

**Objective:** Select same contacts for multiple CRMs simultaneously

**Action:** Select test_contact_3 for all 4 CRMs
```bash
curl -X PUT "http://localhost:8000/api/v3/contacts/crm/select" \
  -H "Authorization: Bearer $JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "contact_ids": ["<test_contact_3_id>"],
    "crms": ["brevo", "hubspot", "mautic", "n8n"],
    "action": "select"
  }'
```

**Expected Result:**
```json
{
  "updated_count": 1,
  "crms": ["brevo", "hubspot", "mautic", "n8n"],
  "action": "select",
  "message": "Selected 1 contacts for 4 CRM(s)"
}
```

**Pass Criteria:**
- ✅ Status code = 200
- ✅ updated_count = 1
- ✅ crms array contains all 4 CRMs

**Database Verification:**
```sql
SELECT
    id,
    email,
    brevo_sync_status,
    hubspot_sync_status,
    mautic_sync_status,
    n8n_sync_status
FROM contacts
WHERE id = '<test_contact_3_id>';
```

**Verify:**
- ✅ brevo_sync_status = 'Selected'
- ✅ hubspot_sync_status = 'Selected'
- ✅ mautic_sync_status = 'Selected'
- ✅ n8n_sync_status = 'Selected'

---

### Test 7: Filter by Selected Status

**Objective:** Verify filtering by 'Selected' status works

**Action:**
```bash
curl -X GET "http://localhost:8000/api/v3/contacts?brevo_sync_status=Selected" \
  -H "Authorization: Bearer $JWT_TOKEN" \
  -H "Content-Type: application/json"
```

**Expected Result:**
- Status: 200 OK
- Should return contacts 1, 2, and 3 (selected for Brevo in Tests 5 & 6)

**Pass Criteria:**
- ✅ Status code = 200
- ✅ Returns exactly 3 contacts
- ✅ All have brevo_sync_status = 'Selected'

**Database Verification:**
```sql
SELECT COUNT(*) as selected_count
FROM contacts
WHERE brevo_sync_status = 'Selected';
```
**Verify:** Count = 3

---

### Test 8: Unselect Contacts

**Objective:** Verify contacts can be unselected (revert to 'New')

**Action:** Unselect test_contact_1 from Brevo
```bash
curl -X PUT "http://localhost:8000/api/v3/contacts/crm/select" \
  -H "Authorization: Bearer $JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "contact_ids": ["<test_contact_1_id>"],
    "crms": ["brevo"],
    "action": "unselect"
  }'
```

**Expected Result:**
```json
{
  "updated_count": 1,
  "crms": ["brevo"],
  "action": "unselect",
  "message": "Unselected 1 contacts for 1 CRM(s)"
}
```

**Pass Criteria:**
- ✅ Status code = 200
- ✅ updated_count = 1
- ✅ action = "unselect"

**Database Verification:**
```sql
SELECT
    id,
    email,
    brevo_sync_status
FROM contacts
WHERE id = '<test_contact_1_id>';
```

**Verify:**
- ✅ brevo_sync_status = 'New' (reverted from 'Selected')

---

### Test 9: Invalid CRM Name (Error Handling)

**Objective:** Verify schema validation catches invalid CRM names

**Action:** Try to select with invalid CRM name
```bash
curl -X PUT "http://localhost:8000/api/v3/contacts/crm/select" \
  -H "Authorization: Bearer $JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "contact_ids": ["<test_contact_4_id>"],
    "crms": ["invalid_crm", "fake_crm"],
    "action": "select"
  }'
```

**Expected Result:**
```json
{
  "detail": [
    {
      "type": "value_error",
      "loc": ["body", "crms"],
      "msg": "Value error, Invalid CRM names: {'fake_crm', 'invalid_crm'}",
      "input": ["invalid_crm", "fake_crm"]
    }
  ]
}
```

**Pass Criteria:**
- ✅ Status code = 422 (Unprocessable Entity)
- ✅ Error message mentions "Invalid CRM names"
- ✅ Lists the invalid CRMs

**Database Verification:**
```sql
SELECT brevo_sync_status FROM contacts WHERE id = '<test_contact_4_id>';
```
**Verify:** Status unchanged (still 'New')

---

### Test 10: Invalid Action (Error Handling)

**Objective:** Verify schema validation catches invalid action

**Action:** Try to use invalid action
```bash
curl -X PUT "http://localhost:8000/api/v3/contacts/crm/select" \
  -H "Authorization: Bearer $JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "contact_ids": ["<test_contact_4_id>"],
    "crms": ["brevo"],
    "action": "delete"
  }'
```

**Expected Result:**
```json
{
  "detail": [
    {
      "type": "value_error",
      "loc": ["body", "action"],
      "msg": "Value error, action must be 'select' or 'unselect'",
      "input": "delete"
    }
  ]
}
```

**Pass Criteria:**
- ✅ Status code = 422
- ✅ Error message mentions valid actions

---

### Test 11: Empty Contact IDs

**Objective:** Verify graceful handling of empty contact list

**Action:**
```bash
curl -X PUT "http://localhost:8000/api/v3/contacts/crm/select" \
  -H "Authorization: Bearer $JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "contact_ids": [],
    "crms": ["brevo"],
    "action": "select"
  }'
```

**Expected Result:**
```json
{
  "updated_count": 0,
  "message": "No contact IDs provided"
}
```

**Pass Criteria:**
- ✅ Status code = 200
- ✅ updated_count = 0
- ✅ Appropriate message

---

### Test 12: Empty CRM List

**Objective:** Verify graceful handling of empty CRM list

**Action:**
```bash
curl -X PUT "http://localhost:8000/api/v3/contacts/crm/select" \
  -H "Authorization: Bearer $JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "contact_ids": ["<test_contact_4_id>"],
    "crms": [],
    "action": "select"
  }'
```

**Expected Result:**
```json
{
  "updated_count": 0,
  "message": "No CRMs specified"
}
```

**Pass Criteria:**
- ✅ Status code = 200
- ✅ updated_count = 0

---

### Test 13: Non-Existent Contact IDs

**Objective:** Verify error handling for contacts that don't exist

**Action:**
```bash
curl -X PUT "http://localhost:8000/api/v3/contacts/crm/select" \
  -H "Authorization: Bearer $JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "contact_ids": ["00000000-0000-0000-0000-000000000000"],
    "crms": ["brevo"],
    "action": "select"
  }'
```

**Expected Result:**
```json
{
  "detail": "No contacts found with provided IDs"
}
```

**Pass Criteria:**
- ✅ Status code = 404
- ✅ Clear error message

---

### Test 14: Verify No Changes to Existing Endpoints

**Objective:** Confirm existing contact CRUD operations still work

**Action 1:** Get single contact
```bash
curl -X GET "http://localhost:8000/api/v3/contacts/<test_contact_1_id>" \
  -H "Authorization: Bearer $JWT_TOKEN"
```

**Pass Criteria:**
- ✅ Status code = 200
- ✅ Returns contact details

**Action 2:** Update contact (existing endpoint)
```bash
curl -X PUT "http://localhost:8000/api/v3/contacts/<test_contact_5_id>" \
  -H "Authorization: Bearer $JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Updated Test Contact 5"
  }'
```

**Pass Criteria:**
- ✅ Status code = 200
- ✅ Name updated
- ✅ CRM statuses unchanged

**Database Verification:**
```sql
SELECT name, brevo_sync_status FROM contacts WHERE id = '<test_contact_5_id>';
```
**Verify:**
- Name = 'Updated Test Contact 5'
- brevo_sync_status = 'New' (unchanged)

---

### Test 15: Combined Filters (Multiple Parameters)

**Objective:** Verify multiple filter parameters work together

**Action:** Filter by brevo_sync_status AND email_type
```bash
curl -X GET "http://localhost:8000/api/v3/contacts?brevo_sync_status=Selected&email_type=CORPORATE" \
  -H "Authorization: Bearer $JWT_TOKEN"
```

**Expected Result:**
- Returns contacts that are BOTH:
  - brevo_sync_status = 'Selected'
  - email_type = 'CORPORATE'

**Pass Criteria:**
- ✅ Status code = 200
- ✅ All returned contacts match both criteria

**Database Verification:**
```sql
SELECT COUNT(*)
FROM contacts
WHERE brevo_sync_status = 'Selected'
  AND email_type = 'CORPORATE';
```
**Verify:** API count matches database count

---

## Test Cleanup (5 minutes)

### Step 1: Delete Test Contacts

**Action:** Remove test contacts created for testing
```sql
DELETE FROM contacts WHERE email LIKE 'test%@example.com';
```

**Expected Result:** 5 contacts deleted

**Pass Criteria:** ✅ All test contacts removed

---

### Step 2: Verify Cleanup

**Action:** Confirm test contacts gone
```sql
SELECT COUNT(*) FROM contacts WHERE email LIKE 'test%@example.com';
```

**Expected Result:** Count = 0

**Pass Criteria:** ✅ No test contacts remain

---

## Test Results Summary

### Pass/Fail Criteria

**Phase 1 Testing PASSES if ALL of the following are true:**

#### Functionality Tests (Tests 1-8)
- [x] Test 1: List endpoint works without filters
- [x] Test 2: Brevo filter works
- [x] Test 3: Mautic filter works
- [x] Test 4: n8n filter works
- [x] Test 5: Single CRM selection works
- [x] Test 6: Multi-CRM selection works
- [x] Test 7: Filter by Selected status works
- [x] Test 8: Unselect functionality works

#### Error Handling Tests (Tests 9-13)
- [x] Test 9: Invalid CRM name rejected
- [x] Test 10: Invalid action rejected
- [x] Test 11: Empty contact list handled gracefully
- [x] Test 12: Empty CRM list handled gracefully
- [x] Test 13: Non-existent contact IDs return 404

#### Regression Tests (Tests 14-15)
- [x] Test 14: Existing endpoints unchanged
- [x] Test 15: Combined filters work

#### Database Integrity
- [x] All database verifications pass
- [x] No orphaned data
- [x] Test cleanup successful

**Overall Result:** ✅ PASS / ❌ FAIL

---

## Failure Troubleshooting

### If Tests Fail

**Status Code Errors:**
- **401 Unauthorized:** Verify JWT token is valid
- **404 Not Found:** Check endpoint URL, verify app is running
- **422 Validation Error:** Check request body format
- **500 Internal Server Error:** Check application logs

**Database Mismatch:**
- Check MCP connection to correct database
- Verify test contacts were created successfully
- Check for database transaction issues

**Schema Errors:**
- Verify `CRMSelectionRequest` schema is properly imported
- Check Pydantic validators are working
- Verify ENUMs are defined correctly

---

## Test Execution Checklist

**Before Starting:**
- [ ] Application is running
- [ ] MCP Supabase connection tested
- [ ] JWT token obtained and valid
- [ ] Test data created successfully

**During Testing:**
- [ ] Document any failures immediately
- [ ] Capture error messages
- [ ] Note any unexpected behavior
- [ ] Take screenshots if helpful

**After Testing:**
- [ ] All tests executed
- [ ] Results documented
- [ ] Test data cleaned up
- [ ] Pass/fail determination made

---

## Test Report Template

**Tester:** Local Claude
**Date:** 2025-01-18
**Duration:** ___ minutes
**Environment:** Local / Deployed

### Results Summary
- **Total Tests:** 15
- **Passed:** ___
- **Failed:** ___
- **Skipped:** ___

### Failed Tests (if any)
| Test # | Test Name | Failure Reason | Error Message |
|--------|-----------|----------------|---------------|
| | | | |

### Notes
_Any additional observations, concerns, or recommendations_

### Recommendation
- [ ] ✅ Phase 1 APPROVED - Ready for Phase 2
- [ ] ❌ Phase 1 FAILED - Requires fixes before proceeding

---

## Next Steps After Testing

**If All Tests Pass:**
1. Update `WO-015.5_PHASE_1_COMPLETE.md` with test results
2. Update `WO-015_INDEX.md` - mark testing complete
3. Notify user: Phase 1 ready for production
4. Proceed to Phase 2 planning

**If Any Tests Fail:**
1. Document failures in detail
2. Create bug report with reproduction steps
3. Assign fixes to appropriate Claude instance
4. Re-run failed tests after fixes
5. Do not proceed to Phase 2 until all pass

---

**Status:** Ready for Execution
**Next:** Execute all 15 tests in order
**Success Criteria:** All checkboxes checked, no failures
