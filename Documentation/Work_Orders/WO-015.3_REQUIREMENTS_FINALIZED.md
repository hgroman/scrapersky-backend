# Work Order 015.3: Brevo Sync Requirements - FINALIZED

**Date:** 2025-01-18  
**Status:** Requirements Approved, Database Complete  
**Original Proposal:** WO-015_BREVO_SYNC_IMPLEMENTATION.md  
**Database Migration:** WO-015.2_DATABASE_MIGRATION_COMPLETE.md  
**Next Phase:** Service Implementation

---

## Original Proposal Review Session

**Date:** 2025-01-18, 11:50pm - 12:15am UTC-08:00  
**Participants:** User (Henry), Local Claude AI  
**Outcome:** Requirements clarified, database migration completed

---

## User Requirements (Q&A from Original WO-015)

### Question 1: Brevo Lists
**Original Question:** Should contacts be added to a specific list, or sync without list assignment?

**User Answer:**
> "i don't have lists that i know of. do I? i am open to it."

**Decision:**
- Make `BREVO_LIST_ID` **optional** in configuration
- If provided, contacts sync to that list
- If not provided, contacts sync without list assignment
- User can create lists in Brevo dashboard later and update config

**Configuration:**
```bash
BREVO_API_KEY=your_api_key      # Required
BREVO_LIST_ID=                  # Optional - leave empty initially
```

---

### Question 2: Contact Table Fields & Brevo Attributes
**Original Question:** Are there additional custom fields needed in Brevo beyond name/phone/email?

**User Request:**
> "YOU with your MCP connectivity to supabase, connect and evaluate the tables - check out contact table fields - what do we have - what do we need"

**Database Analysis Performed:**
Connected to Supabase via MCP and analyzed contacts table structure.

**Current Contact Fields (19 total):**
- ✅ `email` (text, NOT NULL) - Maps to Brevo email
- ✅ `name` (varchar) - Maps to FIRSTNAME/LASTNAME in Brevo
- ✅ `phone_number` (varchar) - Maps to SMS attribute in Brevo
- ✅ `email_type` (ENUM: SERVICE, CORPORATE, FREE, UNKNOWN) - Custom attribute
- ✅ `has_gmail` (boolean) - Custom attribute
- ✅ `source_url` (text) - Custom attribute
- ✅ `domain_id`, `page_id` (UUID) - Custom attributes for tracking
- ✅ `context` (text) - Extraction context

**Brevo API Payload Mapping:**
```json
{
  "email": "contact@example.com",
  "attributes": {
    "FIRSTNAME": "John",
    "LASTNAME": "Doe",
    "SMS": "+1-555-1234",
    "EMAIL_TYPE": "CORPORATE",
    "SOURCE_URL": "https://...",
    "DOMAIN_ID": "uuid",
    "PAGE_ID": "uuid",
    "HAS_GMAIL": false
  },
  "listIds": [123],  // Optional
  "updateEnabled": true
}
```

**Decision:** All necessary fields exist. No additional fields needed.

---

### Question 3: Retry Logic
**Original Question:** Should failed syncs auto-retry, or require manual re-queue?

**User Answer:**
> "auto-retry with configurable setting. number of retries and timing and failure notification eventually."

**Decision:** Implement auto-retry with exponential backoff

**Configuration:**
```bash
BREVO_SYNC_MAX_RETRIES=3                    # Number of retry attempts
BREVO_SYNC_RETRY_DELAY_MINUTES=5            # Initial delay
BREVO_SYNC_RETRY_EXPONENTIAL=true           # Use exponential backoff
BREVO_SYNC_FAILURE_NOTIFICATION_EMAIL=      # Future: email alerts
```

**Retry Algorithm:**
```
Attempt 1: Immediate
Attempt 2: 5 minutes later
Attempt 3: 10 minutes later (5 * 2^1)
Attempt 4: 20 minutes later (5 * 2^2)
After max retries: Status = 'Error', notification sent (future)
```

**Database Fields Added:**
- `retry_count` (INTEGER, default 0)
- `last_retry_at` (TIMESTAMPTZ)
- `next_retry_at` (TIMESTAMPTZ)
- `last_failed_crm` (VARCHAR)

---

### Question 4: Webhooks
**Original Question:** Should we add Brevo webhook endpoint for bounce/unsubscribe tracking?

**User Answer:**
> "no webhook right now."

**Decision:** Skip webhook implementation in initial release.

---

### Question 5: Multi-CRM Architecture & n8n Integration
**Original Question:** Should we plan for n8n integration now, or implement later?

**User Answer:**
> "n8n we could do later BUT BUT - think about architecture that easily enables future expansion. START with Brevo - once done, hubspot, once done, n8n, once done mautic"

**Decision:** Implement extensible multi-CRM architecture NOW

**Implementation Order:**
1. ✅ **Database Schema** - All 4 CRMs (Brevo, HubSpot, Mautic, n8n) - COMPLETE
2. ⏭️ **Brevo** - Full implementation (service, router, scheduler)
3. ⏭️ **HubSpot** - Fix existing implementation to use new pattern
4. ⏭️ **n8n** - Orchestration layer
5. ⏭️ **Mautic** - Following established pattern

**Architectural Pattern Established:**
Each CRM gets:
- 4 dedicated fields (sync_status, processing_status, error, contact_id)
- Dedicated router (`/api/v3/contacts/{crm}/sync/...`)
- Dedicated service (`{crm}_sync_service.py`)
- Dedicated scheduler (`{crm}_sync_scheduler.py`)
- Shared ENUMs (`crm_sync_status`, `crm_processing_status`)

---

## Critical Discovery: HubSpot ENUM Missing 'Selected'

**Issue Found:**
During database analysis, discovered that `hubspot_sync_status` ENUM was missing the `'Selected'` value that exists in other curation workflows (pages, sitemaps, places).

**User Confirmation:**
> "so the hubspot enums need to be fixed"

**Fix Applied:**
```sql
ALTER TYPE hubspot_sync_status ADD VALUE 'Selected' AFTER 'New';
ALTER TABLE contacts ADD COLUMN hubspot_contact_id VARCHAR;
```

**Pattern Standardized:**
All CRM sync status ENUMs now include:
- New → Selected → Queued → Processing → Complete/Error/Skipped

---

## Database Migration Executed (WO-015.2)

**Migration Method:** Direct SQL via Supabase MCP (no Alembic needed)

**User Clarification:**
> "I am confused. we specifically have mcp to supabase so that we don't need alembic. what the fuck is wrong with you"

**Corrected Approach:** Used MCP direct SQL execution

### Changes Applied:

**Step 1: Fixed HubSpot** ✅
- Added 'Selected' to `hubspot_sync_status` ENUM
- Added `hubspot_contact_id` field

**Step 2: Created Shared ENUMs** ✅
```sql
CREATE TYPE crm_sync_status AS ENUM (
    'New', 'Selected', 'Queued', 'Processing', 'Complete', 'Error', 'Skipped'
);

CREATE TYPE crm_processing_status AS ENUM (
    'Queued', 'Processing', 'Complete', 'Error'
);
```

**Step 3-5: Added All CRM Fields** ✅
- Brevo: 4 fields (sync_status, processing_status, error, contact_id)
- Mautic: 4 fields
- n8n: 4 fields

**Step 6: Added Retry Tracking** ✅
- `retry_count`, `last_retry_at`, `next_retry_at`, `last_failed_crm`

**Total Changes:**
- 18 new fields
- 2 new ENUMs
- 13 new indexes
- 0 downtime (backward compatible)

---

## Code Updates Executed

### 1. ENUMs (`src/models/enums.py`)
```python
class HubSpotSyncStatus(str, Enum):
    New = "New"
    Selected = "Selected"  # ADDED
    Queued = "Queued"
    Processing = "Processing"
    Complete = "Complete"
    Error = "Error"
    Skipped = "Skipped"

class CRMSyncStatus(str, Enum):
    """Shared for Brevo, Mautic, n8n"""
    New = "New"
    Selected = "Selected"
    Queued = "Queued"
    Processing = "Processing"
    Complete = "Complete"
    Error = "Error"
    Skipped = "Skipped"

class CRMProcessingStatus(str, Enum):
    Queued = "Queued"
    Processing = "Processing"
    Complete = "Complete"
    Error = "Error"
```

### 2. Contact Model (`src/models/WF7_V2_L1_1of1_ContactModel.py`)
- Added all 18 new fields
- Updated HubSpot ENUM to include 'Selected'
- Added retry tracking fields

### 3. Contact Schemas (`src/schemas/contact_schemas.py`)
- Updated `ContactUpdate` with all CRM fields (optional)
- Updated `ContactRead` with all CRM fields + retry tracking
- Added CRM ENUM imports

---

## Finalized Requirements Summary

### Brevo Sync Configuration
```bash
# Required
BREVO_API_KEY=your_api_key

# Optional
BREVO_LIST_ID=                              # Leave empty initially

# Scheduler
BREVO_SYNC_SCHEDULER_INTERVAL_MINUTES=5
BREVO_SYNC_SCHEDULER_BATCH_SIZE=10

# Retry Logic
BREVO_SYNC_MAX_RETRIES=3
BREVO_SYNC_RETRY_DELAY_MINUTES=5
BREVO_SYNC_RETRY_EXPONENTIAL=true
BREVO_SYNC_FAILURE_NOTIFICATION_EMAIL=      # Future feature
```

### Brevo Sync Workflow
1. User selects contacts → `brevo_sync_status = 'Selected'`
2. System queues → `brevo_processing_status = 'Queued'`
3. Scheduler picks up → `brevo_processing_status = 'Processing'`
4. Brevo API call → Success or Error
5. If error → Retry logic with exponential backoff
6. After max retries → `brevo_sync_status = 'Error'`, notification (future)
7. If success → `brevo_sync_status = 'Complete'`, store `brevo_contact_id`

### Dual-Status Pattern
**Curation Status** (User decisions):
- New → Selected → Queued → Processing → Complete/Error/Skipped

**Processing Status** (System state):
- Queued → Processing → Complete/Error

---

## Implementation Phases (Updated from Original WO-015)

### ✅ Phase 1: Database Schema (COMPLETE)
- Database migration via MCP
- All 4 CRMs ready (Brevo, HubSpot, Mautic, n8n)
- Retry tracking in place

### ✅ Phase 2: Code Models (COMPLETE)
- ENUMs updated
- Contact model updated
- Schemas updated
- Verified models load successfully

### ⏭️ Phase 3: Brevo API Endpoints (Next)
- Create `src/routers/v3/brevo_contacts_router.py`
- Endpoints:
  - `POST /api/v3/contacts/brevo/sync/batch`
  - `POST /api/v3/contacts/brevo/sync/filtered`
  - `GET /api/v3/contacts/brevo/status/summary`
- Register router in `src/main.py`

### ⏭️ Phase 4: Brevo Service Layer
- Create `src/services/brevo_sync_service.py`
- Implement Brevo API integration
- Handle retry logic with exponential backoff
- Store `brevo_contact_id` after successful sync

### ⏭️ Phase 5: Brevo Scheduler
- Create `src/services/brevo_sync_scheduler.py`
- Main scheduler: Process `brevo_processing_status = 'Queued'`
- Retry scheduler: Process `next_retry_at <= NOW()`
- Register in `src/scheduler_manager.py`

### ⏭️ Phase 6: Testing & Documentation
- Unit tests for service
- Integration tests for endpoints
- Manual testing checklist
- Update API documentation
- Update SYSTEM_MAP.md

---

## Estimated Timeline (Updated)

### Sprint 1 (Week 1)
- ✅ Day 1-2: Database migration (COMPLETE)
- ✅ Day 2: Code models (COMPLETE)
- ⏭️ Day 3-4: API endpoints
- ⏭️ Day 5: Testing & debugging

### Sprint 2 (Week 2)
- ⏭️ Day 1-3: Service layer + retry logic
- ⏭️ Day 4: Schedulers (sync + retry)
- ⏭️ Day 5: Testing & documentation

**Total Estimated Effort:** 8-10 days  
**Completed:** 2 days (Database + Models)  
**Remaining:** 6-8 days

---

## Success Criteria (from Original WO-015)

- ✅ Database migration successful (all Brevo fields added)
- ✅ All 4 CRMs ready in database (Brevo, HubSpot, Mautic, n8n)
- ✅ Code models updated and verified
- ⏭️ All Brevo endpoints functional and tested
- ⏭️ Scheduler processes queued contacts every 5 minutes
- ⏭️ Test contact successfully syncs to Brevo CRM
- ⏭️ Error handling works (invalid emails marked as Error)
- ⏭️ Retry logic works with exponential backoff
- ⏭️ Status summary endpoint returns accurate counts
- ⏭️ No performance regression on existing endpoints
- ⏭️ All tests passing (unit + integration)
- ⏭️ Documentation complete and accurate

---

## Architectural Benefits Achieved

✅ **Multi-CRM Ready:** All 4 CRMs have database fields  
✅ **Standardized Pattern:** Same 4-field structure for all CRMs  
✅ **Independent Sync:** Can sync to multiple CRMs simultaneously  
✅ **Extensible:** Adding new CRM = copy-paste pattern  
✅ **Retry Logic:** Shared retry tracking across all CRMs  
✅ **Backward Compatible:** Existing HubSpot code still works  
✅ **Type Safe:** Pydantic schemas enforce correct types  
✅ **HubSpot Fixed:** Now includes 'Selected' status  

---

## Related Documents

- **Original Proposal:** `WO-015_BREVO_SYNC_IMPLEMENTATION.md` (1,277 lines)
- **Database Migration:** `WO-015.2_DATABASE_MIGRATION_COMPLETE.md`
- **This Document:** `WO-015.3_REQUIREMENTS_FINALIZED.md`
- **Next:** `WO-015.4_BREVO_SERVICE_IMPLEMENTATION.md` (to be created)

---

## Next Steps

**Immediate Actions:**
1. ✅ Merge WO-015 original proposal to main (DONE)
2. ✅ Create this requirements document (DONE)
3. ⏭️ Begin Phase 3: Brevo API endpoints implementation
4. ⏭️ Create `.env.example` with Brevo configuration

**Ready to proceed with Brevo service implementation?**

---

**Status:** ✅ Requirements Finalized, Database Complete  
**Blocking Issues:** None  
**Ready for:** Phase 3 - Brevo API Endpoints
