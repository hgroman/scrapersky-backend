# Frontend Questions Answered - WO-012

**Date:** November 17, 2025  
**Respondent:** Local Claude (Testing Specialist)  
**Backend Version:** Commit 9fce378 (all bugs fixed)

---

## 1. API Base URL Consistency

**Answer: A) Use existing `scrapersky-backend.onrender.com`**

The work order docs showed example URLs. Your actual base URL is correct:
- **Dev:** `http://localhost:8000` (for local development only)
- **Staging/Prod:** `https://scrapersky-backend.onrender.com`

**Action:** Use your existing base URL configuration. The endpoints are:
- `POST /api/v3/domains/direct-submit`
- `POST /api/v3/pages/direct-submit`
- `POST /api/v3/sitemaps/direct-submit`

---

## 2. 409 Conflict Error - Batch Domain Submission

**Answer: A) Entire request fails on first conflict**

**Current Behavior:**
- Backend processes domains sequentially
- If ANY domain already exists, returns 409 immediately
- No partial success - it's all-or-nothing

**409 Response Format:**
```json
{
  "detail": "Domain 'example.com' already exists"
}
```

**Recommendation for Frontend:**
- Show error message: "Domain 'example.com' already exists. Please remove it and try again."
- Consider implementing client-side duplicate check before submission (query existing domains first)
- Alternative: Submit domains one-by-one and collect results (more API calls but better UX)

**Future Enhancement:** Backend could be modified to support partial success, but current implementation doesn't.

---

## 3. Table Refresh Strategy

**Answer: B) Reset to page 1 with status="New" filter**

**Recommended UX Flow:**
1. User submits domains/pages/sitemaps
2. Success message shows: "3 domains submitted successfully"
3. Automatically apply filter: `status: "New"` 
4. Reset to page 1
5. User immediately sees their new submissions at the top

**Why:** New submissions always have status "New" (unless auto-queued). This ensures users see their work immediately.

**Alternative (if auto_queue=true):**
- Filter by `status: "Selected"` or `status: "Queued"` to show auto-queued items

**Code Example:**
```javascript
// After successful submission
setFilters({ status: autoQueue ? 'Selected' : 'New' });
setCurrentPage(1);
refetchData();
```

---

## 4. Success Message - 409 Enhancement

**Answer: B) Just the domain/URL that conflicts**

**Current 409 Response:**
```json
{
  "detail": "Domain 'example.com' already exists"
}
```

**The response does NOT include:**
- Record ID
- Link to existing record
- Any metadata about the existing record

**Recommended Frontend Implementation:**
```javascript
if (error.status === 409) {
  const domain = extractDomainFromError(error.detail); // Parse "Domain 'example.com' already exists"
  showError(`${domain} already exists. Search for it in the table above.`);
  // Optionally: Auto-populate search filter with the domain
  setSearchFilter(domain);
}
```

**Future Enhancement:** Backend could return structured error with record ID, but not currently implemented.

---

## 5. Priority Level Validation (Pages)

**Answer: A) Backend validates and returns 422**

**Backend Validation:**
- Pydantic model validates `priority_level` is integer
- Range validation (1-10) is NOT currently enforced on backend
- If omitted, defaults to 5

**Recommendation:**
- **Frontend should enforce 1-10 range** with HTML5 input attributes:
  ```jsx
  <input type="number" min="1" max="10" defaultValue="5" />
  ```
- Backend will accept any integer (including 0, 11, 100) without error
- For best UX, enforce range on frontend

**422 Response (if not an integer):**
```json
{
  "detail": [
    {
      "loc": ["body", "priority_level"],
      "msg": "value is not a valid integer",
      "type": "type_error.integer"
    }
  ]
}
```

---

## 6. Sitemap URL Validation

**Answer: A) Backend validates (Pydantic URL validator)**

**Backend Validation:**
- Pydantic `HttpUrl` validator checks valid HTTP/HTTPS URL format
- Does NOT enforce `.xml` extension or "sitemap" in path
- Any valid URL is accepted (e.g., `https://example.com/feeds/rss` would work)

**422 Response (invalid URL):**
```json
{
  "detail": [
    {
      "loc": ["body", "url"],
      "msg": "invalid or missing URL scheme",
      "type": "value_error.url.scheme"
    }
  ]
}
```

**Recommendation:**
- Frontend can add soft validation (warning): "URL should end in .xml or contain 'sitemap'"
- But don't block submission - backend accepts any valid URL
- Valid patterns: `/sitemap.xml`, `/sitemap_index.xml`, `/sitemap/`, `/feeds/sitemap`

---

## 7. Modal vs Inline Form

**Answer: A) Separate modal dialogs (recommended)**

**Reasoning:**
- Keeps existing table UI clean
- Modals are consistent with "bulk update" pattern already in codebase
- Allows for multi-field forms without cluttering the page
- Easy to dismiss/cancel

**Recommended Implementation:**
```jsx
// Domain Curation Tab
<Button onClick={() => setShowDirectSubmitModal(true)}>
  Direct Submit Domains
</Button>

<Modal show={showDirectSubmitModal} onHide={() => setShowDirectSubmitModal(false)}>
  <Modal.Header>Direct Submit Domains</Modal.Header>
  <Modal.Body>
    <Textarea placeholder="Paste domains (one per line or comma-separated)" />
    <Checkbox label="Auto-queue for sitemap analysis" />
  </Modal.Body>
  <Modal.Footer>
    <Button onClick={handleSubmit}>Submit</Button>
  </Modal.Footer>
</Modal>
```

**Alternative:** If you prefer inline forms, that works too - just ensure it doesn't clutter the filter controls.

---

## 8. Auto-Queue Behavior Clarification

**Answer: A) Immediately triggers processing (queued for next available worker)**

**Behavior by Endpoint:**

**Domains (auto_queue=true):**
- Sets `sitemap_analysis_status: "Submitted"`
- Queues for sitemap discovery (WF5)
- Processing starts when scheduler picks it up

**Pages (auto_queue=true):**
- Sets `page_curation_status: "Selected"` AND `page_processing_status: "Queued"`
- Queues for contact extraction (WF7)
- Processing starts immediately (next scheduler cycle)

**Sitemaps (auto_import=true):**
- Sets `sitemap_curation_status: "Selected"` AND `sitemap_import_status: "Queued"`
- Queues for sitemap import (WF6)
- Processing starts immediately

**Recommendation:**
- Add tooltip/help text: "⚠️ Auto-queue will immediately process this item. Use for trusted sources only."
- Default to `false` (manual review)
- No need to warn about resource consumption - backend handles queuing

---

## 9. JWT Token Refresh

**Answer: A) Handled by AuthContext (verify implementation)**

**Expected Behavior:**
- AuthContext should handle token refresh automatically
- If 401 occurs, AuthContext should redirect to login
- No retry logic needed in individual components

**Recommended Error Handling:**
```javascript
try {
  const response = await fetch(url, {
    headers: { 'Authorization': `Bearer ${session?.access_token}` }
  });
  
  if (response.status === 401) {
    // Let AuthContext handle redirect to login
    throw new Error('Authentication required');
  }
} catch (error) {
  if (error.message === 'Authentication required') {
    // AuthContext will redirect
    return;
  }
  // Handle other errors
}
```

**Verify:** Check if AuthContext has token refresh logic. If not, 401 should redirect to login.

---

## 10. Domain Input Format (UX)

**Answer: A) Support both formats simultaneously**

**Recommended Parsing Logic:**
```javascript
function parseDomains(input) {
  // Split by both newline AND comma
  const domains = input
    .split(/[\n,]+/)           // Split by newline or comma
    .map(d => d.trim())        // Trim whitespace
    .filter(d => d.length > 0) // Remove empty strings
    .filter((d, i, arr) => arr.indexOf(d) === i); // Remove duplicates
  
  return domains;
}

// Example inputs that work:
// "example.com, test.org"
// "example.com\ntest.org"
// "example.com, \n test.org, \n another.com"
// "  example.com  ,  test.org  "
```

**Maximum Domains:** No hard limit enforced by backend, but recommend:
- **Soft limit:** 100 domains per submission (show warning if exceeded)
- **Hard limit:** 1000 domains (block submission)
- Reason: Large batches can cause timeouts and poor UX

**Frontend Validation:**
```javascript
const domains = parseDomains(input);

if (domains.length === 0) {
  showError("Please enter at least one domain");
  return;
}

if (domains.length > 100) {
  showWarning("Submitting more than 100 domains may take a while");
}

if (domains.length > 1000) {
  showError("Maximum 1000 domains per submission. Please split into smaller batches.");
  return;
}
```

---

## Additional Context

### Rate Limits
**Answer: No rate limits currently implemented**
- Backend does not enforce rate limits on these endpoints
- Frontend can submit as frequently as needed
- Consider adding client-side throttling for UX (prevent double-clicks)

### Client-Side Duplicate Detection
**Answer: Recommended but not required**

**Option 1: Pre-submission Check (Better UX)**
```javascript
async function checkExistingDomains(domains) {
  // Query existing domains from your table data or API
  const existing = await fetchDomains({ domains: domains });
  const existingDomains = existing.map(d => d.domain);
  
  const newDomains = domains.filter(d => !existingDomains.includes(d));
  const duplicates = domains.filter(d => existingDomains.includes(d));
  
  if (duplicates.length > 0) {
    showWarning(`${duplicates.length} domains already exist: ${duplicates.join(', ')}`);
    return newDomains; // Only submit new ones
  }
  
  return domains;
}
```

**Option 2: Handle 409 Gracefully (Simpler)**
- Submit all domains
- If 409 occurs, show error and let user remove duplicates manually
- Simpler implementation but worse UX

### Error Codes Beyond Standard Set
**Answer: Only 401, 409, 422, 500**

**Complete Error Matrix:**

| Code | Cause | Frontend Action |
|------|-------|-----------------|
| 401 | Invalid/missing JWT | Redirect to login |
| 409 | Resource already exists | Show error with domain/URL, allow retry |
| 422 | Invalid input format | Show validation error on form field |
| 500 | Backend error (bug) | Show generic error, log to monitoring |

**No other error codes are returned by these endpoints.**

### Testing Recommendations

**Before going live, test these scenarios:**

1. **Happy Path:**
   - Submit single domain/page/sitemap
   - Submit multiple domains (batch)
   - Submit with auto_queue=true
   - Submit with auto_queue=false

2. **Error Cases:**
   - Submit duplicate domain (409)
   - Submit invalid URL (422)
   - Submit without JWT token (401)
   - Submit with expired token (401)

3. **Edge Cases:**
   - Submit empty input
   - Submit 100+ domains
   - Submit domains with various formats (www, https, paths)
   - Submit while table is loading
   - Submit then immediately refresh table

4. **UX Flow:**
   - Verify new items appear in table after submission
   - Verify filters work correctly
   - Verify success/error messages are clear
   - Verify modal closes on success
   - Verify form resets after submission

---

## Quick Reference: Request/Response Examples

### Domain Submission (Success)
```javascript
// Request
POST /api/v3/domains/direct-submit
{
  "domains": ["example.com", "test.org"],
  "auto_queue": false
}

// Response (200)
{
  "submitted_count": 2,
  "domain_ids": ["uuid1", "uuid2"],
  "auto_queued": false,
  "normalized_domains": ["example.com", "test.org"]
}
```

### Page Submission (Success)
```javascript
// Request
POST /api/v3/pages/direct-submit
{
  "url": "https://example.com/contact",
  "auto_queue": true,
  "priority_level": 8
}

// Response (200)
{
  "page_id": "uuid",
  "url": "https://example.com/contact",
  "domain_id": "uuid",
  "domain": "example.com",
  "auto_queued": true,
  "page_curation_status": "Selected",
  "page_processing_status": "Queued",
  "priority_level": 8
}
```

### Sitemap Submission (Success)
```javascript
// Request
POST /api/v3/sitemaps/direct-submit
{
  "url": "https://example.com/sitemap.xml",
  "auto_import": true
}

// Response (200)
{
  "sitemap_file_id": "uuid",
  "url": "https://example.com/sitemap.xml",
  "domain_id": "uuid",
  "domain": "example.com",
  "auto_imported": true,
  "sitemap_curation_status": "Selected",
  "sitemap_import_status": "Queued",
  "sitemap_type": "STANDARD"
}
```

### Error Response (409)
```javascript
// Response (409)
{
  "detail": "Domain 'example.com' already exists"
}
```

### Error Response (422)
```javascript
// Response (422)
{
  "detail": [
    {
      "loc": ["body", "url"],
      "msg": "invalid or missing URL scheme",
      "type": "value_error.url.scheme"
    }
  ]
}
```

---

## Contact for Follow-up Questions

If you have additional questions during implementation:
- **Documentation:** `WO-012.19_FRONTEND_API_DOCUMENTATION.md`
- **Test Results:** `WO-012.13_TEST_RESULTS.md`
- **Backend Code:** `src/routers/v3/` (domains, pages, sitemaps direct submission routers)

All endpoints are tested and production-ready (commit 9fce378).
