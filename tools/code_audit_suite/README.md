# Code Audit & Dependency Tracing Tool Suite

This directory contains a suite of custom Python scripts and related files designed to assist in the code audit process for the ScraperSky backend, specifically focusing on identifying potentially unused code by tracing dependencies.

**Author:** [Assumed Project Lead & AI Assistance]
**Date Created:** [Circa Q1/Q2 2024/2025 - Based on Project History]

## Overview

The primary goal of this suite is to overcome the limitations of basic static analysis by combining Abstract Syntax Tree (AST) parsing with runtime tracing information (where applicable) to map out dependencies starting from known application entry points (FastAPI main app, routers, scheduler jobs).

## Tools & Purpose

_(Detailed descriptions below will be populated by analyzing each script)_

### `analyze_runtime_results.py`

- **Purpose:** Compares modules loaded during runtime (identified via logs) against all modules found in the `src/` directory to identify potentially unused modules.
- **Input:** Reads log lines from standard input (stdin), expecting lines prefixed with `INFO - LOADED_MODULE:` followed by the module name (as generated by `src/config/runtime_tracer.py`). Accepts `--src-dir` and `--report-dir` arguments (defaults assume container paths like `/app/src`).
- **Output:** Prints a summary to stdout and saves a JSON list of potentially unused module names (after filtering manually ignored ones defined in `ALWAYS_IGNORE_MODULES`) to `unused_modules.json` in the specified report directory.
- **Usage:** Typically piped log data into it, e.g., `cat runtime.log | python tools/code_audit_suite/analyze_runtime_results.py`.

### `build_functional_map.py`

- **Purpose:** Creates a JSON map associating each source module (`src/...`) with the business function(s) that depend on it.
- **Input:** Reads multiple `deps_*.json` files from the `reports/` directory. Each `deps_*.json` file should contain a list of modules identified as dependencies for a specific feature/entry point (e.g., `deps_google_maps_api.json` for the "LocalMiner" feature rooted at `src/routers/google_maps_api.py`). It also reads `reports/all_used_modules.json` (presumably a master list of all modules identified by any trace).
- **Output:** Generates `reports/functional_dependency_map.json`. This file maps each module path to an object containing `"Mapped Business Function(s)"`, `"Entry Point(s)"`, and `"Notes"`. It categorizes modules as belonging to one specific feature, "Core/Shared" (if used by >1 feature), or generic categories like "CoreFastAPI" or "BackgroundScheduler" based on keywords if not directly mapped, or "Unmapped".
- **Usage:** `python tools/code_audit_suite/build_functional_map.py` (Assumes the various `deps_*.json` files have already been generated in `reports/`).

### `dynamic_imports.py`

- **Purpose:** Uses AST (Abstract Syntax Tree) parsing to scan Python files for potential dynamic import patterns (`importlib.import_module()` and `__import__()`). These patterns are harder to trace with static analysis and require manual review.
- **Input:** Scans `.py` files within the specified source directory (defaults to `src/`). Accepts `--src` and `--out` arguments for source directory and output file path (relative to project root).
- **Output:** Generates a JSON file (defaults to `reports/dynamic_imports.json`) containing a list of locations where dynamic imports were detected. Each entry includes the file path, line number, import type, and the module name/expression being imported.
- **Usage:** `python tools/code_audit_suite/dynamic_imports.py`.

### `exercise_endpoints.py`

- **Purpose:** Intended to trigger runtime module loading by making requests to API endpoints. It fetches the OpenAPI schema (`/openapi.json`) to discover endpoints and then attempts to make basic `GET` requests to parameter-less endpoints.
- **Input:** Accepts `--url` (defaults to `http://localhost:8000`) and `--wait` (seconds to wait after requests, defaults to 30).
- **Output:** Prints tested endpoints and status codes to stdout. Its main goal is to cause the running application (presumably with the runtime tracer active) to load modules, which are then logged elsewhere.
- **Usage:** `python tools/code_audit_suite/exercise_endpoints.py`. Note: This is a very basic exerciser and may not trigger all code paths, especially those requiring specific path parameters, request bodies, or authentication.

### `run_full_trace.py`

- **Purpose:** Orchestrates the execution of multiple dependency tracing steps to generate a comprehensive list of potentially used modules.
- **Steps Executed:**
  1.  Runs AST-based static analysis starting from `src/main.py` (`trace_static_ast`).
  2.  Runs `scheduler_trace.py` (via `run_ast_script`) to trace dependencies from scheduler jobs.
  3.  Runs `dynamic_imports.py` (via `run_ast_script`) to identify dynamic import patterns.
  4.  (Commented out) Optionally reads runtime loaded modules from `runtime_loaded_files.txt` if available.
  5.  Merges the results from the static trace, scheduler trace, dynamic patterns (and optionally runtime trace) into a single set of used module file paths.
  6.  Compares the set of used files against all `.py` files found in the `src/` directory.
- **Output:**
  - `reports/all_used_modules.json`: A JSON list of relative file paths (from project root) considered "used" based on the traces performed.
  - `reports/unused_candidates.json`: A JSON list of relative file paths found in `src/` but _not_ present in the `all_used_modules.json` list.
- **Usage:** `python tools/code_audit_suite/run_full_trace.py`. Assumes other scripts like `scheduler_trace.py` and `dynamic_imports.py` exist in the same directory.

### `run_single_router_trace.py`

- **Purpose:** A modified version of `run_full_trace.py` designed specifically to trace and report the dependencies for a _single_ specified router file.
- **Input:** Requires command-line arguments:
  - `--router-path`: The relative path to the router file to trace (e.g., `src/routers/my_router.py`).
  - `--output-file`: The path for the output JSON file containing the list of dependencies.
- **Output:** Generates a JSON file listing the relative paths of all modules statically imported (directly or indirectly) by the specified router file.
- **Usage:** `python tools/code_audit_suite/run_single_router_trace.py --router-path src/routers/some_router.py --output-file reports/deps_some_router.json`.

### `trace_deps_*.py` (Multiple Files)

- **Purpose:** These appear to be specific instances of the AST tracing logic, each hardcoded to trace dependencies starting from a particular entry point file (e.g., `trace_deps_modernized_page_scraper.py` traces from `src/routers/modernized_page_scraper.py`).
- **Input:** Reads the hardcoded entry point file.
- **Output:** Generates a specific `reports/deps_*.json` file containing the list of dependencies for that entry point (e.g., `reports/deps_modernized_page_scraper.json`).
- **Usage:** `python tools/code_audit_suite/trace_deps_some_file.py`. These were likely used individually or by `build_functional_map.py` to generate the inputs needed for the functional mapping.

### `runtime_import_logger.py`

- **Purpose:** Provides a `setup_runtime_logger` function that monkey-patches Python's built-in `__import__` function. When called, the patched import logs the name of the imported module to a specified file before performing the actual import.
- **Input:** The `setup_runtime_logger` function takes an optional `log_file` path (defaults to `reports/runtime_imports.log`).
- **Output:** Writes log lines (e.g., `LOADED_MODULE: src.services.module`) to the specified log file whenever an import occurs after setup.
- **Usage:** Imported and called (`setup_runtime_logger()`) early in an application's lifecycle (like `main.py` or potentially via `conftest.py` - though the `conftest.py` usage was removed). Note: This seems functionally similar to the newer `src/config/runtime_tracer.py`.

### `test_importlab.py`

- **Purpose:** Appears to be a very small, isolated test or example script related to using `importlib.import_module`, possibly for testing dynamic import functionality.
- **Input/Output:** Standalone, likely just prints output to console.
- **Usage:** `python tools/code_audit_suite/test_importlab.py`.

### `scheduler_trace.py`

- **Purpose:** Specifically designed to trace static dependencies related to APScheduler jobs defined within the application (likely looks for specific job definition patterns).
- **Input:** Scans source files (path seems hardcoded or implicitly determined).
- **Output:** Generates `reports/deps_scheduler.json` containing a list of modules depended upon by discovered scheduler jobs.
- **Usage:** Likely intended to be run directly (`python tools/code_audit_suite/scheduler_trace.py`) or invoked by `run_full_trace.py`.

### `trace_imports.py`

- **Purpose:** Seems to be another static analysis script using AST parsing to trace import chains starting from specified entry points.
- **Input:** Takes `--entry-points` (space-separated list of relative paths, e.g., `src/main.py src/routers/users.py`) and `--output-file` arguments.
- **Output:** Generates a JSON file listing all unique modules found by tracing imports from the given entry points.
- **Usage:** `python tools/code_audit_suite/trace_imports.py --entry-points src/main.py --output-file reports/traced_modules.json`.

### `run_runtime_analysis.sh`

- **Purpose:** A shell script designed to automate the process of running the application with runtime tracing enabled and then analyzing the results.
- **Steps:** Likely performs actions such as:
  - Starting the FastAPI application (possibly via Docker or `uvicorn`).
  - Running `exercise_endpoints.py` to hit API endpoints.
  - Waiting for a period.
  - Stopping the application.
  - Piping the application logs (containing `LOADED_MODULE:` lines) into `analyze_runtime_results.py`.
- **Input:** Reads application logs (source/location might be configured within the script).
- **Output:** Triggers the generation of `reports/unused_modules.json` via `analyze_runtime_results.py`.
- **Usage:** `./tools/code_audit_suite/run_runtime_analysis.sh` (or `bash ...`). Requires the application/tracer and analysis scripts to be correctly configured.
