# RBAC Endpoints Reference Guide

This document serves as the authoritative reference for the correct endpoints to use when interacting with the ScraperSky RBAC system. It is based on analysis of working implementations and test pages.

## Index

1. [API Configuration](#api-configuration)
2. [Feature Flags](#feature-flags)
   - [Database Structure](#feature-flags-database)
   - [API Operations](#feature-flags-api-operations)
   - [Data Structure](#feature-flags-data-structure)
   - [Authentication](#feature-flags-authentication)
   - [Important Notes](#feature-flags-notes)
   - [Example Usage](#feature-flags-examples)
3. [Profiles](#profiles)
   - [Database Structure](#profiles-database)
   - [API Operations](#profiles-api-operations)
   - [Data Structure](#profiles-data-structure)
   - [Authentication](#profiles-authentication)
   - [Important Notes](#profiles-notes)
   - [Example Usage](#profiles-examples)
4. [Roles](#roles)
   - [Database Structure](#roles-database)
   - [API Operations](#roles-api-operations)
   - [Data Structure](#roles-data-structure)
   - [Authentication](#roles-authentication)
   - [Important Notes](#roles-notes)
   - [Example Usage](#roles-examples)
5. [Permissions](#permissions)
   - [Database Structure](#permissions-database)
   - [API Operations](#permissions-api-operations)
   - [Data Structure](#permissions-data-structure)
   - [Authentication](#permissions-authentication)
   - [Important Notes](#permissions-notes)
   - [Example Usage](#permissions-examples)
6. [Role-Permission Assignments](#role-permission-assignments)
   - [Database Structure](#role-permissions-database)
   - [API Operations](#role-permissions-api-operations)
   - [Data Structure](#role-permissions-data-structure)
   - [Authentication](#role-permissions-authentication)
   - [Important Notes](#role-permissions-notes)
   - [Example Usage](#role-permissions-examples)
7. [User Role Assignments](#user-role-assignments)
   - [Database Structure](#user-roles-database)
   - [API Operations](#user-roles-api-operations)
   - [Data Structure](#user-roles-data-structure)
   - [Authentication](#user-roles-authentication)
   - [Important Notes](#user-roles-notes)
   - [Example Usage](#user-roles-examples)
8. [Tenant Features](#tenant-features)
   - [Database Structure](#tenant-features-database)
   - [API Operations](#tenant-features-api-operations)
9. [Sidebar Features](#sidebar-features)
   - [Database Structure](#sidebar-features-database)
   - [API Operations](#sidebar-features-api-operations)
10. [Database Connection Parameters](#database-connection-parameters)
    - [Required Parameters](#db-required-parameters)
    - [Why This Is Important](#db-importance)
    - [Affected Endpoints](#db-affected-endpoints)
    - [Implementation in Frontend Code](#db-frontend-implementation)
    - [PgBouncer vs. Supavisor](#db-pgbouncer-supavisor)
    - [Backend Implementation](#db-backend-implementation)
    - [Troubleshooting](#db-troubleshooting)
11. [Addendum: Building a User-Role Management Interface](#addendum-building-a-user-role-management-interface)

## API Configuration

```javascript
const API_BASE_URL = "http://localhost:8000/api";
const DEV_TOKEN = "scraper_sky_2024";
const DEFAULT_TENANT_ID = "550e8400-e29b-41d4-a716-446655440000";
```

## Feature Flags

**Correct Endpoint:** `/v3/rbac/features`

**Source:** `test-rbac-feature-flags.html`

### Database Structure {#feature-flags-database}

The features table has the following structure:

- `id` (UUID, primary key)
- `name` (Text, not null)
- `description` (Text, nullable)
- `default_enabled` (Boolean, not null, default: false)
- `created_at` (Timestamp with timezone, not null, default: now())
- `updated_at` (Timestamp with timezone, not null, default: now())

### API Operations {#feature-flags-api-operations}

| Operation          | Method | Endpoint                        | Request Body                                                                | Description                                        |
| ------------------ | ------ | ------------------------------- | --------------------------------------------------------------------------- | -------------------------------------------------- |
| List Features      | GET    | `/v3/rbac/features`             | N/A                                                                         | Retrieves all feature flags                        |
| Get Feature        | GET    | `/v3/rbac/features/{id}`        | N/A                                                                         | Retrieves a specific feature flag                  |
| Create Feature     | POST   | `/v3/rbac/features`             | `{ "name": "string", "description": "string", "default_enabled": boolean }` | Creates a new feature flag                         |
| Update Feature     | PUT    | `/v3/rbac/features/{id}`        | `{ "name": "string", "description": "string", "default_enabled": boolean }` | Updates an existing feature flag                   |
| Delete Feature     | DELETE | `/v3/rbac/features/{id}`        | N/A                                                                         | Deletes a feature flag                             |
| Set Feature Status | POST   | `/v3/rbac/features/{id}/status` | `{ "tenant_id": "string", "enabled": boolean }`                             | Sets the status of a feature for a specific tenant |

### Data Structure {#feature-flags-data-structure}

```javascript
{
    id: string,            // UUID of the feature
    name: string,          // Feature name
    description: string,   // Feature description
    default_enabled: boolean, // Whether the feature is enabled by default
    created_at: string,    // ISO date string of creation time
    updated_at: string     // ISO date string of last update time
}
```

### Authentication {#feature-flags-authentication}

```javascript
const headers = {
  "Content-Type": "application/json",
  Authorization: `Bearer ${DEV_TOKEN}`,
};
```

### Important Notes {#feature-flags-notes}

1. Feature flags are global entities, but their status can be set per tenant.
2. The default_enabled property determines the status for tenants that don't have a specific setting.
3. Feature flags are commonly used to enable/disable specific functionality in the application.

### Example Usage {#feature-flags-examples}

```javascript
// List all features
const features = await apiRequest(`${API_BASE_URL}/v3/rbac/features`);

// Create a new feature
const newFeature = {
  name: "new_feature",
  description: "A new feature flag",
  default_enabled: false,
};
await apiRequest(`${API_BASE_URL}/v3/rbac/features`, "POST", newFeature);

// Update a feature
await apiRequest(`${API_BASE_URL}/v3/rbac/features/123`, "PUT", {
  name: "updated_feature",
  description: "Updated description",
  default_enabled: true,
});

// Delete a feature
await apiRequest(`${API_BASE_URL}/v3/rbac/features/123`, "DELETE");

// Set feature status for a tenant
await apiRequest(`${API_BASE_URL}/v3/rbac/features/123/status`, "POST", {
  tenant_id: "550e8400-e29b-41d4-a716-446655440000",
  enabled: true,
});
```

## Profiles

**Correct Endpoint:** `/v3/profiles`

**Source:** `test-rbac-profile.html`

### Database Structure {#profiles-database}

The profiles table has the following structure:

- `id` (UUID, primary key, default: gen_random_uuid())
- `name` (Text, not null)
- `email` (Text, not null, unique)
- `role` (Text, not null)
- `bio` (Text, nullable)
- `tenant_id` (UUID, not null, foreign key to tenants.id)
- `active` (Boolean, not null, default: true)
- `created_at` (Timestamp with timezone, not null, default: now())
- `updated_at` (Timestamp with timezone, not null, default: now())

### API Operations {#profiles-api-operations}

| Operation      | Method | Endpoint            | Request Body                                                                                                           | Description                  |
| -------------- | ------ | ------------------- | ---------------------------------------------------------------------------------------------------------------------- | ---------------------------- |
| List Profiles  | GET    | `/v3/profiles`      | N/A                                                                                                                    | Retrieves all profiles       |
| Get Profile    | GET    | `/v3/profiles/{id}` | N/A                                                                                                                    | Retrieves a specific profile |
| Create Profile | POST   | `/v3/profiles`      | `{ "name": "string", "email": "string", "role": "string", "bio": "string", "tenant_id": "string", "active": boolean }` | Creates a new profile        |
| Update Profile | PUT    | `/v3/profiles/{id}` | `{ "name": "string", "email": "string", "role": "string", "bio": "string", "active": boolean }`                        | Updates an existing profile  |
| Delete Profile | DELETE | `/v3/profiles/{id}` | N/A                                                                                                                    | Deletes a profile            |

### Data Structure {#profiles-data-structure}

```javascript
{
    id: string,          // Unique identifier
    name: string,        // Profile name
    email: string,       // Email address
    role: string,        // One of: USER, ADMIN, SUPER_ADMIN, GLOBAL_ADMIN
    bio: string,         // Profile description
    tenant_id: string,   // Associated tenant ID
    active: boolean,     // Whether the profile is active
    created_at: string   // ISO date string of creation time
}
```

### Authentication {#profiles-authentication}

```javascript
const headers = {
  "Content-Type": "application/json",
  Authorization: `Bearer ${DEV_TOKEN}`,
};
```

### Important Notes {#profiles-notes}

1. The profiles endpoint is affected by prepared statement issues and requires special parameters (see [Database Connection Parameters](#database-connection-parameters)).
2. Profiles are always associated with a tenant through the `tenant_id` field.
3. The `role` field contains a string representation of the user's role, but this is being deprecated in favor of the user-role assignments system.
4. When querying profiles, the results are filtered by the tenant ID in the request header.

### Example Usage {#profiles-examples}

```javascript
// List all profiles with required parameters to avoid prepared statement issues
const profiles = await apiRequest(
  `${API_BASE_URL}/v3/profiles?raw_sql=true&no_prepare=true&statement_cache_size=0`
);

// Get a specific profile
const profile = await apiRequest(
  `${API_BASE_URL}/v3/profiles/123?raw_sql=true&no_prepare=true&statement_cache_size=0`
);

// Create a new profile
const newProfile = {
  name: "John Doe",
  email: "john.doe@example.com",
  role: "USER",
  bio: "Test user profile",
  tenant_id: "550e8400-e29b-41d4-a716-446655440000",
  active: true,
};
await apiRequest(`${API_BASE_URL}/v3/profiles`, "POST", newProfile);

// Update a profile
await apiRequest(`${API_BASE_URL}/v3/profiles/123`, "PUT", {
  name: "John Smith",
  email: "john.smith@example.com",
  role: "ADMIN",
  bio: "Updated profile",
  active: true,
});

// Delete a profile
await apiRequest(`${API_BASE_URL}/v3/profiles/123`, "DELETE");
```

## Roles

**Correct Endpoint:** `/v3/rbac/roles`

**Source:** Verified through database inspection and API testing

### Database Structure {#roles-database}

The roles table has the following structure:

- `id` (Integer, primary key, auto-incremented)
- `name` (Text, not null)
- `description` (Text, nullable)
- `created_at` (Timestamp with timezone, not null, default: now())
- `tenant_id` (UUID, not null, foreign key to tenants.id)

### API Operations {#roles-api-operations}

| Operation   | Method | Endpoint              | Request Body                                    | Description               |
| ----------- | ------ | --------------------- | ----------------------------------------------- | ------------------------- |
| List Roles  | GET    | `/v3/rbac/roles`      | N/A                                             | Retrieves all roles       |
| Get Role    | GET    | `/v3/rbac/roles/{id}` | N/A                                             | Retrieves a specific role |
| Create Role | POST   | `/v3/rbac/roles`      | `{ "name": "string", "description": "string" }` | Creates a new role        |
| Update Role | PUT    | `/v3/rbac/roles/{id}` | `{ "name": "string", "description": "string" }` | Updates an existing role  |
| Delete Role | DELETE | `/v3/rbac/roles/{id}` | N/A                                             | Deletes a role            |

### Data Structure {#roles-data-structure}

```javascript
{
    id: number,          // Integer identifier
    name: string,        // Role name
    description: string, // Role description
    tenant_id: string,   // Associated tenant ID (UUID)
    created_at: string   // ISO date string of creation time
}
```

### Authentication {#roles-authentication}

```javascript
const headers = {
  "Content-Type": "application/json",
  Authorization: `Bearer ${DEV_TOKEN}`,
  "X-Tenant-ID": DEFAULT_TENANT_ID,
};
```

### Important Notes {#roles-notes}

1. The system has predefined roles with specific IDs:

   - ID 1: USER - Basic user with limited permissions
   - ID 2: ADMIN - Administrator with elevated permissions
   - ID 3: SUPER_ADMIN - Super administrator with all permissions
   - ID 4: GLOBAL_ADMIN - Global administrator with system-wide permissions

2. All roles are associated with a tenant through the `tenant_id` field.

3. When creating a new role, the `tenant_id` is automatically set to the value in the `X-Tenant-ID` header.

4. The roles endpoint is affected by prepared statement issues and requires special parameters (see [Database Connection Parameters](#database-connection-parameters)).

### Example Usage {#roles-examples}

```javascript
// List all roles with required parameters to avoid prepared statement issues
const roles = await apiRequest(
  `${API_BASE_URL}/v3/rbac/roles?raw_sql=true&no_prepare=true&statement_cache_size=0`
);

// Get a specific role
const role = await apiRequest(
  `${API_BASE_URL}/v3/rbac/roles/2?raw_sql=true&no_prepare=true&statement_cache_size=0`
);

// Create a new role
const newRole = {
  name: "CONTENT_MANAGER",
  description: "User who can manage content but not users",
};
await apiRequest(`${API_BASE_URL}/v3/rbac/roles`, "POST", newRole);

// Update a role
await apiRequest(`${API_BASE_URL}/v3/rbac/roles/5`, "PUT", {
  name: "CONTENT_EDITOR",
  description: "Updated role description",
});

// Delete a role
await apiRequest(`${API_BASE_URL}/v3/rbac/roles/7`, "DELETE");
```

## Permissions

**Correct Endpoint:** `/v3/rbac/permissions`

**Source:** Verified through database inspection and API testing

### Database Structure {#permissions-database}

The permissions table has the following structure:

- `id` (UUID, primary key, default: gen_random_uuid())
- `name` (Text, not null)
- `description` (Text, nullable)
- `created_at` (Timestamp with timezone, not null, default: now())
- `updated_at` (Timestamp with timezone, not null, default: now())

### API Operations {#permissions-api-operations}

| Operation         | Method | Endpoint                    | Request Body                                    | Description                     |
| ----------------- | ------ | --------------------------- | ----------------------------------------------- | ------------------------------- |
| List Permissions  | GET    | `/v3/rbac/permissions`      | N/A                                             | Retrieves all permissions       |
| Get Permission    | GET    | `/v3/rbac/permissions/{id}` | N/A                                             | Retrieves a specific permission |
| Create Permission | POST   | `/v3/rbac/permissions`      | `{ "name": "string", "description": "string" }` | Creates a new permission        |
| Update Permission | PUT    | `/v3/rbac/permissions/{id}` | `{ "name": "string", "description": "string" }` | Updates an existing permission  |
| Delete Permission | DELETE | `/v3/rbac/permissions/{id}` | N/A                                             | Deletes a permission            |

### Data Structure {#permissions-data-structure}

```javascript
{
    id: string,          // UUID of the permission
    name: string,        // Permission name
    description: string, // Permission description
    created_at: string,  // ISO date string of creation time
    updated_at: string   // ISO date string of last update time
}
```

### Authentication {#permissions-authentication}

```javascript
const headers = {
  "Content-Type": "application/json",
  Authorization: `Bearer ${DEV_TOKEN}`,
  "X-Tenant-ID": DEFAULT_TENANT_ID,
};
```

### Important Notes {#permissions-notes}

Permissions follow specific naming conventions:

1. `view_*` - Permissions to view specific resources or services (e.g., `view_dashboard`, `view_localminer`)
2. `manage_*` - Permissions to manage specific resources (e.g., `manage_users`, `manage_roles`)
3. `start_*` - Permissions to start specific services (e.g., `start_localminer`, `start_contentmap`)
4. `access_*` - Permissions to access specific endpoints or features (e.g., `access_page_scraper`)

Unlike roles, permissions are not tenant-specific and are shared across all tenants. The combination of permissions with roles, which are tenant-specific, is what enables the multi-tenant RBAC system.

### Example Usage {#permissions-examples}

```javascript
// List all permissions
const permissions = await apiRequest(`${API_BASE_URL}/v3/rbac/permissions`);

// Get a specific permission
const permission = await apiRequest(
  `${API_BASE_URL}/v3/rbac/permissions/842aaa1d-9216-4171-a78d-5100cab69f75`
);

// Create a new permission
const newPermission = {
  name: "access_analytics",
  description: "Permission to access analytics features",
};
await apiRequest(`${API_BASE_URL}/v3/rbac/permissions`, "POST", newPermission);

// Update a permission
await apiRequest(
  `${API_BASE_URL}/v3/rbac/permissions/6062b43c-a6f4-468c-bc93-2a1d73a8671b`,
  "PUT",
  {
    name: "access_page_scraper",
    description: "Updated permission description for page scraper access",
  }
);

// Delete a permission
await apiRequest(
  `${API_BASE_URL}/v3/rbac/permissions/6062b43c-a6f4-468c-bc93-2a1d73a8671b`,
  "DELETE"
);
```

## Role-Permission Assignments

**Correct Endpoint:** `/v3/rbac-permissions/role/{role_id}`

**Source:** Verified through database inspection and API testing

### Database Structure {#role-permissions-database}

The role_permissions table has the following structure:

- `id` (UUID, primary key, default: gen_random_uuid())
- `role_id` (Integer, not null, foreign key to roles.id)
- `permission_id` (UUID, not null, foreign key to permissions.id)
- `created_at` (Timestamp with timezone, not null, default: now())

### API Operations {#role-permissions-api-operations}

| Operation                   | Method | Endpoint                                                         | Request Body                    | Description                                           |
| --------------------------- | ------ | ---------------------------------------------------------------- | ------------------------------- | ----------------------------------------------------- |
| List Role Permissions       | GET    | `/v3/rbac-permissions/role/{role_id}`                            | N/A                             | Retrieves all permissions assigned to a specific role |
| Assign Permission to Role   | POST   | `/v3/rbac-permissions/role/{role_id}`                            | `{ "permission_id": "string" }` | Assigns a permission to a role                        |
| Remove Permission from Role | DELETE | `/v3/rbac-permissions/role/{role_id}/permission/{permission_id}` | N/A                             | Removes a permission from a role                      |

### Data Structure {#role-permissions-data-structure}

```javascript
// Response from GET /v3/rbac-permissions/role/{role_id}
[
  {
    id: string, // UUID of the permission
    name: string, // Permission name
    description: string, // Permission description
    created_at: string, // ISO date string of creation time
    updated_at: string, // ISO date string of last update time
  },
];

// Request for POST /v3/rbac-permissions/role/{role_id}
{
  permission_id: string; // UUID of the permission to assign
}
```

### Authentication {#role-permissions-authentication}

```javascript
const headers = {
  "Content-Type": "application/json",
  Authorization: `Bearer ${DEV_TOKEN}`,
};
```

### Important Notes {#role-permissions-notes}

1. The endpoint only allows querying permissions by role ID. There is no endpoint to view all role-permission assignments at once.
2. To get a complete view of all role-permission assignments, you must query each role individually and combine the results.
3. The response contains the full permission objects, not just the IDs.
4. When assigning a permission to a role, the system checks if the permission exists and if the role exists before creating the assignment.
5. Removing a permission from a role is permanent and cannot be undone. Make sure to have proper confirmation mechanisms in place.

### Example Usage {#role-permissions-examples}

```javascript
// List all permissions for a specific role
const rolePermissions = await apiRequest(
  `${API_BASE_URL}/v3/rbac-permissions/role/1`
);

// Assign a permission to a role
await apiRequest(`${API_BASE_URL}/v3/rbac-permissions/role/1`, "POST", {
  permission_id: "842aaa1d-9216-4171-a78d-5100cab69f75",
});

// Remove a permission from a role
await apiRequest(
  `${API_BASE_URL}/v3/rbac-permissions/role/1/permission/842aaa1d-9216-4171-a78d-5100cab69f75`,
  "DELETE"
);

// To get all role-permission assignments, you need to query each role
async function getAllRolePermissions() {
  // First, get all roles
  const rolesResponse = await apiRequest(
    `${API_BASE_URL}/v3/rbac/roles?raw_sql=true&no_prepare=true&statement_cache_size=0`
  );
  const roles = Array.isArray(rolesResponse)
    ? rolesResponse
    : rolesResponse.data || [];

  // Then, for each role, get its permissions
  const allAssignments = [];
  for (const role of roles) {
    const response = await apiRequest(
      `${API_BASE_URL}/v3/rbac-permissions/role/${role.id}`
    );
    const permissions = Array.isArray(response)
      ? response
      : response.data || [];

    // Map each permission to an assignment object
    const rolePermissions = permissions.map((permission) => ({
      role_id: role.id,
      role_name: role.name,
      permission_id: permission.id,
      permission_name: permission.name,
      assigned_at: permission.created_at,
    }));

    allAssignments.push(...rolePermissions);
  }

  return allAssignments;
}
```

## User Role Assignments

**Correct Endpoint:** `/v3/rbac/user-roles` and `/v3/rbac/users/{user_id}/roles`

**Source:** Verified through direct API testing and database inspection

### Database Structure {#user-roles-database}

The user_roles table has the following structure:

- `id` (UUID, primary key)
- `user_id` (UUID, not null)
- `role_id` (Integer, foreign key to roles.id, not null)
- `tenant_id` (UUID, foreign key to tenants.id)
- `created_at` (Timestamp with timezone)
- `updated_at` (Timestamp with timezone)

### API Operations {#user-roles-api-operations}

| Operation             | Method | Endpoint                                   | Request Body                                                | Description                                    |
| --------------------- | ------ | ------------------------------------------ | ----------------------------------------------------------- | ---------------------------------------------- |
| List All User Roles   | GET    | `/v3/rbac/user-roles`                      | N/A                                                         | Retrieves all user-role assignments for tenant |
| Get User Roles        | GET    | `/v3/rbac/users/{user_id}/roles`           | N/A                                                         | Retrieves roles assigned to a specific user    |
| Assign Role to User   | POST   | `/v3/rbac/users/{user_id}/roles`           | `{ "role_id": "string", "tenant_id": "string" (optional) }` | Assigns a role to a user                       |
| Remove Role from User | DELETE | `/v3/rbac/users/{user_id}/roles/{role_id}` | N/A                                                         | Removes a role from a user                     |

### Data Structure {#user-roles-data-structure}

```javascript
// Response from GET /v3/rbac/user-roles
{
    "data": [
        {
            "user_id": "a235b397-ab19-41c2-ba52-ed4cc59aced0",
            "role_id": 1,
            "role_name": "USER",
            "created_at": "2025-03-04T21:52:56.577116+00:00"
        },
        // More user-role assignments...
    ]
}

// Response from GET /v3/rbac/users/{user_id}/roles
{
    "data": [
        {
            "id": 2,
            "name": "ADMIN",
            "description": "Administrator with elevated permissions",
            "tenant_id": "550e8400-e29b-41d4-a716-446655440000",
            "created_at": "2025-03-04T06:24:00.862958+00:00"
        }
    ]
}
```

### Authentication {#user-roles-authentication}

```javascript
const headers = {
  "Content-Type": "application/json",
  Authorization: `Bearer ${DEV_TOKEN}`,
  "X-Tenant-ID": DEFAULT_TENANT_ID,
};
```

### Important Notes {#user-roles-notes}

1. The tenant_id is required for proper multi-tenant isolation. All user-role assignments must be associated with a tenant.
2. The API endpoints filter by the tenant_id provided in the X-Tenant-ID header.
3. When assigning a role to a user, if tenant_id is not provided in the request body, the tenant_id from the X-Tenant-ID header will be used.
4. Users can have multiple roles, but they should have only one role per tenant.
5. The user_id should correspond to a profile's ID in the profiles table.
6. User-role assignments are the central component of the RBAC system, linking users to their allowed permissions through roles.

### Example Usage {#user-roles-examples}

```javascript
// List all user-role assignments
const userRoles = await apiRequest(`${API_BASE_URL}/v3/rbac/user-roles`);

// Get roles for a specific user
const userRoles = await apiRequest(
  `${API_BASE_URL}/v3/rbac/users/39c6f1e3-ca56-4615-8de4-49e869e5d874/roles`
);

// Assign a role to a user
await apiRequest(
  `${API_BASE_URL}/v3/rbac/users/39c6f1e3-ca56-4615-8de4-49e869e5d874/roles`,
  "POST",
  {
    role_id: 1,
  }
);

// Remove a role from a user
await apiRequest(
  `${API_BASE_URL}/v3/rbac/users/39c6f1e3-ca56-4615-8de4-49e869e5d874/roles/1`,
  "DELETE"
);

// Typical workflow: Get a user profile, then assign a role
async function assignRoleToNewUser(profileId) {
  try {
    // First, check if the profile exists
    const profile = await apiRequest(
      `${API_BASE_URL}/v3/profiles/${profileId}?raw_sql=true&no_prepare=true&statement_cache_size=0`
    );

    if (!profile) {
      throw new Error("Profile not found");
    }

    // Then assign the USER role (id: 1) to the profile
    await apiRequest(
      `${API_BASE_URL}/v3/rbac/users/${profileId}/roles`,
      "POST",
      { role_id: 1 }
    );

    return true;
  } catch (error) {
    console.error("Error assigning role to user:", error);
    return false;
  }
}
```

## Tenant Features

**Base URL**: `/api/v3/features/tenant`

- **GET** - Retrieve all feature settings for a specific tenant

  - Parameters:
    - Headers:
      - `Authorization`: Bearer token for authentication
      - `X-Tenant-ID`: Tenant ID (UUID format)
    - Query parameters:
      - `raw_sql`: Boolean, enables raw SQL execution (default: false)
      - `no_prepare`: Boolean, disables statement preparation (default: false)
      - `statement_cache_size`: Integer, size of the statement cache (default: 100)
  - Response:
    - Status: 200 OK
    - Body: Array of tenant feature objects
    - Format: JSON

- **POST** - Create or update a tenant feature setting
  - Parameters:
    - Headers:
      - `Authorization`: Bearer token for authentication
      - `X-Tenant-ID`: Tenant ID (UUID format)
    - Query parameters:
      - `raw_sql`: Boolean, enables raw SQL execution (default: false)
      - `no_prepare`: Boolean, disables statement preparation (default: false)
      - `statement_cache_size`: Integer, size of the statement cache (default: 100)
    - Body:
      - `feature_name`: String, name of the feature
      - `enabled`: Boolean, whether the feature is enabled for this tenant
  - Response:
    - Status: 201 Created or 200 OK (if updating)
    - Body: Created or updated tenant feature object
    - Format: JSON

**Note**: The tenant features endpoint was previously at `/v2/role_based_access_control/tenant-features` in v2 API but is now at `/api/v3/features/tenant` in v3 API.

## Sidebar Features

**Correct Endpoint:** `/v3/sidebar-features`

**Source:** Verified through database inspection

This section provides a brief overview of the sidebar features system. For comprehensive documentation, please refer to the [ScraperSky RBAC Feature System Reference](./rbac-feature-system-reference.md) document.

### Database Structure {#sidebar-features-database}

The sidebar_features table defines UI navigation elements tied to features:

- `id` (UUID, primary key)
- `feature_id` (UUID, foreign key to feature_flags.id)
- `sidebar_name` (Text)
- `url_path` (Text)
- `icon` (Text, nullable)
- `display_order` (Integer)
- `requires_permission` (Text, nullable)
- `requires_feature` (UUID, nullable)
- `tenant_id` (UUID, nullable)
- `created_at` (Timestamp)
- `updated_at` (Timestamp)

### API Operations {#sidebar-features-api-operations}

| Operation          | Method | Endpoint                                       | Description                      |
| ------------------ | ------ | ---------------------------------------------- | -------------------------------- |
| List Sidebar Items | GET    | `/v3/sidebar-features?feature_id={feature_id}` | Gets sidebar items for a feature |
| Get User Sidebar   | GET    | `/v3/sidebar-features/my-sidebar`              | Gets the current user's sidebar  |

See the [Feature System Reference](./rbac-feature-system-reference.md#sidebar-features-endpoints) for detailed examples and implementation guidelines.

## Database Connection Parameters

**CRITICAL INFORMATION FOR ALL DEVELOPERS**

### Required Parameters {#db-required-parameters}

When working with certain endpoints that experience prepared statement issues (particularly the profiles and roles endpoints), you **MUST** use all three of these parameters together:

```javascript
// CORRECT: Using all three parameters together
const profiles = await apiRequest(
  `${API_BASE_URL}/v3/profiles?raw_sql=true&no_prepare=true&statement_cache_size=0`
);

const roles = await apiRequest(
  `${API_BASE_URL}/v3/rbac/roles?raw_sql=true&no_prepare=true&statement_cache_size=0`
);

// INCORRECT: Using only one parameter will still result in errors
const profiles = await apiRequest(`${API_BASE_URL}/v3/profiles?raw_sql=true`);
```

Each parameter serves a specific purpose:

1. `raw_sql=true` - Tells the backend to use raw SQL instead of ORM
2. `no_prepare=true` - Disables prepared statements
3. `statement_cache_size=0` - Sets the asyncpg statement cache size to 0

### Why This Is Important {#db-importance}

1. **Supavisor Compatibility**: Our system uses Supavisor for connection pooling. Prepared statements can cause issues with certain endpoints.

2. **Error Prevention**: Without these parameters, you will encounter errors like:

   ```
   Error: Error getting profiles: (sqlalchemy.dialects.postgresql.asyncpg.Error) : prepared statement "__asyncpg_62db45b3-8f19-4f29-ab37-d281aa4def25__" does not exist
   ```

   ```
   Error getting all roles: (sqlalchemy.dialects.postgresql.asyncpg.Error) : prepared statement "__asyncpg_a366cd9c-9e42-4acc-8213-6f8498f6be86__" does not exist
   ```

3. **Implementation**: The backend will use raw SQL queries instead of SQLAlchemy's prepared statements when these parameters are present.

### Affected Endpoints {#db-affected-endpoints}

The following endpoints are known to be affected by prepared statement issues:

1. **Profiles Endpoint**: `/v3/profiles`
2. **Roles Endpoint**: `/v3/rbac/roles`

Always use the three parameters with these endpoints to avoid errors.

### Implementation in Frontend Code {#db-frontend-implementation}

For any frontend code that interacts with the affected endpoints, implement this pattern:

```javascript
// API request helper with automatic parameters for affected endpoints
async function apiRequest(url, method = "GET", body = null) {
  // Modify URL for endpoints that need prepared statement parameters
  let requestUrl = url;
  if (url.includes("/profiles") || url.includes("/rbac/roles")) {
    // Add all possible parameters to disable prepared statements
    const params = [];

    // If URL already has parameters, parse them
    const hasParams = url.includes("?");
    if (hasParams) {
      const baseUrl = url.split("?")[0];
      const queryString = url.split("?")[1];
      const existingParams = new URLSearchParams(queryString);

      // Only add parameters that don't already exist
      if (!existingParams.has("raw_sql")) params.push("raw_sql=true");
      if (!existingParams.has("no_prepare")) params.push("no_prepare=true");
      if (!existingParams.has("statement_cache_size"))
        params.push("statement_cache_size=0");

      // Reconstruct URL with all parameters
      requestUrl =
        baseUrl +
        "?" +
        queryString +
        (params.length > 0 ? "&" + params.join("&") : "");
    } else {
      // No existing parameters, add all of ours
      requestUrl =
        url + "?" + "raw_sql=true&no_prepare=true&statement_cache_size=0";
    }
  }

  // Continue with the request using requestUrl instead of url
  // ...
}
```

### PgBouncer vs. Supavisor {#db-pgbouncer-supavisor}

Our system **EXCLUSIVELY** uses Supavisor for connection pooling, not PgBouncer. If you encounter any code or configuration related to PgBouncer:

1. **DO NOT** implement it
2. **IMMEDIATELY** flag it for removal
3. **REPORT** it to the team lead

PgBouncer configurations are incompatible with our architecture and will cause serious issues.

### Backend Implementation {#db-backend-implementation}

For backend developers adding new endpoints that interact with the database:

1. Always use SQLAlchemy ORM by default
2. Add support for all three parameters in endpoints that might experience prepared statement issues
3. When these parameters are present, use SQLAlchemy Core or direct SQL execution instead of ORM

Example backend implementation:

```python
@router.get("")
async def get_items(
    raw_sql: bool = Query(False, description="Use raw SQL instead of ORM"),
    no_prepare: bool = Query(False, description="Disable prepared statements"),
    statement_cache_size: Optional[int] = Query(None, description="Set statement cache size"),
    session: AsyncSession = Depends(get_db_session)
):
    try:
        if raw_sql and no_prepare:
            # Use SQLAlchemy Core or direct SQL execution
            result = await session.execute(text(
                "SELECT * FROM items WHERE tenant_id = :tenant_id"
            ), {"tenant_id": tenant_id})
            items = [dict(row) for row in result]
        else:
            # Use SQLAlchemy ORM (default)
            stmt = select(Item).where(Item.tenant_id == tenant_id)
            result = await session.execute(stmt)
            items = result.scalars().all()

        return standard_response(items)
    except Exception as e:
        # Error handling
        pass
```

### Troubleshooting {#db-troubleshooting}

If you encounter prepared statement errors despite using the required parameters:

1. **Check URL Construction**: Ensure all three parameters are included in the URL.
2. **Check Parameter Case**: Parameters are case-sensitive, so use exactly as shown.
3. **Verify Backend Support**: Ensure the backend endpoint supports these parameters.
4. **Check Console Logs**: Look for detailed error messages that might provide more information.
5. **Restart Backend**: Sometimes a backend restart is needed to clear the prepared statement cache.
6. **Update Client-Side Helper**: Use the provided helper function to automatically add parameters for affected endpoints.

## Addendum: Building a User-Role Management Interface

This addendum provides a comprehensive guide for building a robust user-role management interface based on our experience with the `test-rbac-user-role.html` page. Following these steps will help you implement a fully functional CRUD interface in one pass without encountering the common pitfalls.

### Step 1: Set Up API Request Helper with Required Parameters

```javascript
// API request helper with proper error handling and parameter management
async function apiRequest(url, method = "GET", body = null) {
  try {
    // Add required parameters for profiles endpoint to prevent prepared statement errors
    let requestUrl = url;
    if (url.includes("/profiles")) {
      const hasParams = url.includes("?");
      const params = [
        "raw_sql=true",
        "no_prepare=true",
        "statement_cache_size=0",
      ];

      if (hasParams) {
        requestUrl = url + "&" + params.join("&");
      } else {
        requestUrl = url + "?" + params.join("&");
      }
    }

    const headers = {
      "Content-Type": "application/json",
      Authorization: `Bearer ${DEV_TOKEN}`,
      "X-Tenant-ID": DEFAULT_TENANT_ID,
    };

    const options = {
      method: method,
      headers: headers,
    };

    if (body && (method === "POST" || method === "PUT")) {
      options.body = JSON.stringify(body);
    }

    const response = await fetch(requestUrl, options);
    const data = await response.json();

    if (!response.ok) {
      throw new Error(`API error: ${data.message || response.statusText}`);
    }

    return data;
  } catch (error) {
    console.error(`Error in API request to ${url}:`, error);
    throw error;
  }
}
```

### Step 2: Create HTML Structure with User-Friendly Elements

```html
<div class="container mt-4">
  <h1>User Role Management</h1>

  <!-- Status indicators -->
  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">API Connection</h5>
          <div id="connection-status">Not tested</div>
          <button id="test-connection-btn" class="btn btn-sm btn-primary mt-2">
            Test Connection
          </button>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Authentication</h5>
          <div id="token-status">Not tested</div>
          <button id="test-token-btn" class="btn btn-sm btn-primary mt-2">
            Test Token
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Create user-role form -->
  <div class="card mb-4">
    <div class="card-header">
      <h5>Create User-Role Assignment</h5>
    </div>
    <div class="card-body">
      <form id="create-form">
        <div class="row">
          <div class="col-md-5">
            <div class="form-group">
              <label for="user-select">User</label>
              <select id="user-select" class="form-control">
                <option value="">Loading users...</option>
              </select>
            </div>
          </div>
          <div class="col-md-5">
            <div class="form-group">
              <label for="role-select">Role</label>
              <select id="role-select" class="form-control">
                <option value="">Loading roles...</option>
              </select>
            </div>
          </div>
          <div class="col-md-2 d-flex align-items-end">
            <button type="submit" id="create-btn" class="btn btn-primary">
              Assign Role
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- User-role assignments table -->
  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5>User-Role Assignments</h5>
      <button id="refresh-btn" class="btn btn-sm btn-outline-secondary">
        Refresh
      </button>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-striped">
          <thead>
            <tr>
              <th>User</th>
              <th>Role</th>
              <th>Tenant</th>
              <th>Created At</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="user-roles-table-body">
            <tr>
              <td colspan="5" class="text-center">
                Loading user-role assignments...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Debug log -->
  <div class="card mt-4">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5>Debug Log</h5>
      <button id="clear-log-btn" class="btn btn-sm btn-outline-secondary">
        Clear Log
      </button>
    </div>
    <div class="card-body">
      <pre
        id="debug-log"
        class="bg-light p-3"
        style="max-height: 200px; overflow-y: auto;"
      ></pre>
    </div>
  </div>
</div>
```

### Step 3: Implement Core JavaScript Functions

```javascript
// Constants
const API_BASE_URL = "http://localhost:8000/api";
const DEV_TOKEN = "scraper_sky_2024";
const DEFAULT_TENANT_ID = "550e8400-e29b-41d4-a716-446655440000";

// Initialize the page
document.addEventListener("DOMContentLoaded", function () {
  // Set up event listeners
  document
    .getElementById("test-connection-btn")
    .addEventListener("click", testApiConnection);
  document
    .getElementById("test-token-btn")
    .addEventListener("click", testApiToken);
  document.getElementById("refresh-btn").addEventListener("click", loadData);
  document.getElementById("clear-log-btn").addEventListener("click", clearLog);
  document
    .getElementById("create-form")
    .addEventListener("submit", function (e) {
      e.preventDefault();
      createUserRole();
    });

  // Initial data loading
  testApiConnection();
  populateUserDropdown();
  populateRoleDropdown();
  loadData();
});

// Debug logging
function logDebug(message) {
  const logElement = document.getElementById("debug-log");
  const timestamp = new Date().toISOString();
  logElement.innerHTML += `[${timestamp}] ${message}\n`;
  logElement.scrollTop = logElement.scrollHeight;
}

function clearLog() {
  document.getElementById("debug-log").innerHTML = "";
}

// API connection testing
async function testApiConnection() {
  const statusElement = document.getElementById("connection-status");
  statusElement.innerHTML = "Testing...";

  try {
    const response = await fetch(`${API_BASE_URL}/health`);
    if (response.ok) {
      statusElement.innerHTML = '<span class="text-success">Connected</span>';
      return true;
    } else {
      statusElement.innerHTML = '<span class="text-danger">Failed</span>';
      return false;
    }
  } catch (error) {
    statusElement.innerHTML = '<span class="text-danger">Failed</span>';
    logDebug(`API connection error: ${error.message}`);
    return false;
  }
}

async function testApiToken() {
  const statusElement = document.getElementById("token-status");
  statusElement.innerHTML = "Testing...";

  try {
    const response = await fetch(`${API_BASE_URL}/v3/rbac/roles`, {
      headers: {
        Authorization: `Bearer ${DEV_TOKEN}`,
        "X-Tenant-ID": DEFAULT_TENANT_ID,
      },
    });

    if (response.ok) {
      statusElement.innerHTML = '<span class="text-success">Valid</span>';
      return true;
    } else {
      statusElement.innerHTML = '<span class="text-danger">Invalid</span>';
      return false;
    }
  } catch (error) {
    statusElement.innerHTML = '<span class="text-danger">Failed</span>';
    logDebug(`Token validation error: ${error.message}`);
    return false;
  }
}
```

### Step 4: Implement Data Loading and Display Functions

```javascript
// Load all necessary data
async function loadData() {
  const tableBody = document.getElementById("user-roles-table-body");
  tableBody.innerHTML =
    '<tr><td colspan="5" class="text-center">Loading user-role assignments...</td></tr>';

  try {
    // Load roles first to have role names available
    const rolesResponse = await apiRequest(`${API_BASE_URL}/v3/rbac/roles`);
    const roles = Array.isArray(rolesResponse)
      ? rolesResponse
      : rolesResponse.data || [];
    const roleMap = {};
    roles.forEach((role) => {
      roleMap[role.id] = role;
    });

    // Load profiles to have user names available
    const profilesResponse = await apiRequest(`${API_BASE_URL}/v3/profiles`);
    const profiles = Array.isArray(profilesResponse)
      ? profilesResponse
      : profilesResponse.data || [];
    const profileMap = {};
    profiles.forEach((profile) => {
      profileMap[profile.id] = profile;
    });

    // Load user-role assignments
    const userRolesResponse = await apiRequest(
      `${API_BASE_URL}/v3/rbac/user-roles`
    );
    const userRoles = Array.isArray(userRolesResponse)
      ? userRolesResponse
      : userRolesResponse.data || [];

    if (userRoles.length === 0) {
      tableBody.innerHTML =
        '<tr><td colspan="5" class="text-center">No user-role assignments found</td></tr>';
      return;
    }

    // Build table rows
    let tableHtml = "";
    userRoles.forEach((assignment) => {
      const user = profileMap[assignment.user_id] || {
        name: "Unknown",
        email: "",
      };
      const role = roleMap[assignment.role_id] || { name: "Unknown" };
      const createdAt = new Date(assignment.created_at).toLocaleString();

      tableHtml += `
        <tr>
          <td>${user.name} <small class="text-muted">${user.email}</small><br><small class="text-muted">${assignment.user_id}</small></td>
          <td><strong>${role.name}</strong><br><small class="text-muted">ID: ${assignment.role_id}</small></td>
          <td>Last Apple<br><small class="text-muted">${DEFAULT_TENANT_ID}</small></td>
          <td>${createdAt}</td>
          <td>
            <button class="btn btn-sm btn-danger delete-btn" data-user-id="${assignment.user_id}" data-role-id="${assignment.role_id}">
              Delete
            </button>
          </td>
        </tr>
      `;
    });

    tableBody.innerHTML = tableHtml;

    // Add event listeners to delete buttons
    document.querySelectorAll(".delete-btn").forEach((button) => {
      button.addEventListener("click", function () {
        const userId = this.getAttribute("data-user-id");
        const roleId = this.getAttribute("data-role-id");
        deleteUserRole(userId, roleId);
      });
    });

    logDebug(`Loaded ${userRoles.length} user-role assignments`);
  } catch (error) {
    tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">Error loading data: ${error.message}</td></tr>`;
    logDebug(`Error loading data: ${error.message}`);
  }
}

// Populate user dropdown
async function populateUserDropdown() {
  const userSelect = document.getElementById("user-select");
  userSelect.innerHTML = '<option value="">Loading users...</option>';

  try {
    const response = await apiRequest(`${API_BASE_URL}/v3/profiles`);
    const profiles = Array.isArray(response) ? response : response.data || [];

    if (profiles.length === 0) {
      userSelect.innerHTML = '<option value="">No users available</option>';
      return;
    }

    userSelect.innerHTML = '<option value="">Select a user</option>';
    profiles.forEach((profile) => {
      const option = document.createElement("option");
      option.value = profile.id;
      option.textContent = `${profile.name} (${profile.email})`;
      userSelect.appendChild(option);
    });

    logDebug(`Populated user dropdown with ${profiles.length} users`);
  } catch (error) {
    userSelect.innerHTML = '<option value="">Error loading users</option>';
    logDebug(`Error populating user dropdown: ${error.message}`);
  }
}

// Populate role dropdown
async function populateRoleDropdown() {
  const roleSelect = document.getElementById("role-select");
  roleSelect.innerHTML = '<option value="">Loading roles...</option>';

  try {
    const response = await apiRequest(`${API_BASE_URL}/v3/rbac/roles`);
    const roles = Array.isArray(response) ? response : response.data || [];

    if (roles.length === 0) {
      roleSelect.innerHTML = '<option value="">No roles available</option>';
      return;
    }

    roleSelect.innerHTML = '<option value="">Select a role</option>';
    roles.forEach((role) => {
      const option = document.createElement("option");
      option.value = role.id;
      option.textContent = `${role.name} - ${
        role.description || "No description"
      }`;
      roleSelect.appendChild(option);
    });

    logDebug(`Populated role dropdown with ${roles.length} roles`);
  } catch (error) {
    roleSelect.innerHTML = '<option value="">Error loading roles</option>';
    logDebug(`Error populating role dropdown: ${error.message}`);
  }
}
```

### Step 5: Implement CRUD Operations

```javascript
// Create a new user-role assignment
async function createUserRole() {
  const userId = document.getElementById("user-select").value;
  const roleId = document.getElementById("role-select").value;

  if (!userId || !roleId) {
    alert("Please select both a user and a role");
    return;
  }

  try {
    logDebug(
      `Creating user-role assignment: User ID ${userId}, Role ID ${roleId}`
    );

    await apiRequest(`${API_BASE_URL}/v3/rbac/users/${userId}/roles`, "POST", {
      role_id: parseInt(roleId),
    });

    // Clear form and reload data
    document.getElementById("user-select").value = "";
    document.getElementById("role-select").value = "";

    alert("User-role assignment created successfully");
    loadData();
  } catch (error) {
    alert(`Error creating user-role assignment: ${error.message}`);
    logDebug(`Error creating user-role assignment: ${error.message}`);
  }
}

// Delete a user-role assignment
async function deleteUserRole(userId, roleId) {
  if (!confirm("Are you sure you want to delete this user-role assignment?")) {
    return;
  }

  try {
    logDebug(
      `Deleting user-role assignment: User ID ${userId}, Role ID ${roleId}`
    );

    await apiRequest(
      `${API_BASE_URL}/v3/rbac/users/${userId}/roles/${roleId}`,
      "DELETE"
    );

    alert("User-role assignment deleted successfully");
    loadData();
  } catch (error) {
    alert(`Error deleting user-role assignment: ${error.message}`);
    logDebug(`Error deleting user-role assignment: ${error.message}`);
  }
}
```

### Key Lessons Learned

1. **Always Use All Three Parameters for Profiles Endpoint**

   - `raw_sql=true`
   - `no_prepare=true`
   - `statement_cache_size=0`

   These parameters must be used together to avoid prepared statement errors with Supavisor.

2. **Include the X-Tenant-ID Header in All Requests**

   - This is critical for proper multi-tenant isolation.
   - Without this header, API responses will be empty or incorrect.

3. **Implement Client-Side Data Joining**

   - Load profiles and roles separately, then join them with user-role assignments in the client.
   - This provides a more user-friendly display without requiring backend changes.

4. **Use Proper Error Handling**

   - Always include try/catch blocks around API requests.
   - Provide clear error messages to users and detailed logs for debugging.

5. **Validate User Input**

   - Ensure all required fields are filled before submitting forms.
   - Provide clear feedback when validation fails.

6. **Optimize Data Loading**

   - Load reference data (profiles, roles) first, then use it to enhance the display of user-role assignments.
   - Cache reference data in memory to avoid unnecessary API calls.

7. **Provide User-Friendly Displays**
   - Show human-readable names instead of UUIDs.
   - Include additional context (emails, descriptions) to help users make informed decisions.
   - Use visual cues (bold text, color coding) to highlight important information.

By following these steps and lessons, you can build a robust user-role management interface that provides a seamless user experience while avoiding common pitfalls.
