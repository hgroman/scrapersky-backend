âŒ DATABASE SESSION AUDIT - ISSUES FOUND
==================================================
Found 33 potential issues:

ğŸš¨ CRITICAL SEVERITY (25 issues)
----------------------------------------
ğŸ“ File: src/services/domain_sitemap_submission_scheduler_fixed.py
ğŸ“ Line: 125
ğŸ” Pattern: DOUBLE_TRANSACTION_MANAGEMENT
ğŸ“ Description: Manual transaction management inside unknown() context manager. This causes 'idle in transaction' connections.
ğŸ’¾ Code: await session.commit()

ğŸ“ File: src/services/domain_sitemap_submission_scheduler_fixed.py
ğŸ“ Line: 125
ğŸ” Pattern: DOUBLE_TRANSACTION_MANAGEMENT
ğŸ“ Description: Manual transaction management inside unknown() context manager. This causes 'idle in transaction' connections.
ğŸ’¾ Code: await session.commit()

ğŸ“ File: src/services/domain_sitemap_submission_scheduler_fixed.py
ğŸ“ Line: 187
ğŸ” Pattern: DOUBLE_TRANSACTION_MANAGEMENT
ğŸ“ Description: Manual transaction management inside unknown() context manager. This causes 'idle in transaction' connections.
ğŸ’¾ Code: await session.commit()

ğŸ“ File: src/services/domain_sitemap_submission_scheduler_fixed.py
ğŸ“ Line: 187
ğŸ” Pattern: DOUBLE_TRANSACTION_MANAGEMENT
ğŸ“ Description: Manual transaction management inside unknown() context manager. This causes 'idle in transaction' connections.
ğŸ’¾ Code: await session.commit()

ğŸ“ File: src/services/domain_sitemap_submission_scheduler_fixed.py
ğŸ“ Line: 193
ğŸ” Pattern: DOUBLE_TRANSACTION_MANAGEMENT
ğŸ“ Description: Manual transaction management inside unknown() context manager. This causes 'idle in transaction' connections.
ğŸ’¾ Code: await session.rollback()

ğŸ“ File: src/services/domain_sitemap_submission_scheduler_fixed.py
ğŸ“ Line: 193
ğŸ” Pattern: DOUBLE_TRANSACTION_MANAGEMENT
ğŸ“ Description: Manual transaction management inside unknown() context manager. This causes 'idle in transaction' connections.
ğŸ’¾ Code: await session.rollback()

ğŸ“ File: src/services/page_scraper/domain_processor.py
ğŸ“ Line: 172
ğŸ” Pattern: DOUBLE_TRANSACTION_MANAGEMENT
ğŸ“ Description: Manual transaction management inside get_background_session() context manager. This causes 'idle in transaction' connections.
ğŸ’¾ Code: await session.commit()  # Commit the insert attempt

ğŸ“ File: src/services/page_scraper/domain_processor.py
ğŸ“ Line: 172
ğŸ” Pattern: DOUBLE_TRANSACTION_MANAGEMENT
ğŸ“ Description: Manual transaction management inside get_background_session() context manager. This causes 'idle in transaction' connections.
ğŸ’¾ Code: await session.commit()  # Commit the insert attempt

ğŸ“ File: src/services/page_scraper/domain_processor.py
ğŸ“ Line: 192
ğŸ” Pattern: DOUBLE_TRANSACTION_MANAGEMENT
ğŸ“ Description: Manual transaction management inside get_background_session() context manager. This causes 'idle in transaction' connections.
ğŸ’¾ Code: await session.rollback()  # Rollback on insert error

ğŸ“ File: src/services/page_scraper/domain_processor.py
ğŸ“ Line: 192
ğŸ” Pattern: DOUBLE_TRANSACTION_MANAGEMENT
ğŸ“ Description: Manual transaction management inside get_background_session() context manager. This causes 'idle in transaction' connections.
ğŸ’¾ Code: await session.rollback()  # Rollback on insert error

ğŸ“ File: src/session/async_session_fixed.py
ğŸ“ Line: 95
ğŸ” Pattern: DOUBLE_TRANSACTION_MANAGEMENT
ğŸ“ Description: Manual transaction management inside unknown() context manager. This causes 'idle in transaction' connections.
ğŸ’¾ Code: await session.commit()  # Manual commit when ready

ğŸ“ File: src/session/async_session_fixed.py
ğŸ“ Line: 95
ğŸ” Pattern: DOUBLE_TRANSACTION_MANAGEMENT
ğŸ“ Description: Manual transaction management inside unknown() context manager. This causes 'idle in transaction' connections.
ğŸ’¾ Code: await session.commit()  # Manual commit when ready

ğŸ“ File: src/session/async_session_fixed.py
ğŸ“ Line: 118
ğŸ” Pattern: DOUBLE_TRANSACTION_MANAGEMENT
ğŸ“ Description: Manual transaction management inside unknown() context manager. This causes 'idle in transaction' connections.
ğŸ’¾ Code: await session.commit()  # Explicit commit

ğŸ“ File: src/session/async_session_fixed.py
ğŸ“ Line: 118
ğŸ” Pattern: DOUBLE_TRANSACTION_MANAGEMENT
ğŸ“ Description: Manual transaction management inside unknown() context manager. This causes 'idle in transaction' connections.
ğŸ’¾ Code: await session.commit()  # Explicit commit

ğŸ“ File: src/tasks/email_scraper.py
ğŸ“ Line: 318
ğŸ” Pattern: DOUBLE_TRANSACTION_MANAGEMENT
ğŸ“ Description: Manual transaction management inside get_background_session() context manager. This causes 'idle in transaction' connections.
ğŸ’¾ Code: await session.commit()  # Commit RUNNING status

ğŸ“ File: src/tasks/email_scraper.py
ğŸ“ Line: 318
ğŸ” Pattern: DOUBLE_TRANSACTION_MANAGEMENT
ğŸ“ Description: Manual transaction management inside get_background_session() context manager. This causes 'idle in transaction' connections.
ğŸ’¾ Code: await session.commit()  # Commit RUNNING status

ğŸ“ File: src/tasks/email_scraper.py
ğŸ“ Line: 388
ğŸ” Pattern: DOUBLE_TRANSACTION_MANAGEMENT
ğŸ“ Description: Manual transaction management inside get_background_session() context manager. This causes 'idle in transaction' connections.
ğŸ’¾ Code: await session.commit()

ğŸ“ File: src/tasks/email_scraper.py
ğŸ“ Line: 388
ğŸ” Pattern: DOUBLE_TRANSACTION_MANAGEMENT
ğŸ“ Description: Manual transaction management inside get_background_session() context manager. This causes 'idle in transaction' connections.
ğŸ’¾ Code: await session.commit()

ğŸ“ File: src/tasks/email_scraper.py
ğŸ“ Line: 411
ğŸ” Pattern: DOUBLE_TRANSACTION_MANAGEMENT
ğŸ“ Description: Manual transaction management inside get_background_session() context manager. This causes 'idle in transaction' connections.
ğŸ’¾ Code: await session.commit()

ğŸ“ File: src/tasks/email_scraper.py
ğŸ“ Line: 411
ğŸ” Pattern: DOUBLE_TRANSACTION_MANAGEMENT
ğŸ“ Description: Manual transaction management inside get_background_session() context manager. This causes 'idle in transaction' connections.
ğŸ’¾ Code: await session.commit()

ğŸ“ File: src/tasks/email_scraper.py
ğŸ“ Line: 416
ğŸ” Pattern: DOUBLE_TRANSACTION_MANAGEMENT
ğŸ“ Description: Manual transaction management inside get_background_session() context manager. This causes 'idle in transaction' connections.
ğŸ’¾ Code: await session.rollback()  # Rollback if final commit fails

ğŸ“ File: src/tasks/email_scraper.py
ğŸ“ Line: 416
ğŸ” Pattern: DOUBLE_TRANSACTION_MANAGEMENT
ğŸ“ Description: Manual transaction management inside get_background_session() context manager. This causes 'idle in transaction' connections.
ğŸ’¾ Code: await session.rollback()  # Rollback if final commit fails

ğŸ“ File: src/tasks/email_scraper.py
ğŸ“ Line: 442
ğŸ” Pattern: DOUBLE_TRANSACTION_MANAGEMENT
ğŸ“ Description: Manual transaction management inside get_background_session() context manager. This causes 'idle in transaction' connections.
ğŸ’¾ Code: session.commit()

ğŸ“ File: src/tasks/email_scraper.py
ğŸ“ Line: 448
ğŸ” Pattern: DOUBLE_TRANSACTION_MANAGEMENT
ğŸ“ Description: Manual transaction management inside get_background_session() context manager. This causes 'idle in transaction' connections.
ğŸ’¾ Code: await session.rollback()

ğŸ“ File: src/tasks/email_scraper.py
ğŸ“ Line: 448
ğŸ” Pattern: DOUBLE_TRANSACTION_MANAGEMENT
ğŸ“ Description: Manual transaction management inside get_background_session() context manager. This causes 'idle in transaction' connections.
ğŸ’¾ Code: await session.rollback()

ğŸš¨ HIGH SEVERITY (4 issues)
----------------------------------------
ğŸ“ File: src/db/session.py
ğŸ“ Line: 284
ğŸ” Pattern: MISSING_CONTEXT_MANAGER
ğŸ“ Description: Session created without context manager. May lead to connection leaks.
ğŸ’¾ Code: session = async_session_factory()

ğŸ“ File: src/db/session.py
ğŸ“ Line: 360
ğŸ” Pattern: MISSING_CONTEXT_MANAGER
ğŸ“ Description: Session created without context manager. May lead to connection leaks.
ğŸ’¾ Code: session = async_session_factory()

ğŸ“ File: src/session/async_session.py
ğŸ“ Line: 260
ğŸ” Pattern: MISSING_CONTEXT_MANAGER
ğŸ“ Description: Session created without context manager. May lead to connection leaks.
ğŸ’¾ Code: session = async_session_factory()

ğŸ“ File: tools/database_session_audit.py
ğŸ“ Line: 280
ğŸ” Pattern: MISSING_CONTEXT_MANAGER
ğŸ“ Description: Session created without context manager. May lead to connection leaks.
ğŸ’¾ Code: "  âŒ session = async_session_factory()",

ğŸš¨ MEDIUM SEVERITY (4 issues)
----------------------------------------
ğŸ“ File: src/db/session.py
ğŸ“ Line: 303
ğŸ” Pattern: TRANSACTION_IN_LOOP
ğŸ“ Description: Session operations inside loop. Consider batching for performance.
ğŸ’¾ Code: Get a database session for use in background tasks.

ğŸ“ File: src/session/async_session.py
ğŸ“ Line: 201
ğŸ” Pattern: POTENTIAL_SESSION_LEAK
ğŸ“ Description: Background task session created without context manager.
ğŸ’¾ Code: def get_background_task_session_factory():

ğŸ“ File: src/session/async_session.py
ğŸ“ Line: 220
ğŸ” Pattern: POTENTIAL_SESSION_LEAK
ğŸ“ Description: Background task session created without context manager.
ğŸ’¾ Code: background_task_session_factory = get_background_task_session_factory()

ğŸ“ File: src/session/async_session.py
ğŸ“ Line: 235
ğŸ” Pattern: POTENTIAL_SESSION_LEAK
ğŸ“ Description: Background task session created without context manager.
ğŸ’¾ Code: session = background_task_session_factory()

ğŸ› ï¸  REMEDIATION GUIDANCE
==============================

CRITICAL - Double Transaction Management:
  âŒ async with get_background_session() as session:
      await session.commit()  # DON'T DO THIS

  âœ… async with get_background_session() as session:
      # Context manager handles commit automatically

HIGH - Missing Context Manager:
  âŒ session = async_session_factory()
      # Manual session management

  âœ… async with get_background_session() as session:
      # Automatic cleanup

For more details, see:
ğŸ“š Docs/Docs_27_Anti-Patterns/20250731_WF4_Double_Transaction_Management_CRITICAL.md