# Supabase MCP Migration Guide

## Overview

ScraperSky has migrated from Alembic to Supabase MCP (Model Context Protocol) for database schema management. This guide explains how to use MCP for all schema changes and migrations.

## What is Supabase MCP?

Supabase MCP is a protocol that allows AI assistants (like Windsurf/Cursor) to interact with Supabase projects through natural language. It provides tools for:

- Creating and altering database tables
- Managing Row Level Security (RLS) policies
- Generating and applying SQL migrations
- Creating and managing database branches
- Viewing database logs and metrics

## Prerequisites

1. **Supabase CLI** (v1.150+): `brew install supabase/tap/supabase`
2. **Supabase Personal Access Token (PAT)**: Created in the Supabase dashboard under Settings → Personal access tokens
3. **MCP configuration**: Located in `.cursor/mcp.json`

## Migration Structure

Our migrations are stored as plain SQL files:

```
scraper-sky-backend/
└── supabase/
    └── migrations/
        ├── 000_init.sql              # Baseline schema
        └── <timestamp>_<name>.sql    # Subsequent migrations
```

## Working with MCP

### 1. Creating a New Table

Using an AI assistant with MCP support (Cursor/Windsurf):

1. Open your project in Cursor/Windsurf
2. Ask the assistant: "Create a table called 'social_media_profiles' with fields for domain_id, platform, handle, url, and metadata"
3. MCP will:
   - Generate SQL migration in `supabase/migrations/<timestamp>_social_media_profiles.sql`
   - Automatically run `supabase db reset` locally

### 2. Altering an Existing Table

Ask: "Add a 'priority' integer column with default value 0 to the 'jobs' table"

### 3. Creating RLS Policies

Ask: "Add an RLS policy to the 'page_content' table to restrict access by tenant_id"

### 4. Verifying Schema Changes

```bash
# Apply migrations locally without resetting data
supabase db push

# View table structure
supabase db lint
```

### 5. Applying Migrations to Production

The CI/CD pipeline has been updated to use:

```bash
supabase db push --linked
```

## Best Practices

1. **Review Generated Migrations**: Always review SQL files before committing
2. **Test Locally**: Run `supabase db reset` to verify migrations
3. **Add RLS Policies**: Ensure all tables have proper tenant isolation
4. **Maintain SQLAlchemy Models**: Update model files to match schema changes

## Branching & Isolation

For feature development requiring database changes:

```bash
# Create a feature branch of the database
supabase db branch create feature-name

# Work with the branch locally
supabase db branch switch feature-name

# Delete when no longer needed
supabase db branch delete feature-name
```

## Troubleshooting

1. **Connection Issues**:
   - Verify PAT token in `.cursor/mcp.json`
   - Check Supabase project status

2. **Migration Conflicts**:
   - Run `supabase db diff --schema public` to see conflicts
   - Manually resolve by editing migration SQL

3. **Schema Drift**:
   - Run `supabase db reset` to sync with migrations

## References

- [Supabase MCP Documentation](https://supabase.com/docs/guides/ai/mcp)
- [Supabase CLI Reference](https://supabase.com/docs/reference/cli)
- [Automatic Embeddings Guide](https://supabase.com/docs/guides/ai/automatic-embeddings)
- [Row Level Security](https://supabase.com/docs/guides/auth/row-level-security)
