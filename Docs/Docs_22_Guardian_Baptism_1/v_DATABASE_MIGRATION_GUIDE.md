# Marching Orders: Database Migration for Layer 1 Refactor

## 1. Objective

To update the Supabase (PostgreSQL) database schema to match the refactored SQLAlchemy ORM models in the Python codebase. This is a **mandatory, blocking step** required to make the application functional after the recent Layer 1 remediation.

**Background:** The Python models are the application's source of truth for the data structure. The database schema is currently out of sync, reflecting the old structure. This guide provides the exact steps to generate and apply the necessary migration to resolve this.

## 2. Pre-Flight Checklist

-   **[ ] Tooling:** Ensure `alembic` is installed and the `alembic.ini` file is correctly configured with the Supabase database URL for your **development environment**.
-   **[ ] Branching:** Create a new, clean `feature/db-migration` branch in `git` to perform this work.
-   **[ ] Affected Models:** The team should be aware that the following models were heavily modified. The migration will affect their corresponding database tables:
    -   `batch_job`
    -   `contact`
    -   `domain`
    -   `job`
    -   `local_business`
    -   `place`
    -   `sitemap`

## 3. Step-by-Step Migration Protocol

### Step 1: Generate the Migration Script

This command will compare the current Python models against the database's last known state and generate a new migration file in your `alembic/versions` directory.

```bash
alembic revision --autogenerate -m "Align DB schema with Layer 1 model and ENUM refactoring"
```

### Step 2: CRITICAL - Review and Refine the Generated Script

**DO NOT TRUST THE AUTOGENERATED SCRIPT BLINDLY.** It is a starting point that requires careful human review. Open the newly generated Python file and meticulously check for the following:

1.  **ENUM Type Creation:**
    -   **Expect to see:** `op.create_type()` or similar operations for all the new centralized ENUMs (e.g., `SitemapCurationStatus`, `PlaceStatus`, `DomainExtractionStatus`, etc.).
    -   **Verify:** Ensure the ENUM names and their values (`'NEW'`, `'QUEUED'`, etc.) are correct.

2.  **Column Type Changes:**
    -   **Expect to see:** `op.alter_column()` calls that change a column's type from `sa.String` or `sa.VARCHAR` to the new `sa.Enum(...)` type.
    -   **Verify:** Ensure every column that now uses a centralized ENUM is being altered correctly.

3.  **Column Renames (Potential Pitfall):**
    -   **The Problem:** Alembic often detects a column rename as a `op.drop_column('old_name')` followed by an `op.add_column('new_name')`. This is **destructive** as it will drop all data in that column.
    -   **The Fix:** Manually edit the script. Replace the `drop`/`add` pair with a single `op.alter_column()` command that includes the `new_column_name` parameter. For example:
        ```python
        # Find this:
        # op.drop_column('my_table', 'old_column')
        # op.add_column('my_table', sa.Column('new_column', sa.Integer(), nullable=True))

        # Replace with this:
        op.alter_column('my_table', 'old_column', new_column_name='new_column')
        ```

4.  **Key & Constraint Changes:**
    -   **Expect to see:** `op.create_primary_key()`, `op.create_foreign_key()`, `op.drop_constraint()`.
    -   **Verify:** Cross-reference these changes with the `LAYER_1_REMEDIATION_SUMMARY.md` to ensure all PK and FK changes are correctly represented.

### Step 3: Apply and Test on a Development Database

**NEVER run this on production first.** Apply the migration to your development or staging Supabase instance.

```bash
alembic upgrade head
```

### Step 4: Verify the Schema Changes in Supabase

Connect to the development database (using the Supabase Studio UI or `psql`) and run checks:

1.  **Inspect Tables:** Check the structure of the affected tables. Confirm column names, types, and constraints are correct.
    ```sql
    -- Example for the domains table
    \d domains
    ```
2.  **Verify Custom ENUM Types:** Ensure the new ENUM types were created in the database.
    ```sql
    -- List all user-defined types
    \dT+
    ```
3.  **Check Migration History:** Confirm the `alembic_version` table contains the hash of your new migration script.
    ```sql
    SELECT * FROM alembic_version;
    ```

### Step 5: Commit and Deploy

Once the migration script is confirmed to be correct and has been successfully tested in a non-production environment:

1.  **Commit:** Commit the finalized migration script to your `git` repository.
2.  **Deploy:** Your production deployment process must now include the `alembic upgrade head` command to apply these same changes to the production database.

## 4. Final Word

This process is the bridge between the code refactoring and a functional application. It is a standard but delicate operation that requires attention to detail. Following these steps meticulously will ensure a smooth and safe database upgrade.
