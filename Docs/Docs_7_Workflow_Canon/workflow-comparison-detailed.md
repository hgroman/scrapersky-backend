# Detailed Workflow Comparison: Complete Data Flow Map

This expanded table maps the complete data flow across all six interrelated workflows, including source tables and destination services.

## Comprehensive Workflow Comparison

| Functional Step                             | WF1: Single Search → Place Create              | WF2: Staging → Deep Scan                    | WF3: Local Biz → Domain Extract                       | WF4: Domain → Sitemap Analysis                           | WF5: Sitemap File → Import Queue                                  | WF6: Sitemap Import → Page Create                     | WF7: Page Curation → Processing                                    | **Key Principles / Requirements**                                                                                                                                  | **Guiding Documentation** |
| ------------------------------------------- | ---------------------------------------------- | ------------------------------------------- | ----------------------------------------------------- | -------------------------------------------------------- | ----------------------------------------------------------------- | ----------------------------------------------------- | ------------------------------------------------------------------ | ------------------------------------------------------------------------------------------------------------------- | ------------------------ |
| **0. Primary Source Table Read**            | `place_searches` (Job Tracking) / _(Ext. API)_ | `places`                                    | `local_businesses`                                    | `domains`                                                | `sitemap_files`                                                   | `sitemap_files`                                       | `pages`                                                            | **ORM Required, Connection Management**<br>**WHY:** Database operations must be standardized, secure, and maintain connection pooling<br>**HOW:** Use SQLAlchemy ORM exclusively with proper session handling and Supavisor connection parameters | [01-ABSOLUTE_ORM_REQUIREMENT.md](../Docs_1_AI_GUIDES/01-ABSOLUTE_ORM_REQUIREMENT.md)<br>[07-DATABASE_CONNECTION_STANDARDS.md](../Docs_1_AI_GUIDES/07-DATABASE_CONNECTION_STANDARDS.md) |
| **1. UI Interaction (JS)**                  | `static/js/single-search-tab.js`               | `static/js/staging-editor-tab.js`           | `static/js/local-business-curation-tab.js`            | `static/js/domain-curation-tab.js`                       | `static/js/sitemap-curation-tab.js`                               | _(N/A - Background Process)_                          | `static/js/page-curation-tab.js`                                   | **API Standardization, Clear User Feedback**<br>**WHY:** UI must provide consistent experience and communicate clearly with backend API<br>**HOW:** Follow standard API naming conventions (/api/v3/), provide loading indicators and error handling | [15-API_STANDARDIZATION_GUIDE.md](../Docs_1_AI_GUIDES/15-API_STANDARDIZATION_GUIDE.md) |
| **1.1 HTML Tab Identifier**                 | `singleSearch`                                 | `stagingEditor`                             | `localBusinessCuration`                               | `domainCurationPanel`                                    | `sitemapCurationPanel`                                            | _(N/A - Background Process)_                          | `pageCurationPanel`                                                | **Code Organization, UI Consistency**<br>**WHY:** Frontend components must follow consistent patterns for maintainability<br>**HOW:** Use standardized tab identifiers, consistent naming conventions, and structured HTML layout | [17-CORE_ARCHITECTURAL_PRINCIPLES.md#8-code-organization](../Docs_1_AI_GUIDES/17-CORE_ARCHITECTURAL_PRINCIPLES.md#8-code-organization) |
| **1.2 Tab JavaScript File**                 | `static/js/single-search-tab.js`               | `static/js/staging-editor-tab.js`           | `static/js/local-business-curation-tab.js`            | `static/js/domain-curation-tab.js`                       | `static/js/sitemap-curation-tab.js`                               | _(N/A - Background Process)_                          | `static/js/page-curation-tab.js`                                   | **API Standardization, Code Organization**<br>**WHY:** JavaScript components must interact consistently with backend<br>**HOW:** Implement standardized API calls, consistent error handling, and follow the same AJAX patterns across tabs | [15-API_STANDARDIZATION_GUIDE.md](../Docs_1_AI_GUIDES/15-API_STANDARDIZATION_GUIDE.md)<br>[17-CORE_ARCHITECTURAL_PRINCIPLES.md#8-code-organization](../Docs_1_AI_GUIDES/17-CORE_ARCHITECTURAL_PRINCIPLES.md#8-code-organization) |
| **2. API Request Schema**                   | `api_models::PlacesSearchRequest`              | `api_models::PlaceBatchStatusUpdateRequest` | `api_models::LocalBusinessBatchStatusUpdateRequest`   | `api_models::DomainBatchCurationStatusUpdateRequest`     | `schemas/sitemap_file::SitemapFileBatchUpdate`                    | _(N/A - Triggered by WF5 DB state)_                   | `PageBatchStatusUpdateRequest`                     | **API Standardization, Enum Handling, Validation**<br>**WHY:** Input validation must be consistent and type-safe across all endpoints<br>**HOW:** Use Pydantic models for validation, explicit Enum types for status values, and consistent naming conventions | [15-API_STANDARDIZATION_GUIDE.md](../Docs_1_AI_GUIDES/15-API_STANDARDIZATION_GUIDE.md)<br>[27-ENUM_HANDLING_STANDARDS.md](../Docs_1_AI_GUIDES/27-ENUM_HANDLING_STANDARDS.md) |
| **3. API Router**                           | `routers/google_maps_api.py`                   | `routers/places_staging.py`                 | `routers/local_businesses.py`                         | `routers/domains.py`                                     | `routers/sitemap_files.py`                                        | _(N/A - Background process)_                          | `routers/pages.py`                                 | **Authentication Boundary, Transaction Boundaries, API Standardization**<br>**WHY:** Routers must enforce authentication, define clear API contracts, and manage transactions<br>**HOW:** Use FastAPI dependency injection for auth, begin/commit transactions, maintain consistent API structure with /api/v3/ prefix | [11-AUTHENTICATION_BOUNDARY.md](../Docs_1_AI_GUIDES/11-AUTHENTICATION_BOUNDARY.md)<br>[13-TRANSACTION_MANAGEMENT_GUIDE.md](../Docs_1_AI_GUIDES/13-TRANSACTION_MANAGEMENT_GUIDE.md)<br>[15-API_STANDARDIZATION_GUIDE.md](../Docs_1_AI_GUIDES/15-API_STANDARDIZATION_GUIDE.md) |
| **4. Core Logic Location**                  | Service (via background task)                  | Router directly                             | Router directly                                       | Router directly                                          | Delegated to service                                              | Background service                                    | (To Be Decided: Router/Service)                    | **Code Organization, Transaction Boundaries**<br>**WHY:** Clear separation of concerns between routing and business logic maintains clean architecture<br>**HOW:** Simple updates handled in router, complex processing delegated to services; background tasks for long-running operations | [17-CORE_ARCHITECTURAL_PRINCIPLES.md#8-code-organization](../Docs_1_AI_GUIDES/17-CORE_ARCHITECTURAL_PRINCIPLES.md#8-code-organization)<br>[13-TRANSACTION_MANAGEMENT_GUIDE.md](../Docs_1_AI_GUIDES/13-TRANSACTION_MANAGEMENT_GUIDE.md) |
| **5. Core Logic Service**                   | `services/places/places_search_service.py`     | N/A (in Router)                             | N/A (in Router)                                       | N/A (in Router)                                          | `services/sitemap_files_service.py`                               | `services/sitemap_import_service.py`                  | `services/page_curation_service.py`                | **ORM Required, Transaction Awareness, Error Handling**<br>**WHY:** Business logic must be maintainable, handle errors gracefully, and respect transaction boundaries<br>**HOW:** Services accept session parameters but don't manage transactions, use ORM exclusively, implement comprehensive error handling | [01-ABSOLUTE_ORM_REQUIREMENT.md](../Docs_1_AI_GUIDES/01-ABSOLUTE_ORM_REQUIREMENT.md)<br>[13-TRANSACTION_MANAGEMENT_GUIDE.md](../Docs_1_AI_GUIDES/13-TRANSACTION_MANAGEMENT_GUIDE.md)<br>[17-CORE_ARCHITECTURAL_PRINCIPLES.md#6-error-handling](../Docs_1_AI_GUIDES/17-CORE_ARCHITECTURAL_PRINCIPLES.md#6-error-handling) |
| **6. Primary DB Model**                     | `models/place_search.py::PlaceSearch`          | `models/place.py::Place`                    | `models/local_business.py::LocalBusiness`             | `models/domain.py::Domain`                               | `models/sitemap.py::SitemapFile`                                  | `models/sitemap.py::SitemapFile` (Input)              | `models/page.py::Page`                             | **ORM Required, UUID Standardization**<br>**WHY:** Database models must match schema exactly and follow consistent patterns<br>**HOW:** Implement SQLAlchemy models that mirror database tables, use UUID fields for IDs, implement proper relationships | [01-ABSOLUTE_ORM_REQUIREMENT.md](../Docs_1_AI_GUIDES/01-ABSOLUTE_ORM_REQUIREMENT.md)<br>[16-UUID_STANDARDIZATION_GUIDE.md](../Docs_1_AI_GUIDES/16-UUID_STANDARDIZATION_GUIDE.md)<br>[25-SQLALCHEMY_MODEL_INTEGRITY_GUIDE.md](../Docs_1_AI_GUIDES/25-SQLALCHEMY_MODEL_INTEGRITY_GUIDE.md) |
| **7. Primary Status Field**                 | `status` (on `PlaceSearch`)                    | `status`                                    | `status`                                              | `sitemap_curation_status`                                | `deep_scrape_curation_status`                                     | `sitemap_import_status` (Input)                       | `page_curation_status`                             | **Enum Handling, ORM Required**<br>**WHY:** Status fields drive workflow transitions and must be consistently managed<br>**HOW:** Define status fields with explicit enum types, validate all status values, ensure consistent naming (snake_case) | [27-ENUM_HANDLING_STANDARDS.md](../Docs_1_AI_GUIDES/27-ENUM_HANDLING_STANDARDS.md)<br>[01-ABSOLUTE_ORM_REQUIREMENT.md](../Docs_1_AI_GUIDES/01-ABSOLUTE_ORM_REQUIREMENT.md) |
| **8. Primary Status Enum**                  | `PlaceSearchStatusEnum`                        | `PlaceStatusEnum`                           | `PlaceStatusEnum` (reused)                            | `SitemapCurationStatusEnum`                              | `SitemapDeepCurationStatusEnum`                                   | `SitemapImportStatusEnum`                             | `PageCurationStatus`                               | **Enum Handling, Code Organization**<br>**WHY:** Status enums define the workflow state machine and must be consistently implemented<br>**HOW:** Define Python enums that map directly to database types, use consistent naming, include all required status values | [27-ENUM_HANDLING_STANDARDS.md](../Docs_1_AI_GUIDES/27-ENUM_HANDLING_STANDARDS.md)<br>[17-CORE_ARCHITECTURAL_PRINCIPLES.md#8-code-organization](../Docs_1_AI_GUIDES/17-CORE_ARCHITECTURAL_PRINCIPLES.md#8-code-organization) |
| **9. Queue Status Field**                   | `status` (on `Place` model, Output)            | `deep_scan_status`                          | `domain_extraction_status`                            | `sitemap_analysis_status`                                | `deep_scrape_process_status`                                      | `status` (on `Page` model, Output)                    | `page_processing_status`                           | **Background Task Pattern, Enum Handling**<br>**WHY:** Queue status fields enable decoupled background processing through status-based triggers<br>**HOW:** Implement a separate status field for background processing that schedulers monitor, set to 'Queued' to trigger processing | [21-SCHEDULED_TASKS_APSCHEDULER_PATTERN.md](../Docs_1_AI_GUIDES/21-SCHEDULED_TASKS_APSCHEDULER_PATTERN.md)<br>[27-ENUM_HANDLING_STANDARDS.md](../Docs_1_AI_GUIDES/27-ENUM_HANDLING_STANDARDS.md) |
| **10. Queue Status Enum**                   | `PlaceStatusEnum` (Output)                     | `DeepScanStatusEnum`                        | `DomainExtractionStatusEnum`                          | `SitemapAnalysisStatusEnum`                              | `SitemapDeepProcessStatusEnum`                                    | `PageStatusEnum` (Output)                             | `PageProcessingStatus`                             | **Enum Handling, Code Organization**<br>**WHY:** Queue status enums define the background processing lifecycle and must be consistently implemented<br>**HOW:** Define separate enums for queue status with consistent values (New, Queued, Processing, Complete, Error), map to database types | [27-ENUM_HANDLING_STANDARDS.md](../Docs_1_AI_GUIDES/27-ENUM_HANDLING_STANDARDS.md)<br>[29-DATABASE_ENUM_ISOLATION.md](../Docs_1_AI_GUIDES/29-DATABASE_ENUM_ISOLATION.md) |
| **10.1 Database Enum Type(s) Required**     | `placesearchstatusenum`¹, `place_status_enum`  | `place_status_enum`, `deepscanstatusenum`¹  | `place_status_enum`, `DomainExtractionStatusEnum`     | `SitemapCurationStatusEnum`, `SitemapAnalysisStatusEnum` | `sitemapdeepcurationstatusenum`¹, `sitemapdeepprocessstatusenum`¹ | `sitemap_import_status_enum`, `pagestatusenum`¹       | **`pagecurationstatus`¹, `pageprocessingstatus`¹** | **Enum Handling, ORM Required**<br>**WHY:** Database enum types must be defined in PostgreSQL before Python code can use them<br>**HOW:** Create database enum types with SQL scripts (not Alembic), ensure names match Python enum naming conventions | [27-ENUM_HANDLING_STANDARDS.md](../Docs_1_AI_GUIDES/27-ENUM_HANDLING_STANDARDS.md)<br>[18-DATABASE_SCHEMA_CHANGE_GUIDE.md](../Docs_1_AI_GUIDES/18-DATABASE_SCHEMA_CHANGE_GUIDE.md) |
| **11. Background Processing Scheduler**     | Internal task in router                        | `services/sitemap_scheduler.py`             | `services/sitemap_scheduler.py` (shared)              | `services/domain_sitemap_submission_scheduler.py`        | _(N/A - WF5 produces queue)_                                      | `services/sitemap_import_scheduler.py`                | (To Be Defined)                                    | **Background Task Pattern, Connection Management, Transaction Boundaries**<br>**WHY:** Long-running tasks must be decoupled from API requests and manage their own resources<br>**HOW:** Implement APScheduler-based polling for queue status, create dedicated database sessions, handle their own transactions | [21-SCHEDULED_TASKS_APSCHEDULER_PATTERN.md](../Docs_1_AI_GUIDES/21-SCHEDULED_TASKS_APSCHEDULER_PATTERN.md)<br>[24-SHARED_SCHEDULER_INTEGRATION_GUIDE.md](../Docs_1_AI_GUIDES/24-SHARED_SCHEDULER_INTEGRATION_GUIDE.md)<br>[28-SCHEDULER_AND_SETTINGS_PATTERNS.md](../Docs_1_AI_GUIDES/28-SCHEDULER_AND_SETTINGS_PATTERNS.md) |
| **12. Processing Service Called**           | `services/places/places_service.py`            | `services/places_deep_service.py`           | `services/business_to_domain_service.py`              | `services/domain_to_sitemap_adapter_service.py`          | _(N/A - WF5 produces queue)_                                      | `services/sitemap_import_service.py`                  | (To Be Defined)                                    | **ORM Required, Error Handling, Transaction Boundaries**<br>**WHY:** Background processing services must be reliable, handle errors, and maintain data integrity<br>**HOW:** Create services that accept sessions, implement comprehensive error handling with status updates, use ORM exclusively | [01-ABSOLUTE_ORM_REQUIREMENT.md](../Docs_1_AI_GUIDES/01-ABSOLUTE_ORM_REQUIREMENT.md)<br>[13-TRANSACTION_MANAGEMENT_GUIDE.md](../Docs_1_AI_GUIDES/13-TRANSACTION_MANAGEMENT_GUIDE.md)<br>[17-CORE_ARCHITECTURAL_PRINCIPLES.md#6-error-handling](../Docs_1_AI_GUIDES/17-CORE_ARCHITECTURAL_PRINCIPLES.md#6-error-handling) |
| **13. Output DB Model**                     | `models/place.py::Place`                       | _(Updates existing Place)_                  | `models/domain.py::Domain` (potential)                | _(Updates Source Table)_                                 | _(Updates Source Table)_                                          | `models/page.py::Page`                                | (Updates existing Page)                            | **ORM Required, UUID Standardization**<br>**WHY:** Output models define the schema for workflow results and must be consistently structured<br>**HOW:** Implement SQLAlchemy ORM models, use UUID fields, include necessary status fields and timestamps, match database schema exactly | [01-ABSOLUTE_ORM_REQUIREMENT.md](../Docs_1_AI_GUIDES/01-ABSOLUTE_ORM_REQUIREMENT.md)<br>[16-UUID_STANDARDIZATION_GUIDE.md](../Docs_1_AI_GUIDES/16-UUID_STANDARDIZATION_GUIDE.md)<br>[25-SQLALCHEMY_MODEL_INTEGRITY_GUIDE.md](../Docs_1_AI_GUIDES/25-SQLALCHEMY_MODEL_INTEGRITY_GUIDE.md) |
| **14. Destination Insert Service/Function** | `places_storage_service::store_places`         | _(Updates Source Table)_                    | `business_to_domain_service::process_single_business` | _(Updates Source Table)_                                 | _(Updates Source Table)_                                          | `sitemap_import_service::process_single_sitemap_file` | (Updates Source Table)                             | **ORM Required, Error Handling, Transaction Awareness**<br>**WHY:** Storage operations must be reliable, traceable, and maintain data integrity<br>**HOW:** Use SQLAlchemy ORM exclusively, implement proper error handling with recovery, respect transaction boundaries | [01-ABSOLUTE_ORM_REQUIREMENT.md](../Docs_1_AI_GUIDES/01-ABSOLUTE_ORM_REQUIREMENT.md)<br>[13-TRANSACTION_MANAGEMENT_GUIDE.md](../Docs_1_AI_GUIDES/13-TRANSACTION_MANAGEMENT_GUIDE.md)<br>[17-CORE_ARCHITECTURAL_PRINCIPLES.md#6-error-handling](../Docs_1_AI_GUIDES/17-CORE_ARCHITECTURAL_PRINCIPLES.md#6-error-handling) |

## Workflow Data Flow Patterns

### Data Creation Workflows (WF1, WF3, WF6)

These workflows create new records in destination tables:

- **WF1**: Creates `Place` records via `places_storage_service::store_places`
- **WF3**: Creates `Domain` records via `business_to_domain_service::process_single_business`
- **WF6**: Creates `Page` records via `sitemap_import_service::process_single_sitemap_file`

### Status Update Workflows (WF2, WF4, WF5)

These workflows primarily update status fields in the source table:

- **WF2**: Updates `places.status` and `places.deep_scan_status`
- **WF4**: Updates `domains.sitemap_curation_status` and `domains.sitemap_analysis_status`
- **WF5**: Updates `sitemap_files.deep_scrape_curation_status` and `sitemap_files.deep_scrape_process_status`

### Scheduler Patterns

- **Shared Scheduler**: WF2 and WF3 share `sitemap_scheduler.py`
- **Dedicated Schedulers**: WF4 uses `domain_sitemap_submission_scheduler.py` and WF6 uses `sitemap_import_scheduler.py`
- **Internal Task**: WF1 uses a background task within the router instead of a separate scheduler
- **Producer Only**: WF5 updates status fields that are consumed by WF6's scheduler

## Core Logic Placement

- **Router-based Logic**: WF2, WF3, WF4 implement dual-status update logic directly in the router
- **Service-based Logic**: WF1 and WF5 delegate to dedicated services
- **Background Service**: WF6 implements its logic entirely in a background service

---

**Footnotes:**
¹ WF7 represents the new Page Curation workflow we are designing. Placeholders are used for files/components yet to be created/decided.
² HTML Tab Identifier corresponds to the `id` or `data-panel` attribute of the main panel div for that workflow in `static/scraper-sky-mvp.html`.
³ Database Enum Type name inferred from Python Enum/convention, not present in the provided list. Verification needed.
