# Git Commit Preparation (Refactoring deep_scrape to sitemap_import & Enum Fixes)

**Date:** 2024-07-27

## Summary of Changes (`git diff`)

This section summarizes the changes across files resulting from the refactoring of the deep scrape/scan feature to sitemap import (WF-06) and the subsequent resolution of the database enum conflict. Mark items as checked (`[x]`) once reviewed.

- [x] **`docker-compose.yml`**:
  - [x] Renamed `DEEP_SCRAPE_SCHEDULER_*` environment variables to `SITEMAP_IMPORT_SCHEDULER_*`.
- [ ] **`Docs/Docs_1_AI_GUIDES/00-Developer-Guides.md`**:
  - [ ] Created/populated the index file with links to AI guides, including the new guide 29.
- [ ] **`Docs/Docs_1_AI_GUIDES/21-SCHEDULED_TASKS_APSCHEDULER_PATTERN.md`**:
  - [ ] Added a `CRITICAL NOTE` linking to guide 28 for correct settings import.
- [ ] **`Docs/Docs_1_AI_GUIDES/24-SHARED_SCHEDULER_INTEGRATION_GUIDE.md`**:
  - [ ] Added a `CRITICAL NOTE` linking to guide 28 for correct settings import.
- [ ] **`Docs/Docs_1_AI_GUIDES/28-SCHEDULER_AND_SETTINGS_PATTERNS.md`**:
  - [ ] Added a `See Also` section linking to guides 21, 24, and the supplemental work order doc.
- [ ] **`Docs/Docs_1_AI_GUIDES/29-DATABASE_ENUM_ISOLATION.md`**:
  - [ ] New file created explaining the enum isolation pattern and the case study.
- [ ] **`Docs/Docs_5_Project_Working_Docs/43-Sitemap-Parser/43.6-WO-Progress.md`**:
  - [ ] Multiple updates documenting the debugging of the settings `AttributeError`, the direct service testing, the `UnmappedClassError` fix, the `AttributeError` fix, the scheduler verification, the enum conflict discovery, and the final resolution with enum isolation. Added Conclusions and Finishing Steps sections.
- [ ] **`src/models/page.py`**:
  - [ ] Added `sitemap_file_id` ForeignKey column.
  - [ ] Corrected type hints for `tenant_id` and `domain_id` (removed `Optional` as they are `nullable=False`).
  - [ ] (Attempted further type hint corrections based on `nullable` status).
- [ ] **`src/models/place.py`**:
  - [ ] Defined new `GcpApiDeepScanStatusEnum`.
  - [ ] Updated `deep_scan_status` column definition to use `GcpApiDeepScanStatusEnum` and map to the `gcp_api_deep_scan_status_enum` DB type.
- [ ] **`src/models/sitemap.py`**:
  - [ ] Renamed `SitemapDeepCurationStatusEnum` -> `SitemapImportCurationStatusEnum`.
  - [ ] Renamed `SitemapDeepProcessStatusEnum` -> `SitemapImportProcessStatusEnum` (corrected values to match DB).
  - [ ] Updated `deep_scrape_curation_status` column definition to use `SitemapImportCurationStatusEnum` (DB name mapping kept).
  - [ ] Renamed `deep_scrape_error` column attribute to `sitemap_import_error`.
  - [ ] Renamed `deep_scrape_process_status` column attribute to `sitemap_import_status` and updated mapping to use `SitemapImportProcessStatusEnum` and the `sitemap_import_status_enum` DB type.
  - [ ] Updated comments.
- [ ] **`src/routers/dev_tools.py`**:
  - [ ] Added new endpoint `trigger_sitemap_import_endpoint` for manual testing.
- [ ] **`src/routers/places_staging.py`**:
  - [ ] Replaced import and usage of `DeepScanStatusEnum` with `GcpApiDeepScanStatusEnum`.
- [ ] **`src/routers/sitemap_files.py`**:
  - [ ] Replaced import and usage of `SitemapDeepCurationStatusEnum` with `SitemapImportCurationStatusEnum`.
- [ ] **`src/schemas/sitemap_file.py`**:
  - [ ] Replaced import and usage of `SitemapDeepCurationStatusEnum` with `SitemapImportCurationStatusEnum` in various schemas (`SitemapFileUpdate`, `SitemapFileRead`, `SitemapFileBatchUpdate`).
- [ ] **`src/services/sitemap_files_service.py`**:
  - [ ] Replaced import and usage of `SitemapDeepCurationStatusEnum` and `SitemapDeepProcessStatusEnum` with `SitemapImportCurationStatusEnum` and `SitemapImportProcessStatusEnum`.
  - [ ] Refactored `update_curation_status_batch` logic slightly for clarity and to use the new enums/attributes correctly.
- [ ] **`src/services/sitemap_import_scheduler.py`**:
  - [ ] Renamed file from `sitemap_deep_scrape_scheduler.py`.
  - [ ] Corrected `settings` import (`from ..config.settings import settings`).
  - [ ] Replaced `SitemapDeepScrapeStatusEnum` with `SitemapImportProcessStatusEnum`.
  - [ ] Replaced `SitemapDeepScrapeService` with `SitemapImportService`.
  - [ ] Updated job function name, job ID, job name, config settings names, status/error field names to use `sitemap_import_*` naming.
  - [ ] Removed temporary debug logging related to settings.
- [ ] **`src/services/sitemap_import_service.py`**:
  - [ ] Renamed file from `sitemap_deep_scrape_service.py`.
  - [ ] Major refactoring:
    - [ ] Removed old XML parsing logic.
    - [ ] Added dependency on `SitemapParser`.
    - [ ] Updated logic to fetch sitemap via HTTP using `httpx`.
    - [ ] Added logic to create `Page` objects based on parsed `SitemapURL`s, including setting `domain_id`, `tenant_id`, `sitemap_file_id`, `last_modified`, `lead_source`.
    - [ ] Reinstated status check (`if sitemap_file.sitemap_import_status != ...`).
    - [ ] Removed temporary debug logging.
    - [ ] Corrected usage of `sitemap_file.url` (was `sitemap_file.sitemap_url`).
- [ ] **`src/services/sitemap_scheduler.py`**:
  - [ ] Replaced import and usage of `DeepScanStatusEnum` with `GcpApiDeepScanStatusEnum`.
  - [ ] Adjusted logic slightly in the deep scan processing loop based on previous debugging/refactoring.
- [x] **`src/config/settings.py`**:
  - [x] Added `SITEMAP_IMPORT_SCHEDULER_*` settings.
- [ ] **`src/main.py`**:
  - [ ] Imported and called `setup_sitemap_import_scheduler`.
- [x] **`requirements.txt`**:
  - [x] No content changes vs index, only metadata difference.
- [x] **`src/common/curation_sdk/router_base.py`**:
  - [x] Added placeholder file.
- [x] **`src/common/curation_sdk/scheduler_loop.py`**:
  - [x] Added generic scheduler loop helper function (Used by `sitemap_import_scheduler`).
- [ ] **`src/common/curation_sdk/status_queue_helper.py`**:
  - [ ] Added helper for status updates (Part of SDK, not yet used).
- [x] **Renamed/Archived Files (`RD`)**:
  - [x] `src/services/core/db_service.py` -> `Archive_05.01.25/db_service.py`
  - [x] `src/services/storage/storage_service.py` -> `Archive_05.01.25/storage_service.py`
- [ ] **Deleted Files (`D`)**:
  - [x] `Docs/Docs_5_Project_Working_Docs/project-docs/...` (Numerous - confirmed intentional cleanup)
  - [x] `_Archive_4.13.25/...` (Confirmed intentional cleanup)
  - [x] `domains for exclusion list va dax.csv` (Confirmed intentional cleanup)
- [ ] **Untracked Files (`??`) Handled:**
  - [x] `Docs/Docs_1_AI_GUIDES/00-Developer-Guides.md` (Added)
  - [x] `Docs/Docs_5_Project_Working_Docs/...` (Directories Staged via `git add Docs/Docs_5_Project_Working_Docs/`)
  - [ ] `Z-Curation-Workflow-Process-Build/` (Added to .gitignore)
  - [x] `src/common/__init__.py` (Added)
  - [x] `src/common/sitemap_parser.py` (Added - Essential for refactor)
  - [x] `src/models/sitemap_file.py` (Added - Essential for refactor)
  - [x] `src/services/sitemap/sitemap_service.py` (Added - Placeholder)
