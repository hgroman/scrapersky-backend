# Guiding Architectural Principles for Page Curation Workflow

Based on analysis of existing workflows (WF2-WF5) and **the definitive guide** `Docs/Docs_1_AI_GUIDES/17-CORE_ARCHITECTURAL_PRINCIPLES.md`, the following principles **must** guide the implementation of the `pages` table CRUD endpoints:

1.  **API Standardization:**

    - All API endpoints must use the `/api/v3/` prefix.
    - Use standardized response formats and FastAPI's built-in error handling.
    - (Ref: `Docs_1_AI_GUIDES/15-API_STANDARDIZATION_GUIDE.md`, `17-CORE_ARCHITECTURAL_PRINCIPLES.md`)

2.  **Connection Management:**

    - **Always** use Supavisor connection pooling with **mandatory** parameters: `raw_sql=true`, `no_prepare=true`, `statement_cache_size=0`.
    - PgBouncer is **strictly prohibited**.
    - (Ref: `07-DATABASE_CONNECTION_STANDARDS.md`, `17-CORE_ARCHITECTURAL_PRINCIPLES.md`)

3.  **ORM Requirement:**

    - **No raw SQL** in application code. All database interaction must use SQLAlchemy ORM.
    - (Ref: `Docs_1_AI_GUIDES/01-ABSOLUTE_ORM_REQUIREMENT.md`, `17-CORE_ARCHITECTURAL_PRINCIPLES.md`)

4.  **Transaction Boundaries:**

    - API Routers **own** transaction boundaries for synchronous operations (e.g., batch status updates), typically using `async with session.begin():`.
    - Services called by routers are transaction-aware (use the session) but do not commit/rollback.
    - Background tasks manage their own sessions and transactions.
    - (Ref: `Docs_1_AI_GUIDES/07-TRANSACTION_PATTERNS_REFERENCE.md`, `17-CORE_ARCHITECTURAL_PRINCIPLES.md`, `13-TRANSACTION_MANAGEMENT_GUIDE.md`)

5.  **Authentication Boundary:**

    - JWT authentication happens **only** at the API router level via `get_current_user`.
    - Pass user ID (not token) to services. RBAC and Tenant Isolation features are **removed**.
    - (Ref: `Docs_1_AI_GUIDES/11-AUTHENTICATION_BOUNDARY.md`, `17-CORE_ARCHITECTURAL_PRINCIPLES.md`, `09-TENANT_ISOLATION_REMOVED.md`)

6.  **Dual-Status Update Pattern / Curation-Driven Background Processing:**

    - UI curation actions triggering background work (e.g., setting status to `Selected`) should atomically update both a primary curation status and a secondary processing status (to `Queued`) within a single router transaction.
    - (Ref: `Docs/Docs_5_Project_Working_Docs/10-architectural-patterns/02-CURATION-DRIVEN-BACKGROUND-PROCESSING-PATTERN.md`, `17-CORE_ARCHITECTURAL_PRINCIPLES.md`)

7.  **Decoupled Background Processing:**

    - Background tasks triggered by status changes (`Queued`) must be picked up by dedicated, scheduled jobs (e.g., APScheduler) using their own sessions/transactions.
    - (Ref: `Docs/Docs_5_Project_Working_Docs/10-architectural-patterns/01-SCHEDULED-TASKS-APSCHEDULER-PATTERN.md`, `17-CORE_ARCHITECTURAL_PRINCIPLES.md`)

8.  **UUID Standardization:**

    - All primary/foreign key IDs must be standard UUIDs (PostgreSQL `UUID` type, SQLAlchemy `PGUUID`).
    - (Ref: `16-UUID_STANDARDIZATION_GUIDE.md`, `17-CORE_ARCHITECTURAL_PRINCIPLES.md`)

9.  **Enum Usage:**

    - Use Python Enums for status fields. Reuse existing Enums where appropriate.
    - Ensure clear mapping or direct usage between database Enums and API/Pydantic model Enums.
    - (Ref: `27-ENUM_HANDLING_STANDARDS.md`, `29-DATABASE_ENUM_ISOLATION.md`)

10. **Code Organization:**

    - Routers should be thin, handling auth, request/response validation, transaction boundaries, and delegation.
    - Business logic belongs in service layers.
    - Models must accurately reflect the database schema.
    - (Ref: `17-CORE_ARCHITECTURAL_PRINCIPLES.md`)

11. **Error Handling:**
    - Use FastAPI's built-in `HTTPException`.
    - Log errors with context (job IDs, relevant data IDs, etc.).
    - Use `raise ... from err` in except blocks.
    - (Ref: `17-CORE_ARCHITECTURAL_PRINCIPLES.md`)

**Exemplars:** Refer to `Google Maps API`, `Modernized Sitemap`, `Batch Page Scraper` modules for gold-standard examples. (`17-CORE_ARCHITECTURAL_PRINCIPLES.md`)
