# 15.1 Work Order: Synchronize Alembic Migrations with Current Models

**Related Feature:** 14 - Google Deep Scrape

**Context:**
During the implementation and testing of the Google Deep Scrape feature (Phase 1, specifically Task 1.2 in `14.2-DEEP_SCRAPE_IMPLEMENTATION_PROGRESS.md`), a schema mismatch was identified between the `src/models/local_business.py` SQLAlchemy model and the `public.local_businesses` database table.

**Problem:**
The `LocalBusiness` model defines a `place_id` column (intended to store the Google Place ID, be unique, and indexed), but this column was found to be missing from the actual `local_businesses` table in the database. This prevented the `PlacesDeepService` from correctly performing upserts based on the `place_id`.

**Manual Fix Applied (2023-04-02):**
To unblock testing of the deep scrape functionality, the `place_id` column, its unique constraint, and index were added manually to the `local_businesses` table using a direct SQL script executed via Supabase.

**Required Action:**
Synchronize the Alembic migration history with the current state of the SQLAlchemy models to ensure accurate schema versioning and prevent future inconsistencies.

**Steps:**

1.  **Generate Revision:** Run `alembic revision --autogenerate -m "Sync models, including adding place_id to local_businesses"` from the project root.
2.  **Review Generated Script:** **CRITICAL STEP:** Carefully review the Python script generated by Alembic in the `migrations/versions/` directory.
    - Verify that it correctly detects the need to add the `place_id` column, unique constraint, and index to `local_businesses` (even though they now exist manually, Alembic should ideally detect the model definition).
    - Check thoroughly for any **unexpected** or **unintended** changes to other tables or columns. Autogenerate can sometimes detect drift elsewhere or misinterpret model changes.
3.  **Apply Migration (Conditional):**
    - **If** the generated script _only_ contains the expected changes related to `local_businesses.place_id` (or is empty because the manual fix perfectly matches what Alembic expected), **and** no other unexpected changes are present, then run `alembic upgrade head` to apply the migration (or stamp the current head if the script is empty: `alembic stamp head`).
    - **If** the generated script contains unexpected changes, **DO NOT** run `alembic upgrade head`. Further investigation is needed to understand the discrepancies and potentially adjust models or manually edit the migration script before applying. Resolve these other discrepancies before proceeding.

**Goal:**
Ensure the database schema managed and versioned by Alembic accurately reflects the SQLAlchemy models defined in `src/models`, particularly incorporating the `place_id` addition to `LocalBusiness`. This maintains schema integrity and facilitates future migrations.

**Priority/Timing:** Medium. Deferred to allow continued progress on Deep Scrape Phase 2. Address after completing critical Deep Scrape implementation phases or during the next scheduled maintenance/refactoring window.
