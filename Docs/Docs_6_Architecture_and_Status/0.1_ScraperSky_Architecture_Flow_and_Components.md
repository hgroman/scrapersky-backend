Okay, let's connect the pieces from the UI Tab to the background processing it might trigger.

This document outlines the high-level architecture, components, and primary data enrichment flow of the ScraperSky backend.

**Core Data Enrichment Workflow:**

The system is designed around a progressive data enrichment pipeline, primarily managed through the UI tabs in `scraper-sky-mvp.html`. The typical flow is as follows:

1.  **Discovery (Single Search / Batch Search Tabs):** Initial business listings are discovered using keywords and locations via Google Maps API calls.
2.  **Triage (Staging Editor Tab):** Raw search results are reviewed, filtered, and assigned an initial status (New, Selected, Maybe, Not a Fit, Archived).
3.  **Business Curation (Local Business Curation Tab):** Businesses marked as relevant undergo further review. Website URLs are validated, and statuses are refined. This stage often triggers domain extraction/association.
4.  **Domain Curation (Domain Curation Tab):** The focus shifts to the associated website domain. Users decide if the domain warrants deeper analysis (e.g., sitemap scraping) by setting its `sitemap_curation_status`. Setting status to 'Selected' here typically queues the domain for sitemap analysis.
5.  **Sitemap Curation (Sitemap Curation Tab):** Discovered sitemaps for selected domains can be reviewed. Users might select specific sitemaps or manage the processing queue for deep content scraping.
6.  **Results Viewing (Results Viewer Tab):** Displays the consolidated results and enriched data gathered throughout the pipeline (contacts, metadata, etc.).

**Note on Naming Conventions:** Please be aware that there are known inconsistencies in the naming of certain backend components (routers, services, task files, etc.) compared to the conceptual service names or UI elements. A future refactoring effort is planned to align these names for improved clarity, maintainability, and documentation consistency. Until then, refer to this table and the code itself to map functionality accurately.

**Terminology Quick Reference:**

- **Discovery:** Refers to the initial finding of businesses via the "Single Search" and "Batch Search" UI tabs.
- **Curation:** Encompasses the review and status refinement process across the "Staging Editor", "Local Business Curation", "Domain Curation", and "Sitemap Curation" tabs.
- **Shared Resources:** Common components like `domains` table, `jobs` table, `metadata_extractor.py` service, and `domain-curation-tab.js` are used across multiple services.

Here's the chart mapping the conceptual Service Name (often seen in the sidebar/screenshots) to its goal, the UI element(s) used for interaction (typically tabs within `/static` files), and the backend components involved in processing.

| Service Name         | FE Needed? | Trigger Type | Impact / Significance                                                                  | Conceptual Goal                                     | Primary UI Element(s) (Static File/Tab)                                                                                                                                        | UI JS File(s)                           | Backend Router(s)                                                                                                                                                                                                                                                             | Primary DB Table(s)                                       | Background Job(s) / Trigger Mechanism                                                                                                                                                                                                                                                                                                                     |
| :------------------- | :--------: | :----------: | :------------------------------------------------------------------------------------- | :-------------------------------------------------- | :----------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :-------------------------------------- | :---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :-------------------------------------------------------- | :-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **LocalMiner**       |     ✔️     |   ✔️ / ⏳    | Foundation; quality of discovery/curation drives pipeline.                             | Find & process local business data from Google Maps | [`scraper-sky-mvp.html`](static/scraper-sky-mvp.html) (`Single Search`, `Staging Editor`, `Local Business Curation`, `Domain Curation`, `Batch Search`, `Results Viewer` tabs) | `*-tab.js†`                             | [`places_staging.py`](src/routers/places_staging.py)<br>[`local_businesses.py`](src/routers/local_businesses.py)<br>[`domains.py`](src/routers/domains.py)<br>[`batch_page_scraper.py`](src/routers/batch_page_scraper.py)<br>(Discovery via `google_maps_api.py` or similar) | jobs, batch_jobs, places_staging, local_business, domains | ✔️ Direct Action (Search/Batch); ⏳ Status Changes (e.g., Curation 'Selected' sets analysis status to 'Queued'[^‡]) → [`domain_scheduler.py`](src/services/domain_scheduler.py)[^B], [`sitemap_scheduler.py`](src/services/sitemap_scheduler.py)[^B], [`domain_sitemap_submission_scheduler.py`](src/services/domain_sitemap_submission_scheduler.py)[^B] |
| **ContentMap**       |     ⚙️     |      ⏳      | Determines website sections analyzed; impacts content depth.                           | Analyze website sitemaps for structure & content    | [`scraper-sky-mvp.html`](static/scraper-sky-mvp.html) (`Sitemap Curation` tab), Potentially `contentmap.html` (Needs verification)†                                            | `sitemap-curation-tab.js`               | [`sitemap_files.py`](src/routers/sitemap_files.py) (for file management)<br>[`sitemap_files.py`](src/routers/sitemap_files.py) (scan/status via its service?)                                                                                                                 | `sitemap_files`, `sitemap_urls`                           | ⏳ Status Change (Sitemap Curation 'Selected' sets analysis status to 'Queued'[^‡]) → [`sitemap_scheduler.py`](src/services/sitemap_scheduler.py)[^B]                                                                                                                                                                                                     |
| **FrontendScout**    |     ⚙️     |      †       | Provides tech insights for competitive analysis.†                                      | (Likely) Analyze frontend technologies              | Screenshot exists; No specific UI tab/file identified (Likely needs adding to [`scraper-sky-mvp.html`](static/scraper-sky-mvp.html)).†                                         | `†`                                     | `†`                                                                                                                                                                                                                                                                           | `†`                                                       | †                                                                                                                                                                                                                                                                                                                                                         |
| **SiteHarvest**      |     —      |      ⏳      | Extracts core website data; failure means data gaps.                                   | Extract metadata & content from websites            | Screenshot exists; No dedicated UI tab/file identified. Functionality integrated into `Domain` processing.                                                                     | `domain-curation-tab.js`                | [`metadata_extractor.py`](src/scraper/metadata_extractor.py) (Service)<br>[`domains.py`](src/routers/domains.py)                                                                                                                                                              | `pages`                                                   | ⏳ Triggered by Domain/Sitemap processing → [`domain_scheduler.py`](src/services/domain_scheduler.py)[^B] / [`sitemap_scheduler.py`](src/services/sitemap_scheduler.py)[^B]                                                                                                                                                                               |
| **SocialRadar**      |     —      |      ⏳      | Captures basic social fields during domain extraction; no dedicated enrichment/UI yet. | Find & analyze social media profiles                | No dedicated UI (Likely needs adding to [`scraper-sky-mvp.html`](static/scraper-sky-mvp.html)). Data fields captured during Domain processing.†                                | `†`                                     | [`metadata_extractor.py`](src/scraper/metadata_extractor.py) (Service)<br>[`domains.py`](src/routers/domains.py)                                                                                                                                                              | `domains`                                                 | ⏳ Data captured during Domain Processing → [`domain_scheduler.py`](src/services/domain_scheduler.py)[^B]                                                                                                                                                                                                                                                 |
| **ContactLaunchpad** |     ⚙️     |      ⏳      | Core value (contacts); needs UI for management.†                                       | Manage & enrich contact data                        | Screenshot shows 'Contact Staging'; No dedicated UI tab/file identified. 'Launchpad' likely needs UI in [`scraper-sky-mvp.html`](static/scraper-sky-mvp.html).†                | `†` (Email scraping is background only) | [`email_scanner.py`](src/routers/email_scanner.py) (for scan initiation/status)<br>`†` (Launchpad API)                                                                                                                                                                        | `contacts`, `jobs`                                        | ✔️ Direct Action (API Call) → Background Task ([`email_scraper.py`](src/tasks/email_scraper.py))                                                                                                                                                                                                                                                          |
| **Domain Scanner**   |     ⚙️     |      ⏳      | Assesses domain health/tech for processing strategy.†                                  | Scan domains for tech stacks & contacts             | Screenshot exists; Possibly integrated/separate view needed in [`scraper-sky-mvp.html`](static/scraper-sky-mvp.html).†                                                         | `domain-curation-tab.js or †`           | [`domains.py`](src/routers/domains.py)                                                                                                                                                                                                                                        | `†`                                                       | ⏳ Status Change (Domain Status) → [`domain_scheduler.py`](src/services/domain_scheduler.py)[^B]                                                                                                                                                                                                                                                          |
| **Domains View**     |     ⚙️     |              | Central management view; impacts curation efficiency.†                                 | View & manage domain data                           | Screenshot exists; Possibly integrated/separate view needed in [`scraper-sky-mvp.html`](static/scraper-sky-mvp.html).†                                                         | `domain-curation-tab.js or †`           | [`domains.py`](src/routers/domains.py)                                                                                                                                                                                                                                        | `†`                                                       | ✔️ View Only                                                                                                                                                                                                                                                                                                                                              |

**Sample Flow Snippet (Single Search Discovery):**

```mermaid
flowchart LR
    A[User clicks 'Search' in UI] --> B{POST /api/v3/localminer-discoveryscan};
    B --> C[Service: Calls Google Maps API];
    C --> D[Service: Creates Job record (status: processing)];
    D --> E[Service: Inserts results into places_staging table];
    E --> F[Service: Updates Job record (status: completed)];
    F --> G{API Response: Returns Job ID};
    G --> H[UI: Displays status/link to results];
```

**Open Questions:**

- Does Business Curation status change (e.g., to 'Selected') automatically trigger domain data extraction via `domain_scheduler.py`, or is there an explicit action?
- Which specific database table(s) store the metadata and status for Batch Search jobs (distinct from single search jobs)?
- What is the intended mechanism for triggering `FrontendScout` and `SocialRadar` analyses if they are integrated into domain processing? (Via `domain_scheduler` based on a specific domain status?)
- Define ContactLaunchpad UI & endpoint; decide if enrichment writes to `contacts` or a new table.

---

† See Appendix A for placeholder definitions and file lists.

## Appendix A: Notes & Placeholders

- **Placeholder (`†`):** Indicates features or components requiring further definition or future implementation. Data fields may exist (e.g., on `domains` for SocialRadar), but dedicated UI, services, tables, or endpoints are not yet built.
- **Shared JS File List (`*-tab.js†`):** Refers to the following files used by the `LocalMiner` service tabs: `single-search-tab.js`, `staging-editor-tab.js`, `local-business-curation-tab.js`, `domain-curation-tab.js`, `batch-search-tab.js`, `results-viewer-tab.js`.
- **Dual-Status Update (`[^‡]`):** When a user marks an item as 'Selected' in Business Curation or Domain Curation via the API, the system typically updates both the `*_curation_status` field to `Selected` _and_ the corresponding `*_analysis_status` field (e.g., `domain_extraction_status`, `sitemap_analysis_status`) to `Queued` within the same transaction. The background scheduler then polls for the `Queued` status.

## Appendix B: Scheduler Integration Notes

1.  **Lifecycle Hooks**

    - Scheduler starts on FastAPI `@app.on_event("startup")` and shuts down on `@app.on_event("shutdown")`.

2.  **Polling Intervals**

    - Jobs run on fixed intervals (e.g. `process_pending_domains` every 5 min, `process_pending_jobs` every 1 min).
    - Configurable via environment vars (`DOMAIN_SCHEDULER_INTERVAL_MINUTES`, etc.).

3.  **Isolated Session Pattern**

    - Every DB call uses `get_background_session()` within its own `async with` block.
    - Always include `.execution_options(prepared=False)` for Supavisor compatibility.

4.  **Diagnostic Endpoints**

    - `/api/v3/dev/process-pending-domains` (and similar) let you manually fire and inspect jobs.

5.  **Error Handling**
    - Each item gets its status atomically updated to `processing`, then `completed` or `failed` with error details.
    - Prevents "stuck" records and surfaces failures in logs or via a status field.

[^B]: See Appendix B for APScheduler integration patterns (startup/shutdown, intervals, sessions, diagnostics, error-handling).
