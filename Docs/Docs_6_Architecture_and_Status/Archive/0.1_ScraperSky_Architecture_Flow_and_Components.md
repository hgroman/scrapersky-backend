# ScraperSky Architecture Flow and Components (Enhanced)

This document outlines the high-level architecture, components, and primary data enrichment flow of the ScraperSky backend.

## 1. Core Data Enrichment Workflow

The system is designed around a progressive data enrichment pipeline, primarily managed through the UI tabs in `scraper-sky-mvp.html`. The typical flow is as follows:

1.  **Discovery (Single Search / Batch Search Tabs):** Initial business listings are discovered using keywords and locations via Google Maps API calls.
2.  **Triage (Staging Editor Tab):** Raw search results are reviewed, filtered, and assigned an initial status (New, Selected, Maybe, Not a Fit, Archived).
3.  **Business Curation (Local Business Curation Tab):** Businesses marked as relevant undergo further review. Website URLs are validated, and statuses are refined. This stage often triggers domain extraction/association.
4.  **Domain Curation (Domain Curation Tab):** The focus shifts to the associated website domain. Users decide if the domain warrants deeper analysis (e.g., sitemap scraping) by setting its `sitemap_curation_status`. Setting status to 'Selected' here typically queues the domain for sitemap analysis.
5.  **Sitemap Curation (Sitemap Curation Tab):** Discovered sitemaps for selected domains can be reviewed. Users might select specific sitemaps or manage the processing queue for deep content scraping.
6.  **Results Viewing (Results Viewer Tab):** Displays the consolidated results and enriched data gathered throughout the pipeline (contacts, metadata, etc.).

## 2. Standard Producer-Consumer Workflow Pattern

All ScraperSky workflows follow a standardized **Producer-Consumer pattern** that connects UI interactions to background processing:

### 2.1 Pattern Overview

```
[UI Action] → [API Endpoint] → [Dual-Status Update] → [Background Scheduler] → [Processing Service] → [Status Update]
```

1. **Producer Side (User-Triggered):**
   - User selects records in the UI and changes their curation status (usually to "Queued" or "Selected")
   - UI makes an API call to a batch status update endpoint
   - The API endpoint updates both:
     - `{workflow_name}_curation_status` (user-selected value)
     - `{workflow_name}_processing_status` ("Queued")
   - All changes occur within a single transaction

2. **Consumer Side (Background Processing):**
   - Scheduler polls for records with `{workflow_name}_processing_status = "Queued"`
   - For each record, the scheduler:
     - Updates status to "Processing"
     - Calls the dedicated processing service
     - The service performs the workflow-specific logic
     - Upon completion, status is updated to "Complete" (or "Error")

### 2.2 Key Status Flow

```
[User Selection] → Curation Status = "Queued" → Processing Status = "Queued" → Processing Status = "Processing" → Processing Status = "Complete"
```

## 3. Technical Stack and Component Architecture

The ScraperSky backend is built on a modern Python-based stack with these key components:

### 3.1 Core Technologies

- **FastAPI:** Provides the web framework and API routing with async capabilities
- **SQLAlchemy:** ORM for database interactions (primarily PostgreSQL via Supabase)
- **APScheduler:** Handles background task scheduling and execution
- **Pydantic:** Manages data validation and schema definitions

### 3.2 Component Organization

- **Models (`src/models/`):** SQLAlchemy models representing database tables
- **Schemas (`src/schemas/`):** Pydantic models for API request/response validation
- **Routers (`src/routers/`):** FastAPI endpoints organized by workflow or entity
- **Services (`src/services/`):** Business logic implementation
  - `*_service.py`: Core processing logic
  - `*_scheduler.py`: Background tasks that poll for queued items
- **UI Components (`static/`):**
  - `scraper-sky-mvp.html`: Main SPA interface
  - `js/*.js`: Tab-specific JavaScript implementations

### 3.3 Transaction Management

- **Transaction Boundaries:**
  - **Router Functions:** Own transaction boundaries via `async with session.begin()`
  - **Service Functions:** Do NOT start their own transactions
  - **Schedulers:** May start transactions but typically delegate to services

- **ORM Exclusivity:**
  - All database interactions MUST use SQLAlchemy ORM
  - No raw SQL (except for manual schema migrations)
  - No mixing of ORM and Core operations

## 4. Standardized Naming Conventions

ScraperSky follows strict naming conventions derived from the workflow name. For a workflow named `page_curation`:

### 4.1 Database Components

- **Status Fields:** `page_curation_curation_status`, `page_curation_processing_status`
- **Error Field:** `page_curation_processing_error`
- **Enum Types:** `pagecurationcurationstatus`, `pagecurationprocessingstatus`

### 4.2 Python Components

- **Enum Classes:** `PageCurationCurationStatus`, `PageCurationProcessingStatus`
- **Service Files:** `page_curation_service.py`, `page_curation_scheduler.py`
- **Router File:** `page_curation.py`
- **Schema File:** `page_curation.py` (in schemas directory)

### 4.3 JavaScript and UI

- **JS File:** `page-curation-tab.js`
- **Tab Panel ID:** `pageCurationPanel`
- **Table ID:** `pageCurationTable`

For comprehensive details on naming conventions, refer to the [CONVENTIONS_AND_PATTERNS_GUIDE.md](/Docs/Docs_6_Architecture_and_Status/CONVENTIONS_AND_PATTERNS_GUIDE.md).

## 5. Workflow Sequence Diagram

```
┌─────────┐          ┌──────────┐          ┌──────────┐          ┌───────────┐          ┌────────────┐
│   UI    │          │  Router  │          │ Database │          │ Scheduler │          │  Service   │
└────┬────┘          └────┬─────┘          └────┬─────┘          └─────┬─────┘          └─────┬──────┘
     │                     │                     │                      │                      │
     │ User selects items  │                     │                      │                      │
     │ & sets status       │                     │                      │                      │
     │─────────────────────>                     │                      │                      │
     │                     │                     │                      │                      │
     │                     │ BEGIN TRANSACTION   │                      │                      │
     │                     │────────────────────>│                      │                      │
     │                     │                     │                      │                      │
     │                     │ Update curation_status                     │                      │
     │                     │ & processing_status = "Queued"             │                      │
     │                     │────────────────────>│                      │                      │
     │                     │                     │                      │                      │
     │                     │ COMMIT TRANSACTION  │                      │                      │
     │                     │────────────────────>│                      │                      │
     │                     │                     │                      │                      │
     │ API Response        │                     │                      │                      │
     │<─────────────────────                     │                      │                      │
     │                     │                     │                      │                      │
     │                     │                     │                      │ Poll for status="Queued"
     │                     │                     │<─────────────────────│                      │
     │                     │                     │                      │                      │
     │                     │                     │ Return queued items  │                      │
     │                     │                     │─────────────────────>│                      │
     │                     │                     │                      │                      │
     │                     │                     │ Update to "Processing"│                      │
     │                     │                     │<─────────────────────│                      │
     │                     │                     │                      │                      │
     │                     │                     │                      │ Process item         │
     │                     │                     │                      │─────────────────────>│
     │                     │                     │                      │                      │
     │                     │                     │                      │                      │ Do workflow
     │                     │                     │                      │                      │ specific work
     │                     │                     │                      │                      │
     │                     │                     │                      │ Result               │
     │                     │                     │                      │<─────────────────────│
     │                     │                     │                      │                      │
     │                     │                     │ Update to "Complete" │                      │
     │                     │                     │<─────────────────────│                      │
     │                     │                     │                      │                      │
┌────┴────┐          ┌────┴─────┐          ┌────┴─────┐          ┌─────┴─────┐          ┌─────┴──────┐
│   UI    │          │  Router  │          │ Database │          │ Scheduler │          │  Service   │
└─────────┘          └──────────┘          └──────────┘          └───────────┘          └────────────┘
```

## 6. System Component Table

The following table provides a standardized view of all 5 complete workflows in the ScraperSky system, mapping UI elements to their corresponding backend components and identifying potential areas for standardization.

| Workflow ID | Service Name | Primary UI Element | Standard Workflow Name | Frontend JS | Backend Router | Service Files | Primary DB Tables | Status Fields | Standardization Notes |
|:------------|:-------------|:-------------------|:----------------------|:------------|:---------------|:--------------|:------------------|:--------------|:----------------------|
| **WF1** | **BusinessSearch** | Single Search Tab | `business_search` | `single-search-tab.js` | `places_search.py` | `places_search_service.py` | `jobs`, `places_staging` | Uses direct API calls rather than status fields | **Technical Debt**: Not using the producer-consumer pattern; no dedicated curation/processing status fields |
| **WF2** | **StagingEditor** | Staging Editor Tab | `staging_curation` | `staging-editor-tab.js` | `places_staging.py` | `places_staging_service.py` | `places_staging` | `staging_curation_status` | **Technical Debt**: Non-standard status field naming; missing processing_status field |
| **WF3** | **BusinessCuration** | Local Business Curation Tab | `business_curation` | `local-business-curation-tab.js` | `local_businesses.py` | `local_business_service.py`, `local_business_scheduler.py` | `local_business` | `business_curation_status`, `business_processing_status` | **Technical Debt**: Simplified field names that don't follow the {workflow_name}_curation_status pattern |
| **WF4** | **DomainCuration** | Domain Curation Tab | `domain_curation` | `domain-curation-tab.js` | `domains.py` | `domain_service.py`, `domain_scheduler.py` | `domains` | `domain_curation_status`, `domain_processing_status` | Closest to the standardized pattern, but still using simplified field names |
| **WF5** | **SitemapCuration** | Sitemap Curation Tab | `sitemap_curation` | `sitemap-curation-tab.js` | `sitemap_files.py` | `sitemap_import_service.py`, `sitemap_import_scheduler.py` | `sitemap_files`, `sitemap_urls` | `sitemap_import_status` | **Technical Debt**: Significant deviation from standards with non-standard status field name |
| **WF6** | **SitemapImport** | *No dedicated UI tab* | `sitemap_import` | *N/A* | `sitemap_files.py` | `sitemap_import_service.py`, `sitemap_import_scheduler.py` | `sitemap_files` | `sitemap_import_status` | **Technical Debt**: Background-only workflow without clear UI entry point |
| **NEW** | **PageCuration** | *Future UI tab* | `page_curation` | `page-curation-tab.js` (planned) | `page_curation.py` | `page_curation_service.py`, `page_curation_scheduler.py` | `pages` | `page_curation_status`, `page_processing_status` | **Standard Implementation**: Follows all current naming conventions |

### Key Technical Debt Areas Identified:

1. **Inconsistent Status Field Naming:**
   - Should follow `{workflow_name}_curation_status`, `{workflow_name}_processing_status`
   - Current implementations use shortened versions or different patterns

2. **Missing Producer-Consumer Pattern:**
   - Some workflows (WF1, WF2) don't use the dual-status update mechanism
   - Not all workflows have corresponding background processing components

3. **Inconsistent Router and Service Naming:**
   - Service files don't consistently match workflow names
   - Routers sometimes match entity names rather than workflow names

4. **Mismatched Workflow/Implementation Names:**
   - Example: `sitemap_curation` workflow uses `sitemap_import_service.py`

## 7. Documentation Reference Hierarchy

ScraperSky maintains a comprehensive documentation system with these key references:

1. **Workflow Builder Cheat Sheet**
   - Step-by-step implementation guide for new workflows
   - Located in project-specific directories (e.g., `/Docs/Docs_5_Project_Working_Docs/`)

2. **CONVENTIONS_AND_PATTERNS_GUIDE.md**
   - Definitive source for all naming conventions and patterns
   - Located at `/Docs/Docs_6_Architecture_and_Status/CONVENTIONS_AND_PATTERNS_GUIDE.md`

3. **Q&A_Key_Insights.md**
   - Consensus answers to common implementation questions
   - Located at `/Docs/Docs_6_Architecture_and_Status/Q&A_Key_Insights.md`

4. **AI_GUIDES Directory**
   - Specific guidance on individual patterns
   - Located at `/Docs/Docs_1_AI_GUIDES/`

## 8. Terminology Quick Reference

- **Discovery:** Refers to the initial finding of businesses via the "Single Search" and "Batch Search" UI tabs.
- **Curation:** Encompasses the review and status refinement process across the "Staging Editor", "Local Business Curation", "Domain Curation", and "Sitemap Curation" tabs.
- **Producer-Consumer Pattern:** The dual-status update mechanism (curation_status + processing_status) connecting UI actions to background processing.
- **Workflow Name:** The snake_case identifier (e.g., `page_curation`) that defines all naming conventions throughout the system.
- **Dual-Status Update:** The pattern where changing a curation status triggers a corresponding change to processing status, queuing the item for background processing.
- **Shared Resources:** Common components like `domains` table, `jobs` table, `metadata_extractor.py` service, and `domain-curation-tab.js` are used across multiple services.
