# ScraperSky Backend Architectural Truth Statement

**Date:** 2025-08-01
**Version:** 2.0 (Consolidated)
**Status:** Active

---

### **Note on this Document's Purpose**

This document serves as the **high-level architectural reference** for the ScraperSky backend. It has been updated as part of a significant documentation consolidation effort.

While this document outlines the core principles and the overall 7-layer model, the **definitive, authoritative, and most current standards** for each architectural layer are now maintained in dedicated **Blueprint** files.

For detailed, actionable guidance on implementation, naming conventions, and compliance criteria, please refer to the specific blueprint for the relevant layer linked in the "Current Implementation by Layer" section below.

---

## Related Documentation

- **[CONVENTIONS_AND_PATTERNS_GUIDE.md](./CONVENTIONS_AND_PATTERNS_GUIDE.md)** - Detailed naming conventions and patterns.
- **Layer-Specific Blueprints:** See links in Section 2 below for the authoritative source of truth for each layer.

## Purpose

This document serves as the primary architectural reference for the ScraperSky backend. As a living document, it:

- Provides a definitive reference for the 7-layer architecture.
- Documents current implementation patterns across all layers at a high level.
- Establishes clear naming conventions and standards.
- Serves as the source of truth for architectural decisions.
- Functions as the foundation for onboarding new developers.
- Guides AI assistants when providing development support.

## 1. 7-Layer Architecture Overview

The ScraperSky backend is organized into 7 distinct architectural layers, each with specific responsibilities and patterns. All components must be classified into exactly one of these layers:

| Layer # | Layer Name | Primary Responsibility | Key Patterns |
|---------|------------|------------------------|---------------|
| Layer 1 | Models & ENUMs | Data structure definition and persistence | SQLAlchemy models, Python Enums |
| Layer 2 | Schemas | Request/response validation and serialization | Pydantic models |
| Layer 3 | Routers | HTTP endpoint definition and transaction boundaries | FastAPI routers |
| Layer 4 | Services & Schedulers | Business logic and background processing | Service functions, APScheduler |
| Layer 5 | Configuration | System configuration and cross-cutting concerns | Settings, middleware |
| Layer 6 | UI Components | User interface elements | HTML, CSS, JavaScript |
| Layer 7 | Testing | Verification of system functionality | Pytest fixtures and tests |

## 2. Current Implementation by Layer

### Layer 1: Models & ENUMs

**Primary Responsibility:** Data structure definition and persistence.

The definitive standards for this layer, including model and ENUM naming, structure, and compliance criteria, are maintained in the blueprint below.

- **Authoritative Document:** **[Layer 1: Models & ENUMs - Architectural Blueprint](./Layer1_Models_Enums/v_Layer-1.1-Models_Enums_Blueprint.md)**

### Layer 2: Schemas

**Primary Responsibility:** Request/response validation and serialization.

The definitive standards for this layer, including Pydantic schema naming, structure, and compliance criteria, are maintained in the blueprint below.

- **Authoritative Document:** **[Layer 2: Schemas - Architectural Blueprint](./Layer2_Schemas/v_Layer-2.1-Schemas_Blueprint.md)**

### Layer 3: Routers

**Primary Responsibility:** HTTP endpoint definition and transaction boundaries.

The definitive standards for this layer, including router and endpoint naming, structure, transaction management, and compliance criteria, are maintained in the blueprint below.

- **Authoritative Document:** **[Layer 3: Routers - Architectural Blueprint](./Layer3_Routers/v_Layer-3.1-Routers_Blueprint.md)**

### Layer 4: Services & Schedulers

**Primary Responsibility:** Business logic and background processing.

The definitive standards for this layer, including service and scheduler naming, structure, session management, and compliance criteria, are maintained in the blueprint below.

- **Authoritative Document:** **[Layer 4: Services & Schedulers - Architectural Blueprint](./Layer4_Services/v_Layer-4.1-Services_Blueprint.md)**

### Layer 5: Configuration

**Primary Responsibility:** System configuration and cross-cutting concerns.

The definitive standards for this layer, including settings management, dependency injection, and application setup, are maintained in the blueprint below.

- **Authoritative Document:** **[Layer 5: Configuration - Architectural Blueprint](./Layer5_Configuration/v_Layer-5.1-Configuration_Blueprint.md)**

### Layer 6: UI Components

**Primary Responsibility:** User interface elements.

The definitive standards for this layer, including HTML, CSS, and JavaScript structure and naming conventions, are maintained in the blueprint below.

- **Authoritative Document:** **[Layer 6: UI Components - Architectural Blueprint](./Layer6_UI_Components/v_Layer-6.1-UI_Components_Blueprint.md)**

### Layer 7: Testing

**Primary Responsibility:** Verification of system functionality.

The definitive standards for this layer, including test structure, fixtures, mocking, and compliance criteria, are maintained in the blueprint below.

- **Authoritative Document:** **[Layer 7: Testing - Architectural Blueprint](./Layer7_Testing/v_Layer-7.1-Testing_Blueprint.md)**

## 3. Cross-Cutting Architectural Principles

### Transaction Management
- **Core principle:** "Routers own transaction boundaries, services are transaction-aware but do not create transactions"
- Routers use `async with session.begin()` to create transaction boundaries.
- Services accept session parameters and never create transactions.
- Background tasks create their own sessions and manage transactions.

### JWT Authentication
- JWT authentication happens ONLY at API gateway endpoints.
- Database operations NEVER handle JWT or tenant authentication.
- No tenant isolation across the system.

### Error Handling
- FastAPI's native error handling used throughout the application.
- Custom ErrorService has been removed.

### Background Processing
- All background tasks use APScheduler.
- Single shared scheduler instance in `src/scheduler_instance.py`.
- Jobs triggered by status changes (usually to "Queued").
- Standard job configuration via environment variables.

## 4. Workflow Implementation Pattern

The standard workflow implementation pattern follows these steps, with details for each step defined in the corresponding layer blueprint:

1.  **Model & Status Definition (Layer 1)**
2.  **Schema Definition (Layer 2)**
3.  **Router Implementation (Layer 3)**
4.  **Service & Scheduler Implementation (Layer 4)**
5.  **UI Implementation (Layer 6)**
6.  **Testing (Layer 7)**

## 5. Maintenance & Governance

This document serves as the high-level architectural reference for the ScraperSky backend. It will be:

- Updated whenever significant architectural changes are made at a high level.
- Referenced as the source of truth for the overall architectural vision.
- Used as a foundation for onboarding new developers, directing them to the layer-specific blueprints for details.
- Used by AI assistants for high-level context before consulting layer-specific blueprints.

All new development must adhere to the patterns and standards documented in the layer-specific blueprints. Deviations require explicit justification and approval. All updates to this document and its child blueprints should be reviewed and approved by the system architect to ensure accuracy and alignment with the project's architectural vision.